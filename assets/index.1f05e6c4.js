var ea=Object.defineProperty,ta=Object.defineProperties;var sa=Object.getOwnPropertyDescriptors;var os=Object.getOwnPropertySymbols;var ur=Object.prototype.hasOwnProperty,mr=Object.prototype.propertyIsEnumerable;var dr=(r,e,t)=>e in r?ea(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,as=(r,e)=>{for(var t in e||(e={}))ur.call(e,t)&&dr(r,t,e[t]);if(os)for(var t of os(e))mr.call(e,t)&&dr(r,t,e[t]);return r},pr=(r,e)=>ta(r,sa(e));var _r=(r,e)=>{var t={};for(var s in r)ur.call(r,s)&&e.indexOf(s)<0&&(t[s]=r[s]);if(r!=null&&os)for(var s of os(r))e.indexOf(s)<0&&mr.call(r,s)&&(t[s]=r[s]);return t};function Ne(...r){const e={};for(const t of r)e[t]=t;return Object.freeze(e)}function gr(r){try{return new URL(r).origin}catch{return new URL(`https://${r}`).origin}}async function ia(r,e){const t={format:"json",timeout:3e4,method:"GET"};try{const s=`${r}/.well-known/matrix/client`;return await e(s,t).response()}catch(s){if(s.name==="ConnectionError")return null;throw s}}async function ra(r,e){var s;r=gr(r);const t=await ia(r,e);if(t&&t.status===200){const{body:i}=t,n=(s=i["m.homeserver"])==null?void 0:s.base_url;typeof n=="string"&&(r=gr(n))}return r}class ye extends Error{get name(){return"AbortError"}}class wi{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}}class It extends wi{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new oa(Promise.resolve(this.get())):new na(this,e)}flatMap(e){return new aa(this,e)}}class na{constructor(e,t){this._promise=new Promise((s,i)=>{this._reject=i,this._subscription=e.subscribe(n=>{t(n)&&(this._reject=null,s(n),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new ye),this._reject=null)}}class oa{constructor(e){this.promise=e}dispose(){}}class we extends It{constructor(e){super(),this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class ri extends we{constructor(e,t){super(e),this._freeCallback=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this._freeCallback()}}class aa extends It{constructor(e,t){super(),this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();if(!e)return;const t=this.mapper(e);return t==null?void 0:t.get()}}class vn{constructor(e){this._abortable=void 0;const t=i=>(this._abortable=i,i);this._progress=new we(void 0);const s=i=>{this._progress.set(i)};this.result=e(t,s)}get progress(){return this._progress}abort(){var e;(e=this._abortable)==null||e.abort(),this._abortable=void 0}}const ca={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},fr="application/octet-stream";class ct{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",ca[t]||(t=fr),new ct(new Blob([e],{type:t}),e)}static fromBlob(e){return new ct(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise((s,i)=>{e.addEventListener("load",n=>s(n.target.result)),e.addEventListener("error",n=>i(n.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||fr}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}function bn(r){return Object.entries(r||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function la(r){if(r instanceof ct){const e=r;return{mimeType:e.mimeType,body:e}}else{if(r instanceof Map)return{mimeType:"multipart/form-data",body:r};if(typeof r=="object"){const e=JSON.stringify(r);return{mimeType:"application/json",body:e}}else throw new Error("Unknown body type: "+r)}}class Sn extends Error{constructor(e,t){super(`${e}: ${t.message}`),this.cause=t}get name(){return"WrappedError"}}class In extends Error{constructor(e,t,s,i){super(`${s?s.error:i} on ${e} ${t}`),this.errcode=s?s.errcode:null,this.retry_after_ms=s?s.retry_after_ms:0,this.statusCode=i}get name(){return"HomeServerError"}}class je extends Error{constructor(e,t){super(e||"ConnectionError"),this.isTimeout=t}get name(){return"ConnectionError"}}class ha{constructor(e,t,s,i){let n;if(i!=null&&i.log){const o=i==null?void 0:i.log;n=o.child({t:"network",url:t,method:e},o.level.Info)}this._log=n,this._sourceRequest=s,this._promise=s.response().then(o=>{var a,c;if(n==null||n.set("status",o.status),o.status>=200&&o.status<300||((a=i==null?void 0:i.allowedStatusCodes)==null?void 0:a.includes(o.status)))return n==null||n.finish(),o.body;if(o.status>=500){const l=new je("Internal Server Error");throw n==null||n.catch(l),l}else if(o.status>=400&&!((c=o.body)!=null&&c.errcode)){const l=new je(`HTTP error status ${o.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw n==null||n.catch(l),l}else{const l=new In(e,t,o.body,o.status);throw n==null||n.set("errcode",l.errcode),n==null||n.catch(l),l}},o=>{if(o.name==="AbortError"&&this._sourceRequest){const a=new je("Service worker aborted, either updating or hit #187.");throw n==null||n.catch(a),a}else throw o.name==="ConnectionError"&&(n==null||n.set("timeout",o.isTimeout)),n==null||n.catch(o),o})}abort(){var e;this._sourceRequest&&((e=this._log)==null||e.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}async responseCode(){return(await this._sourceRequest.response()).status}}const cs="/_matrix/client/r0",da="/_matrix/client/v3",Qs="/_matrix/client/unstable/org.matrix.msc2697.v2";class Xe{constructor({homeserver:e,accessToken:t,request:s,reconnector:i}){this._homeserver=e,this._accessToken=t,this._requestFn=s,this._reconnector=i}_url(e,t=cs){return this._homeserver+t+e}_baseRequest(e,t,s,i,n,o){const a=bn(s);t=`${t}?${a}`;let c;const l=new Map;if(o&&l.set("Authorization",`Bearer ${o}`),l.set("Accept","application/json"),i){const m=la(i);l.set("Content-Type",m.mimeType),c=m.body}const h=this._requestFn(t,{method:e,headers:l,body:c,timeout:n==null?void 0:n.timeout,uploadProgress:n==null?void 0:n.uploadProgress,format:"json",cache:e!=="GET"}),d=new ha(e,t,h,n);return this._reconnector&&d.response().catch(m=>{m.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),d}_unauthedRequest(e,t,s,i,n){return this._baseRequest(e,t,s,i,n)}_authedRequest(e,t,s,i,n){return this._baseRequest(e,t,s,i,n,this._accessToken)}_post(e,t,s,i){return this._authedRequest("POST",this._url(e,(i==null?void 0:i.prefix)||cs),t,s,i)}_put(e,t,s,i){return this._authedRequest("PUT",this._url(e,(i==null?void 0:i.prefix)||cs),t,s,i)}_get(e,t,s,i){return this._authedRequest("GET",this._url(e,(i==null?void 0:i.prefix)||cs),t,s,i)}sync(e,t,s,i){return this._get("/sync",{since:e,timeout:s,filter:t},void 0,i)}context(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/context/${encodeURIComponent(t)}`,{filter:i,limit:s})}messages(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,s)}members(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,s)}send(e,t,s,i,n){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,n)}redact(e,t,s,i,n){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,n)}receipt(e,t,s,i){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},{},i)}state(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},void 0,i)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}register(e,t,s,i,n=!0,o={}){o.allowedStatusCodes=[401];const a={auth:i,password:t,initial_device_displayname:s,inhibit_login:n};return e&&(a.username=e),this._unauthedRequest("POST",this._url("/register",da),void 0,a,o)}passwordLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:s},i)}tokenLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:s},i)}createFilter(e,t,s){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,s)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,s){let i="/keys/upload";return e&&(i=i+`/${encodeURIComponent(e)}`),this._post(i,{},t,s)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,s,i){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(s)}`,{},t,i)}roomKeysVersion(e,t){let s="";return e&&(s=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${s}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,s,i){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{version:e},void 0,i)}uploadRoomKeysToBackup(e,t,s){return this._put("/room_keys/keys",{version:e},t,s)}uploadAttachment(e,t,s){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,s)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e={}){return e.prefix=Qs,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t={}){return t.prefix=Qs,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t={}){return t.prefix=Qs,this._post("/dehydrated_device/claim",{},{device_id:e},t)}profile(e,t){return this._get(`/profile/${encodeURIComponent(e)}`)}createRoom(e,t){return this._post("/createRoom",{},e,t)}setAccountData(e,t,s,i){return this._put(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,{},s,i)}}class En{constructor(e){this._start=2e3,this._current=2e3;const t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof ye))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var Ft=(r=>(r[r.Waiting=0]="Waiting",r[r.Reconnecting=1]="Reconnecting",r[r.Online=2]="Online",r))(Ft||{});class ua{constructor({retryDelay:e,createMeasure:t,onlineStatus:s}){this._onlineStatus=s,this._retryDelay=e,this._createTimeMeasure=t,this._state=new we(2),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe(s=>{s&&this.tryNow()});try{await this._reconnectLoop(e)}catch(s){console.error(s)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(1);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}}async function ma(r,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:s}=r,{base64:i}=r.encoding;var n=i.decode(t.iv),o=i.encode(i.decode(t.hashes.sha256));const a=await s.digest("SHA-256",e);if(i.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var c;return t.v=="v1"||t.v=="v2"?c=64:c=128,await s.aes.decryptCTR({jwkKey:t.key,iv:n,data:e,counterLength:c})}async function pa(r,e){const{crypto:t}=r,{base64:s}=r.encoding,i=await t.aes.generateIV(),n=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:n,iv:i,data:o}),c=await t.digest("SHA-256",a);return{blob:r.createBlob(a,"application/octet-stream"),info:{v:"v2",key:n,iv:s.encodeUnpadded(i),hashes:{sha256:s.encodeUnpadded(c)}}}}class _a{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,s,i){const n=this._parseMxcUrl(e);if(n){const[o,a]=n;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+bn({width:Math.round(t),height:Math.round(s),method:i})}return null}mxcUrl(e){const t=this._parseMxcUrl(e);if(t){const[s,i]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(s)}/${encodeURIComponent(i)}`}else return null}_parseMxcUrl(e){const t="mxc://";return e.startsWith(t)?e.substr(t.length).split("/",2):null}async downloadEncryptedFile(e,t=!1){const s=this.mxcUrl(e.url),{body:i}=await this._platform.request(s,{method:"GET",format:"buffer",cache:t}).response(),n=await ma(this._platform,i,e);return this._platform.createBlob(n,e.mimetype)}async downloadPlaintextFile(e,t,s=!1){const i=this.mxcUrl(e),{body:n}=await this._platform.request(i,{method:"GET",format:"buffer",cache:s}).response();return this._platform.createBlob(n,t)}async downloadAttachment(e,t=!1){var s;return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,(s=e.info)==null?void 0:s.mimetype,t)}}class ga{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((s,i)=>{this.responseResolve=s,this.responseReject=i})}abort(){var e;this._requestResult?this._requestResult.abort():(this.responseReject(new ye),(e=this.responseCodeReject)==null||e.call(this,new ye))}response(){return this._responsePromise}responseCode(){return this.requestResult?this.requestResult.responseCode():(this._responseCodePromise||(this._responseCodePromise=new Promise((e,t)=>{this.responseCodeResolve=e,this.responseCodeReject=t})),this._responseCodePromise)}async setRequestResult(e){var i,n,o;this._requestResult=e;const t=await((i=this._requestResult)==null?void 0:i.response());this.responseResolve(t);const s=await((n=this._requestResult)==null?void 0:n.responseCode());(o=this.responseCodeResolve)==null||o.call(this,s)}get requestResult(){return this._requestResult}}class kn{constructor(e){this._scheduler=e}}for(const r of Object.getOwnPropertyNames(Xe.prototype))r!=="constructor"&&!r.startsWith("_")&&(kn.prototype[r]=function(...e){return this._scheduler._hsApiRequest(r,e)});class fa{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new kn(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const s=new ga(e,t);return this._doSend(s),s}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const s=this._hsApi[e.methodName].apply(this._hsApi,e.args);await e.setRequestResult(s);return}catch(s){if(s instanceof In&&s.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(s.retry_after_ms)?await this._clock.createTimeout(s.retry_after_ms).elapsed():(t||(t=new En(this._clock.createTimeout)),await t.waitForRetry());else{e.responseReject(s);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}const ya=3e4,A=Ne("InitialSync","CatchupSync","Syncing","Stopped");function wa(r){var e;try{const t=(e=r==null?void 0:r.timeline)==null?void 0:e.events;return Array.isArray(t)&&t.length===0}catch{return!0}}class va{constructor({hsApi:e,session:t,storage:s,logger:i}){this._hsApi=e,this._logger=i,this._session=t,this._storage=s,this._currentRequest=null,this._status=new we(A.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==A.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(A.CatchupSync):this._status.set(A.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==A.Stopped;){let t,s,i=this._status.get()===A.CatchupSync||this._status.get()===A.InitialSync;await this._logger.run("sync",async n=>{n.set("token",e),n.set("status",this._status.get());try{const o=this._status.get()===A.Syncing?ya:0,a=await this._syncRequest(e,o,n);e=a.syncToken,t=a.roomStates,s=a.sessionChanges,this._status.get()!==A.Syncing&&a.hadToDeviceMessages?this._status.set(A.CatchupSync):this._status.set(A.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(n.error=o,n.logLevel=n.level.Fatal),n.set("stopping",!0),this._status.set(A.Stopped)}this._status.get()!==A.Stopped&&await n.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(s,t,o))},this._logger.level.Info,(n,o)=>o.durationWithoutType("network")>=2e3||o.error||i?n.minLevel(o.level.Detail):n.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,s){const i=this._status.get()===A.CatchupSync,n=(async()=>{try{await s.wrap("session",c=>this._session.afterSyncCompleted(e,i,c),s.level.Detail)}catch{}})(),a=t.filter(c=>c.room.needsAfterSyncCompleted(c.changes)).map(async c=>{try{await s.wrap("room",l=>c.room.afterSyncCompleted(c.changes,l),s.level.Detail)}catch{}});await Promise.all(a.concat(n))}async _syncRequest(e,t,s){var p;let{syncFilterId:i}=this._session;typeof i!="string"&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:s}),i=(await this._currentRequest.response()).filter_id);const n=t+80*1e3;this._currentRequest=this._hsApi.sync(e,i,t,{timeout:n,log:s});const o=await this._currentRequest.response(),a=!e,c=new ba,l=this._parseInvites(o.rooms),{roomStates:h,archivedRoomStates:d}=await this._parseRoomsResponse(o.rooms,l,a,s);try{c.lock=await s.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(o)),await s.wrap("prepare",_=>this._prepareSync(c,h,o,_)),await s.wrap("afterPrepareSync",_=>Promise.all(h.map(g=>g.room.afterPrepareSync(g.preparation,_)))),await s.wrap("write",async _=>this._writeSync(c,l,h,d,o,i,a,_))}finally{c.dispose()}s.wrap("after",_=>this._afterSync(c,l,h,d,_));const m=(p=o.to_device)==null?void 0:p.events;return{syncToken:o.next_batch,roomStates:h,sessionChanges:c.changes,hadToDeviceMessages:Array.isArray(m)&&m.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,s,i){var a,c;const n=await this._openPrepareSyncTxn();e.preparation=await i.wrap("session",l=>this._session.prepareSync(s,e.lock,n,l));const o=(a=e.preparation)==null?void 0:a.newKeysByRoom;if(o){const{hasOwnProperty:l}=Object.prototype;for(const h of o.keys())if(!(((c=s.rooms)==null?void 0:c.join)&&l.call(s.rooms.join,h))){let m=this._session.rooms.get(h);m&&t.push(new yr(m,!1,{},m.membership))}}await Promise.all(t.map(async l=>{const h=o==null?void 0:o.get(l.room.id);l.preparation=await i.wrap("room",async d=>(l.isNewRoom&&await l.room.load(null,n,d),l.room.prepareSync(l.roomResponse,l.membership,h,n,d)),i.level.Detail)})),await n.complete()}async _writeSync(e,t,s,i,n,o,a,c){const l=await this._openSyncTxn();try{e.changes=await c.wrap("session",h=>this._session.writeSync(n,o,e.preparation,l,h)),await Promise.all(t.map(async h=>{h.changes=await c.wrap("invite",d=>h.invite.writeSync(h.membership,h.roomResponse,l,d))})),await Promise.all(s.map(async h=>{h.changes=await c.wrap("room",d=>h.room.writeSync(h.roomResponse,a,h.preparation,l,d))})),await Promise.all(i.map(async h=>{var m;const d=(m=h.roomState)==null?void 0:m.summaryChanges;h.changes=await c.wrap("archivedRoom",p=>h.archivedRoom.writeSync(d,h.roomResponse,h.membership,l,p))}))}catch(h){throw l.abort(c),l.getCause(h)}await l.complete(c)}_afterSync(e,t,s,i,n){n.wrap("session",o=>this._session.afterSync(e.changes,o),n.level.Detail);for(let o of i)n.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},n.level.Detail);for(let o of s)n.wrap("room",a=>o.room.afterSync(o.changes,a),n.level.Detail);for(let o of t)n.wrap("invite",a=>o.invite.afterSync(o.changes,a),n.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,s,i,n)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceIdentities,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions])}async _parseRoomsResponse(e,t,s,i){const n=[],o=[];if(e){const a=["join","leave"];for(const c of a){const l=e[c];if(l)for(const[h,d]of Object.entries(l)){if(s&&wa(d))continue;const m=this._session.invites.get(h);m&&t.push(new wr(m,!1,null,c));const p=this._createRoomSyncState(h,d,c,s);p&&n.push(p);const _=await this._createArchivedRoomSyncState(h,p,d,c,s,i);_&&o.push(_)}}}return{roomStates:n,archivedRoomStates:o}}_createRoomSyncState(e,t,s,i){let n=!1,o=this._session.rooms.get(e);if(!o&&(s==="join"||i&&s==="leave")&&(o=this._session.createJoinedRoom(e),n=!0),o)return new yr(o,n,t,s)}async _createArchivedRoomSyncState(e,t,s,i,n,o){let a;if((t==null?void 0:t.shouldAdd)&&!n?a=this._session.createOrGetArchivedRoomForSync(e):i==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new Sa(a,t,s,i)}_parseInvites(e){const t=[];if(e!=null&&e.invite)for(const[s,i]of Object.entries(e.invite)){let n=this._session.invites.get(s),o=!1;n||(n=this._session.createInvite(s),o=!0),t.push(new wr(n,o,i,"invite"))}return t}stop(){this._status.get()!==A.Stopped&&(this._status.set(A.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class ba{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){var e;(e=this.lock)==null||e.release()}}class yr{constructor(e,t,s,i){this.room=e,this.isNewRoom=t,this.roomResponse=s,this.membership=i,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){var e;return(e=this.changes)==null?void 0:e.summaryChanges}}class Sa{constructor(e,t,s,i,n){this.archivedRoom=e,this.roomState=t,this.roomResponse=s,this.membership=i,this.isInitialSync=n,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}}class wr{constructor(e,t,s,i){this.invite=e,this.isNewInvite=t,this.membership=i,this.roomResponse=s,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}}class Ns{constructor(){this._handlersByName={}}emit(e,t){const s=this._handlersByName[e];s&&s.forEach(i=>i(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let s=this._handlersByName[e];s||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=s=new Set),s.add(t)}off(e,t){const s=this._handlersByName[e];s&&(s.delete(t),s.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}function Ia(r){if(r.__esModule)return r;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(r).forEach(function(t){var s=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(e,t,s.get?s:{enumerable:!0,get:function(){return r[t]}})}),e}var vr=/[\\\"\x00-\x1F]/g,De={};for(var ls=0;ls<32;++ls)De[String.fromCharCode(ls)]="\\U"+("0000"+ls.toString(16)).slice(-4).toUpperCase();De["\b"]="\\b";De["	"]="\\t";De[`
`]="\\n";De["\f"]="\\f";De["\r"]="\\r";De['"']='\\"';De["\\"]="\\\\";function Rn(r){return vr.lastIndex=0,r.replace(vr,function(e){return De[e]})}function vi(r){switch(typeof r){case"string":return'"'+Rn(r)+'"';case"number":return isFinite(r)?r:"null";case"boolean":return r;case"object":return r===null?"null":Array.isArray(r)?Ea(r):ka(r);default:throw new Error("Cannot stringify: "+typeof r)}}function Ea(r){for(var e="[",t="",s=0;s<r.length;++s)t+=e,e=",",t+=vi(r[s]);return e!=","?"[]":t+"]"}function ka(r){var e="{",t="",s=Object.keys(r);s.sort();for(var i=0;i<s.length;++i){var n=s[i];t+=e+'"'+Rn(n)+'":',e=",",t+=vi(r[n])}return e!=","?"{}":t+"}"}var Cn={stringify:vi};const tt=Ne("Sync","Timeline","Retry"),ie="e2ee:",bi="m.olm.v1.curve25519-aes-sha2",ve="m.megolm.v1.aes-sha2";class H extends Error{constructor(e,t,s=null){super(`Decryption error ${e}${s?": "+JSON.stringify(s):""}`),this.code=e,this.event=t,this.details=s}}const Tn="ed25519";function Mn(r,e,t,s,i,n=void 0){var l,h;const o=Object.assign({},i);delete o.unsigned,delete o.signatures;const a=Cn.stringify(o),c=(h=(l=i==null?void 0:i.signatures)==null?void 0:l[e])==null?void 0:h[`${Tn}:${t}`];try{if(!c)throw new Error("no signature");return r.ed25519_verify(s,a,c),!0}catch(d){if(n){const m=n.log({l:"Invalid signature, ignoring.",ed25519Key:s,canonicalJson:a,signature:c});m.error=d,m.logLevel=n.level.Warn}return!1}}function Ra(){return{type:"m.room.encryption",state_key:"",content:{algorithm:ve,rotation_period_ms:6048e5,rotation_period_msgs:100}}}function Ca(r,e,t,s,i){return e.length&&(r=e.reduce((n,o)=>xa(n,o,t,s,i),r)),r}function An(r,e,t){var n,o;const s=(n=r==null?void 0:r.state)==null?void 0:n.events;Array.isArray(s)&&(t=s.reduce(e,t));const i=(o=r==null?void 0:r.timeline)==null?void 0:o.events;return Array.isArray(i)&&(t=i.reduce((a,c)=>(typeof c.state_key=="string"&&(t=e(t,c)),t),t)),t}function Ta(r,e,t,s){e.summary&&(r=Na(r,e.summary)),t!==r.membership&&(r=r.cloneIfNeeded(),r.membership=t),e.account_data&&(r=e.account_data.events.reduce(Aa,r)),r=An(e,(n,o)=>xn(n,o,s),r);const i=e.unread_notifications;return i&&(r=Ma(r,i)),r}function Ma(r,e){const t=e.highlight_count||0;t!==r.highlightCount&&(r=r.cloneIfNeeded(),r.highlightCount=t);const s=e.notification_count;return s!==r.notificationCount&&(r=r.cloneIfNeeded(),r.notificationCount=s),r}function Aa(r,e){var t;if((e==null?void 0:e.type)==="m.tag"){let s=(t=e==null?void 0:e.content)==null?void 0:t.tags;(!s||Array.isArray(s)||typeof s!="object")&&(s=null),r=r.cloneIfNeeded(),r.tags=s}return r}function xn(r,e,t){var s,i,n;if(e.type==="m.room.create")r=r.cloneIfNeeded(),r.lastMessageTimestamp=e.origin_server_ts;else if(e.type==="m.room.encryption"){const o=(s=e.content)==null?void 0:s.algorithm;!r.encryption&&o===ve&&(r=r.cloneIfNeeded(),r.encryption=e.content)}else if(e.type==="m.room.name"){const o=(i=e.content)==null?void 0:i.name;o!==r.name&&(r=r.cloneIfNeeded(),r.name=o)}else if(e.type==="m.room.avatar"){const o=(n=e.content)==null?void 0:n.url;o!==r.avatarUrl&&(r=r.cloneIfNeeded(),r.avatarUrl=o)}else if(e.type==="m.room.canonical_alias"){const o=e.content;r=r.cloneIfNeeded(),r.canonicalAlias=o.alias}else if(e.type==="m.room.member"){const o=e.content;if(o.is_direct===!0&&o.membership==="invite"&&!r.isDirectMessage){let a;e.sender===t?a=e.state_key:e.state_key===t&&(a=e.sender),a&&(r=r.cloneIfNeeded(),r.isDirectMessage=!0,r.dmUserId=a)}else o.membership==="leave"&&r.isDirectMessage&&r.dmUserId===e.state_key&&(r=r.cloneIfNeeded(),r.isDirectMessage=!1,r.dmUserId=null)}return r}function xa(r,e,t,s,i){return e.eventType==="m.room.message"&&((!r.lastMessageTimestamp||e.timestamp>r.lastMessageTimestamp)&&(r=r.cloneIfNeeded(),r.lastMessageTimestamp=e.timestamp),!t&&e.sender!==i&&s&&(r=r.cloneIfNeeded(),r.isUnread=!0)),r}function Na(r,e){const t=e["m.heroes"],s=e["m.joined_member_count"],i=e["m.invited_member_count"];return t&&Array.isArray(t)&&(r=r.cloneIfNeeded(),r.heroes=t),Number.isInteger(i)&&(r=r.cloneIfNeeded(),r.inviteCount=i),Number.isInteger(s)&&(r=r.cloneIfNeeded(),r.joinCount=s),r}class ke{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}changedKeys(e){return Object.getOwnPropertyNames(this).filter(s=>s!=="cloned"&&this[s]!==e[s])}cloneIfNeeded(){return this.cloned?this:new ke(this)}serialize(){return Object.entries(this).reduce((e,[t,s])=>(t!=="cloned"&&s!==null&&(e[t]=s),e),{})}applyTimelineEntries(e,t,s,i){return Ca(this,e,t,s,i)}applySyncResponse(e,t,s){return Ta(this,e,t,s)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}}class Da{constructor(e){this._data=null,this.applyChanges(new ke(null,e))}get data(){return this._data}writeClearUnread(e){const t=new ke(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const s=new ke(this._data);return s.hasFetchedMembers=e,t.roomSummary.set(s.serialize()),s}writeIsTrackingMembers(e,t){const s=new ke(this._data);return s.isTrackingMembers=e,t.roomSummary.set(s.serialize()),s}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const s=await t.readWriteTxn([t.storeNames.roomSummary]);try{s.roomSummary.set(e.serialize())}catch(i){throw s.abort(),i}return await s.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new ke(e))}}var N=(r=>(r.session="session",r.roomState="roomState",r.roomSummary="roomSummary",r.archivedRoomSummary="archivedRoomSummary",r.invites="invites",r.roomMembers="roomMembers",r.timelineEvents="timelineEvents",r.timelineRelations="timelineRelations",r.timelineFragments="timelineFragments",r.pendingEvents="pendingEvents",r.userIdentities="userIdentities",r.deviceIdentities="deviceIdentities",r.olmSessions="olmSessions",r.inboundGroupSessions="inboundGroupSessions",r.outboundGroupSessions="outboundGroupSessions",r.groupSessionDecryptions="groupSessionDecryptions",r.operations="operations",r.accountData="accountData",r))(N||{});const Ht=Object.values(N);class Ce extends Error{constructor(e,t=null){super(e),t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const O={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};class B{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new B(this.fragmentId+1,O.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new B(this.fragmentId,this.eventIndex-1)}nextKey(){return new B(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new B(O.maxStorageKey,O.maxStorageKey)}static get minKey(){return new B(O.minStorageKey,O.minStorageKey)}static get defaultLiveKey(){return B.defaultFragmentKey(O.minStorageKey)}static defaultFragmentKey(e){return new B(e,O.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===(e==null?void 0:e.fragmentId)&&this.eventIndex===(e==null?void 0:e.eventIndex)}}const ni=Number.MAX_SAFE_INTEGER;class Nn{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===ni?1:e.fragmentId===ni?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new B(this.fragmentId,this.entryIndex)}}function oi(r){var e;return((e=r.unsigned)==null?void 0:e.prev_content)||r.prev_content}const fe="m.room.redaction";function ai(r){var e;return!!((e=r==null?void 0:r.unsigned)!=null&&e.redacted_because)}var L=(r=>(r[r.None=1]="None",r[r.BeingCreated=2]="BeingCreated",r[r.Invited=4]="Invited",r[r.Joined=8]="Joined",r[r.Replaced=16]="Replaced",r[r.Archived=32]="Archived",r))(L||{}),re=(r=>(r[r.DirectMessage=0]="DirectMessage",r[r.Private=1]="Private",r[r.Public=2]="Public",r))(re||{});const La="m.reaction",We="m.annotation";function Oa(r,e){return{"m.relates_to":{event_id:r,key:e,rel_type:We}}}function Si(r){var e;return r.event_id||((e=r["m.in_reply_to"])==null?void 0:e.event_id)}function Dn(r,e){r.event_id!==void 0?r.event_id=e:r["m.in_reply_to"]&&(r["m.in_reply_to"].event_id=e)}function Ua(r){if(r.type===fe)return r.redacts;{const e=qe(r);if(e)return Si(e)}return null}function ze(r){return r==null?void 0:r["m.relates_to"]}function qe(r){return ze(r.content)}class Pa{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce((t,s)=>!t||s.pendingEvent.queueIndex>t.pendingEvent.queueIndex?s:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}}function br(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Va(r){switch(r){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function Ba(r){return r==="m.emote"?"* ":""}function Fa(r,e,t,s){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:s,"m.relates_to":{"m.in_reply_to":{event_id:r}}}}function Ka(r,e,t){const s=Va(r.content.msgtype),i=Ba(r.content.msgtype),n=r.sender,o=r.displayName||n,a=s||r.content.formatted_body||r.content.body&&br(r.content.body)||"",c=`<mx-reply><blockquote>In reply to ${i}<a href="https://matrix.to/#/${n}">${o}</a><br />${a}</blockquote></mx-reply>`,h=(s||r.content.body||"").split(`
`);h[0]=`> ${i}<${n}> ${h[0]}`;const m=h.join(`
> `)+`

`+t,p=c+br(t);return Fa(r.id,e,m,p)}class Ln extends Nn{constructor(e){super(e),this._pendingRedactions=null,this._pendingAnnotations=null,this._contextEntry=null,this._contextForEntries=null}get isReply(){var e;return!!((e=this.relation)!=null&&e["m.in_reply_to"])}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===fe}get redactionReason(){var e;return this._pendingRedactions?(e=this._pendingRedactions[0].content)==null?void 0:e.reason:null}setContextEntry(e){this._contextEntry=e,e._setAsContextOf(this)}_setAsContextOf(e){this._contextForEntries||(this._contextForEntries=[]),this._contextForEntries.push(e)}get contextForEntries(){return this._contextForEntries}get contextEntry(){return this._contextEntry}addLocalRelation(e){if(e.eventType===fe&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===We&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){var t;if(e.eventType===fe&&e.isRelatedToId(this.id)&&this._pendingRedactions){const s=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(i=>i!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,s!==0))return"isRedacted"}else{const s=e.redactingEntry||e;if(s.isRelatedToId(this.id)&&((t=s.relation)==null?void 0:t.rel_type)===We&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s||(s=new Pa,this._pendingAnnotations.set(t,s)),s.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s.remove(e)&&s.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return Oa(this.id,e)}reply(e,t){return Ka(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){var n,o,a;const t=((o=(n=this.annotations)==null?void 0:n[e])==null?void 0:o.me)||!1,s=(a=this.pendingAnnotations)==null?void 0:a.get(e),i=(s==null?void 0:s.willAnnotate)||!1;return t&&(!s||i)||!t&&i}get relation(){return ze(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class $a extends Ln{constructor({pendingEvent:e,member:t,clock:s,redactingEntry:i}){super(null),this._pendingEvent=e,this._member=t,this._timestamp=s.now()-(100-e.queueIndex),this._redactingEntry=i}get fragmentId(){return ni}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){var e;return(e=this._member)==null?void 0:e.userId}get displayName(){var e;return(e=this._member)==null?void 0:e.name}get avatarUrl(){var e;return(e=this._member)==null?void 0:e.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}get contextEventId(){var e;return this.isReply?(e=this._pendingEvent.relatedEventId)!=null?e:this._pendingEvent.relatedTxnId:null}}const M=Ne("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),Sr=["m.relates_to"];class qa{constructor({data:e,remove:t,emitUpdate:s,attachments:i}){this._data=e,this._attachments=i,this._emitUpdate=s,this._removeFromQueueCallback=t,this._aborted=!1,this._status=M.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((n,o)=>n+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=ze(this.content);return e?Si(e):this._data.relatedEventId}setRelatedEventId(e){const t=ze(this.content);t?Dn(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=M.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of Sr)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const s of Sr)t[s]!==void 0&&(e[s]=t[s])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=M.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=M.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===M.Sending||this._status===M.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=M.EncryptingAttachments,this._emitUpdate("status");for(const i of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",i.size),i.encrypt())),this.aborted)throw new ye}this._status=M.UploadingAttachments,this._emitUpdate("status");const s=Object.entries(this._attachments);s.sort(([,i],[,n])=>i.size-n.size);for(const[i,n]of s)await t.wrap("upload",o=>(o.set("size",n.size),n.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),n.applyToContent(i,this.content);this._data.needsUpload=!1}async abort(){var e;if(!this._aborted){if(this._aborted=!0,this._attachments)for(const t of Object.values(this._attachments))t.abort();(e=this._sendRequest)==null||e.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=M.Sending,this._emitUpdate("status");const s=this._data.encryptedEventType||this._data.eventType,i=this._data.encryptedContent||this._data.content;s===fe?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,i,{log:t}):this._sendRequest=e.send(this.roomId,s,this.txnId,i,{log:t});const n=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=n.event_id,t.set("id",this._data.remoteId),this._status=M.Sent,this._emitUpdate("status")}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}class ne extends Ln{constructor(e,t){super(t),this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new ne(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&!this._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&!this._decryptionError&&(this._decryptionError=e._decryptionError),this._contextForEntries=e.contextForEntries,this._contextEntry=e.contextEntry}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.content)||this._eventEntry.event.content}get prevContent(){return oi(this._eventEntry.event)}get eventType(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.type)||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){var e;return!!((e=this._decryptionResult)!=null&&e.event)}get isVerified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isVerified)}get isUnverified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isUnverified)}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return Ua(this.event)}get isRedacted(){return super.isRedacted||ai(this._eventEntry.event)}get redactionReason(){var t,s;const e=(t=this._eventEntry.event.unsigned)==null?void 0:t.redacted_because;return e?(s=e.content)==null?void 0:s.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&ze(e)||ze(this.content)}get contextEventId(){return this.isReply?this.relatedEventId:null}}function On(r,e,t){return{fragmentId:r.fragmentId,eventIndex:r.eventIndex,roomId:e,event:t}}function Kt(r,e,t){t.isForward?r.push(e):r.unshift(e)}function ja(r,e,t){return t.isForward?r.concat(e):e.concat(r)}const oe="m.room.member";class x{constructor(e){this._data=e}static fromUserId(e,t,s){return new x({roomId:e,userId:t,membership:s})}static fromMemberEvent(e,t){const s=t==null?void 0:t.state_key;if(typeof s!="string")return;const i=t.content,n=oi(t),o=i==null?void 0:i.membership,a=(i==null?void 0:i.displayname)||(n==null?void 0:n.displayname),c=(i==null?void 0:i.avatar_url)||(n==null?void 0:n.avatar_url);return this._validateAndCreateMember(e,s,o,a,c)}static fromReplacingMemberEvent(e,t){const s=t&&t.state_key;if(typeof s!="string")return;const i=oi(t);return this._validateAndCreateMember(e,s,i==null?void 0:i.membership,i==null?void 0:i.displayname,i==null?void 0:i.avatar_url)}static _validateAndCreateMember(e,t,s,i,n){if(typeof s=="string")return new x({roomId:e,userId:t,membership:s,avatarUrl:n,displayName:i})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,s=e._data;return t.roomId===s.roomId&&t.userId===s.userId&&t.membership===s.membership&&t.displayName===s.displayName&&t.avatarUrl===s.avatarUrl}}class Un{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}}function Ii(r){return typeof r=="number"}const Wa=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(r,e){return r[e]=1,r},{}),Ha={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};function za(r,e){for(const i of Object.keys(e))Wa[i]||delete e[i];const{content:t}=e,s=Ha[e.type];for(const i of Object.keys(t))s!=null&&s[i]||delete t[i];e.unsigned=e.unsigned||{},e.unsigned.redacted_because=r}function Ga(r,e){const t=[];for(;Ii(r.previousId);){const s=e.get(r.previousId);if(!s)break;if(s.nextId!==r.id)throw new Error(`Previous fragment ${s.id} doesn't point back to ${r.id}`);e.delete(r.previousId),t.unshift(s),r=s}return t}function Ja(r,e){const t=[];for(;Ii(r.nextId);){const s=e.get(r.nextId);if(!s)break;if(s.previousId!==r.id)throw new Error(`Next fragment ${s.id} doesn't point back to ${r.id}`);e.delete(r.nextId),t.push(s),r=s}return t}function Qa(r){const e=new Map;for(let s of r)e.set(s.id,s);const t=[];for(;e.size;){const s=e.values().next().value;e.delete(s.id);const i=Ga(s,e),n=Ja(s,e),o=i.concat(s,n);t.push(o)}return t.map(s=>new Ya(s))}class Ys{constructor(e,t,s){this.id=e,this.previousId=t,this.nextId=s}}class Ya{constructor(e){this._idToSortIndex=new Map,e.forEach((t,s)=>{this._idToSortIndex.set(t.id,s)})}compare(e,t){const s=this._idToSortIndex.get(e);if(s===void 0)throw new Error(`first id ${e} isn't part of this island`);const i=this._idToSortIndex.get(t);if(i===void 0)throw new Error(`second id ${t} isn't part of this island`);return s-i}get fragmentIds(){return this._idToSortIndex.keys()}}class Ir extends Error{get name(){return"CompareError"}}class Xa{constructor(e){this._fragmentsById=e.reduce((t,s)=>(t.set(s.id,s),t),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(t===void 0)throw new Ir(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const s=this._getIsland(e),i=this._getIsland(t);if(s!==i)throw new Ir(`${e} and ${t} are on different islands, can't tell order`);return s.compare(e,t)}rebuild(e){const t=Qa(e);this._idToIsland=new Map;for(let s of t)for(let i of s.fragmentIds)this._idToIsland.set(i,s)}add(e){const t=new Ys(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const s=new Ys(e,t,null),i=this._fragmentsById.get(t);i&&(i.nextId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}prepend(e,t){const s=new Ys(e,null,t),i=this._fragmentsById.get(t);i&&(i.previousId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}}(function(){const e=document.createElement("link").relList;return e&&e.supports&&e.supports("modulepreload")?"modulepreload":"preload"})();function Za(r){return"objectStore"in r?`${r.objectStore.name}.${r.name}`:r.name}function ec(r){var e,t,s,i,n;return"objectStore"in r?(s=(t=(e=r.objectStore)==null?void 0:e.transaction)==null?void 0:t.db)==null?void 0:s.name:(n=(i=r.transaction)==null?void 0:i.db)==null?void 0:n.name}class Pn extends Ce{constructor(e,t,s=null){const i=t&&"source"in t?t.source:t,n=i?Za(i):"",o=i?ec(i):"";let a=`${e} on ${o}.${n}`;s&&(a+=": ",typeof s.name=="string"&&(a+=`(name: ${s.name}) `),typeof s.code=="number"&&(a+=`(code: ${s.code}) `)),s&&(a+=s.message),super(a,s),this.storeName=n,this.databaseName=o}}class Ei extends Pn{constructor(e){const t=e.target,s=t.source,i=t.error;super("IDBRequest failed",s,i),this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class Ee extends Pn{constructor(e,t,s,i){super(`${e}(${i.map(n=>JSON.stringify(n)).join(", ")}) failed`,t,s)}}const Er={done:!0},be={done:!1};function Is(r){const e=r.toString(16);return"0".repeat(8-e.length)+e}function ci(r){return parseInt(r,16)}function ki(r,e,t,s=window.indexedDB){const i=s.open(r,t);return i.onupgradeneeded=async n=>{const o=n.target,a=o.result,c=o.transaction,l=n.oldVersion;try{await e(a,c,l,t)}catch{try{c.abort()}catch{}}},z(i)}function z(r){return new Promise((e,t)=>{r.addEventListener("success",s=>{e(s.target.result)}),r.addEventListener("error",s=>{const i=new Ei(s);t(i)})})}function zt(r){return new Promise((e,t)=>{r.addEventListener("complete",()=>{e()}),r.addEventListener("abort",s=>{t(new ye)})})}function U(r,e){return new Promise((t,s)=>{r.onerror=i=>{s(new Ei(i))},r.onsuccess=i=>{const n=i.target.result;if(!n){t(!1);return}const o=e(n.value,n.key,n),a=o==null?void 0:o.done,c=o==null?void 0:o.jumpTo;a?t(!0):c?n.continue(c):n.continue()}}).catch(t=>{throw new Ce("iterateCursor failed",t)})}async function tc(r,e){const t=[];return await U(r,s=>(t.push(s),{done:e(t)})),t}class kr{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}count(e){return z(this._target.count(e))}get(e){return z(this._target.get(e))}getKey(e){return this._target.supports("getKey")?z(this._target.getKey(e)):z(this._target.get(e)).then(t=>{if(t){let s=this._target.keyPath;return typeof s=="string"&&(s=[s]),s.reduce((i,n)=>i[n],t)}})}reduce(e,t,s){return this._reduce(e,t,s,"next")}reduceReverse(e,t,s){return this._reduce(e,t,s,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const s=this._openCursor(e,t),i=[];return await U(s,n=>(i.push(n),be)),i}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let s;return await U(t,(i,n)=>(s=n,Er)),s}async iterateValues(e,t){const s=this._target.openCursor(e,"next");await U(s,(i,n,o)=>({done:t(i,n,o)}))}async iterateKeys(e,t){const s=this._target.openKeyCursor(e,"next");await U(s,(i,n,o)=>({done:t(n,o)}))}async findExistingKeys(e,t,s){const i=(d,m)=>t?-this.idbFactory.cmp(d,m):this.idbFactory.cmp(d,m),n=e.slice().sort(i),o=n[0],a=n[n.length-1],c=t?"prev":"next",l=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),c);let h=0;await U(l,(d,m,p)=>{for(;h<n.length&&i(n[h],m)<0;)h+=1;let _=!1;if(n[h]===m){const g=p.primaryKey;_=s(m,g),h+=1}return _||h>=n.length?Er:{done:!1,jumpTo:n[h]}})}_reduce(e,t,s,i){let n=s;const o=this._openCursor(e,i);return U(o,a=>(n=t(n,a),be))}_selectLimit(e,t,s){return this._selectUntil(e,i=>i.length===t,s)}async _selectUntil(e,t,s){const i=this._openCursor(e,s),n=[];return await U(i,o=>(n.push(o),{done:t(n,o)})),n}async _selectWhile(e,t,s){const i=this._openCursor(e,s),n=[];return await U(i,o=>{const a=t(o);return a&&n.push(o),{done:!a}}),n}async iterateWhile(e,t){const s=this._openCursor(e,"next");await U(s,i=>({done:!t(i)}))}async _find(e,t,s){const i=this._openCursor(e,s);let n;if(await U(i,a=>{const c=t(a);return c&&(n=a),{done:c}}))return n}}const Be=!1;function Fe(r,e,t){var n,o;const s=t==null?void 0:t.name,i=(o=(n=t==null?void 0:t.transaction)==null?void 0:n.db)==null?void 0:o.name;console.info(`${i}.${s}.${r}(${e.map(a=>JSON.stringify(a)).join(", ")})`)}class Rr{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(Be&&Fe("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(Be&&Fe("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(s){throw new Ee("openKeyCursor",this._qt,s,[e,t])}}openCursor(e,t){try{return Be&&Fe("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(s){throw new Ee("openCursor",this._qt,s,[e,t])}}put(e,t){try{return Be&&Fe("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(s){throw new Ee("put",this._qt,s,[e,t])}}add(e,t){try{return Be&&Fe("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(s){throw new Ee("add",this._qt,s,[e,t])}}get(e){try{return Be&&Fe("get",[e],this._qt),this._qt.get(e)}catch(t){throw new Ee("get",this._qt,t,[e])}}getKey(e){try{return Be&&Fe("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new Ee("getKey",this._qt,t,[e])}}delete(e){try{return Be&&Fe("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new Ee("delete",this._qt,t,[e])}}count(e){try{return this._qt.count(e)}catch(t){throw new Ee("count",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new Ee("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class Vn extends kr{constructor(e,t){super(new Rr(e),t)}get _idbStore(){return this._target}index(e){return new kr(new Rr(this._idbStore.index(e)),this._transaction)}put(e,t){const s=this._idbStore.put(e);this._prepareErrorLog(s,t,"put",void 0,e)}add(e,t){const s=this._idbStore.add(e);this._prepareErrorLog(s,t,"add",void 0,e)}async tryAdd(e,t){try{return await z(this._idbStore.add(e)),!0}catch(s){if(s instanceof Ei)return t.log({l:"could not write",id:this._getKeys(e),e:s},t.level.Warn),s.preventTransactionAbort(),!1;throw s}}delete(e,t){const s=this._idbStore.delete(e);this._prepareErrorLog(s,t,"delete",e,void 0)}_prepareErrorLog(e,t,s,i,n){t&&t.ensureRefId(),z(e).catch(o=>{let a;n?a=this._getKeys(n):i&&(a=[i]),this._transaction.addWriteError(o,t,s,a)})}_getKeys(e){const t=[],{keyPath:s}=this._idbStore;try{t.push(this._readKeyPath(e,s))}catch{console.warn("could not read keyPath",s)}for(const i of this._idbStore.indexNames)try{const n=this._idbStore.index(i);t.push(this._readKeyPath(e,n.keyPath))}catch{console.warn("could not read index",i)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let s=e;for(const i of t)if(typeof s=="object")s=s[i];else break;return s}else return e[t]}}function sc(r){return JSON.stringify(Bn(r))}function ic(r){return Fn(JSON.parse(r))}function Bn(r){if(typeof r=="object"&&r!==null&&!Array.isArray(r)){if(r.byteLength)return{_type:r.constructor.name,value:Array.from(r)};let e={};for(const t in r)r.hasOwnProperty(t)&&(e[t]=Bn(r[t]));return e}else return r}function Fn(r){if(typeof r=="object"&&r!==null&&!Array.isArray(r)){if(typeof r._type=="string")switch(r._type){case"Int8Array":return Int8Array.from(r.value);case"Uint8Array":return Uint8Array.from(r.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(r.value);case"Int16Array":return Int16Array.from(r.value);case"Uint16Array":return Uint16Array.from(r.value);case"Int32Array":return Int32Array.from(r.value);case"Uint32Array":return Uint32Array.from(r.value);case"Float32Array":return Float32Array.from(r.value);case"Float64Array":return Float64Array.from(r.value);case"BigInt64Array":return BigInt64Array.from(r.value);case"BigUint64Array":return BigUint64Array.from(r.value);default:return r.value}let e={};for(const t in r)r.hasOwnProperty(t)&&(e[t]=Fn(r[t]));return e}else return r}class Ri{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return`${this._sessionStore.databaseName}.session.`}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const s=this._localStorageKeyPrefix+e,i=sc(t);this._localStorage.setItem(s,i)}catch(s){console.error("could not write to localStorage",s)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith(ie)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const s=this._localStorageKeyPrefix,i=s+ie;for(let n=0;n<this._localStorage.length;n+=1){const o=this._localStorage.key(n);if(o.startsWith(i)){const a=ic(this._localStorage.getItem(o)),c=o.substr(s.length),l=await this._sessionStore.getKey(c)===c;e.set(c,!l),l||(this._sessionStore.put({key:c,value:a}),t=!0)}}return t}set(e,t){e.startsWith(ie)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith(ie)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith(ie)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class Cr{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){const t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}}class rc{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}var _e=(r=>(r[r.All=1]="All",r[r.Debug=2]="Debug",r[r.Detail=3]="Detail",r[r.Info=4]="Info",r[r.Warn=5]="Warn",r[r.Error=6]="Error",r[r.Fatal=7]="Fatal",r[r.Off=8]="Off",r))(_e||{});class li{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}function Es(){}class nc{constructor(){this.item=new oc(this)}log(){}run(e,t){return t(this.item)}wrapOrRun(e,t,s){return e?e.wrap(t,s):this.run(t,s)}runDetached(e,t){return new Promise(s=>s(t(this.item))).then(Es,Es),this.item}async export(){}get level(){return _e}}class oc{constructor(e){this.logger=e}wrap(e,t){return t(this)}log(){return this}set(){return this}runDetached(e,t){return new Promise(s=>s(t(this))).then(Es,Es),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return _e}get duration(){return 0}catch(e){return e}child(){return this}finish(){}serialize(){}}const ac=new nc;function ae(r,e,t){return`${r}|${Is(e)}|${Is(t)}`}function cc(r){const[e,t,s]=r.split("|");return{roomId:e,eventKey:new B(ci(t),ci(s))}}function hs(r,e){return`${r}|${e}`}function Tr(r){const[e,t]=r.split("|");return{roomId:e,eventId:t}}class ds{constructor(e,t,s,i,n=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=s,this._upper=i,this._lowerOpen=n,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(ae(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(ae(e,this._lower.fragmentId,this._lower.eventIndex),ae(e,this._lower.fragmentId,O.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(ae(e,this._upper.fragmentId,O.minStorageKey),ae(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(ae(e,this._lower.fragmentId,this._lower.eventIndex),ae(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new Ce("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}}class lc{constructor(e){this._timelineStore=e}onlyRange(e){return new ds(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new ds(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new ds(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,s=!1,i=!1){return new ds(this._timelineStore.IDBKeyRange,void 0,e,t,s,i)}async lastEvents(e,t,s){const i=B.maxKey;return i.fragmentId=t,this.eventsBefore(e,i,s)}async firstEvents(e,t,s){const i=B.minKey;return i.fragmentId=t,this.eventsAfter(e,i,s)}eventsAfter(e,t,s){const i=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(i,s)}async eventsBefore(e,t,s){const i=this.upperBoundRange(t,!0).asIDBKeyRange(e),n=await this._timelineStore.selectLimitReverse(i,s);return n.reverse(),n}async getEventKeysForIds(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(o=>hs(e,o)),n=new Map;return await s.findExistingKeys(i,!1,(o,a)=>{const{eventId:c}=Tr(o),{eventKey:l}=cc(a);return n.set(c,l),!1}),n}async findFirstOccurringEventId(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(c=>hs(e,c)),n=new Array(i.length);let o;function a(){for(let c=0;c<n.length;++c){if(n[c]===void 0)return;if(n[c]===!0)return i[c]}}return await s.findExistingKeys(i,!1,(c,l)=>{const h=i.indexOf(c);return n[h]=l,o=a(),!!o}),o&&Tr(o).eventId}tryInsert(e,t){return e.key=ae(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=hs(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(ae(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(hs(e,t))}removeAllForRoom(e){const t=ae(e,O.minStorageKey,O.minStorageKey),s=ae(e,O.maxStorageKey,O.maxStorageKey),i=this._timelineStore.IDBKeyRange.bound(t,s);this._timelineStore.delete(i)}}const te="\0",F="\u{10FFFF}";function me(r,e,t,s){return`${r}|${e}|${t}|${s}`}function Mr(r){const[e,t,s,i]=r.split("|");return{roomId:e,targetEventId:t,relType:s,sourceEventId:i}}class hc{constructor(e){this._store=e}add(e,t,s,i){this._store.add({key:me(e,t,s,i)})}remove(e,t,s,i){this._store.delete(me(e,t,s,i))}removeAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(me(e,t,te,te),me(e,t,F,F),!0,!0);this._store.delete(s)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(me(e,te,te,te),me(e,F,F,F),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,s){const i=this._store.IDBKeyRange.bound(me(e,t,s,te),me(e,t,s,F),!0,!0);return(await this._store.selectAll(i)).map(o=>Mr(o.key))}async getAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(me(e,t,te,te),me(e,t,F,F),!0,!0);return(await this._store.selectAll(s)).map(n=>Mr(n.key))}}function Ar(r,e,t){return`${r}|${e}|${t}`}class dc{constructor(e){this._roomStateStore=e}get(e,t,s){const i=Ar(e,t,s);return this._roomStateStore.get(i)}set(e,t){const s=Ar(e,t.type,t.state_key),i={roomId:e,event:t,key:s};this._roomStateStore.put(i)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${F}`,!0,!0);this._roomStateStore.delete(t)}}function us(r,e){return`${r}|${e}`}function uc(r){const[e,t]=r.split("|");return{roomId:e,userId:t}}class Kn{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(us(e,t))}set(e){e.key=us(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(us(e,""));return this._roomMembersStore.selectWhile(t,s=>s.roomId===e)}async getAllUserIds(e){const t=[],s=this._roomMembersStore.IDBKeyRange.lowerBound(us(e,""));return await this._roomMembersStore.iterateKeys(s,i=>{const n=uc(i);return n.roomId===e?(t.push(n.userId),!1):!0}),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${F}`,!0,!0);this._roomMembersStore.delete(t)}}function ms(r,e){return`${r}|${Is(e)}`}class mc{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(ms(e,O.minStorageKey),ms(e,O.maxStorageKey))}catch(t){throw new Ce(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=ms(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(ms(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function Je(r,e){return`${r}|${Is(e)}`}function pc(r){const[e,t]=r.split("|"),s=ci(t);return{roomId:e,queueIndex:s}}class _c{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(Je(e,O.minStorageKey),Je(e,O.maxStorageKey),!1,!1),s=await this._eventStore.findMaxKey(t);if(s)return pc(s).queueIndex}remove(e,t){const s=this._eventStore.IDBKeyRange.only(Je(e,t));this._eventStore.delete(s)}async exists(e,t){const s=this._eventStore.IDBKeyRange.only(Je(e,t));return!!await this._eventStore.getKey(s)}add(e){e.key=Je(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=Je(e,O.minStorageKey),s=Je(e,O.maxStorageKey),i=this._eventStore.IDBKeyRange.bound(t,s);this._eventStore.delete(i)}}class gc{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function Qe(r,e){return`${r}|${e}`}function fc(r){const[e,t]=r.split("|");return{userId:e,deviceId:t}}class yc{constructor(e){this._store=e}getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(Qe(e,""));return this._store.selectWhile(t,s=>s.userId===e)}async getAllDeviceIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(Qe(e,""));return await this._store.iterateKeys(s,i=>{const n=fc(i);return n.userId===e?(t.push(n.deviceId),!1):!0}),t}get(e,t){return this._store.get(Qe(e,t))}set(e){e.key=Qe(e.userId,e.deviceId),this._store.put(e)}getByCurve25519Key(e){return this._store.index("byCurve25519Key").get(e)}remove(e,t){this._store.delete(Qe(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(Qe(e,te),Qe(e,F),!0,!0);this._store.delete(t)}}function At(r,e){return`${r}|${e}`}function wc(r){const[e,t]=r.split("|");return{senderKey:e,sessionId:t}}class vc{constructor(e){this._store=e}async getSessionIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(At(e,""));return await this._store.iterateKeys(s,i=>{const n=wc(i);return n.senderKey===e?(t.push(n.sessionId),!1):!0}),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(At(e,""));return this._store.selectWhile(t,s=>s.senderKey===e)}get(e,t){return this._store.get(At(e,t))}set(e){e.key=At(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(At(e,t))}}var Ds=(r=>(r[r.NotBackedUp=0]="NotBackedUp",r[r.BackedUp=1]="BackedUp",r))(Ds||{}),Xt=(r=>(r[r.DeviceMessage=1]="DeviceMessage",r[r.Backup=2]="Backup",r[r.Outbound=3]="Outbound",r))(Xt||{});function _t(r,e,t){return`${r}|${e}|${t}`}class bc{constructor(e){this._store=e}async has(e,t,s){const i=_t(e,t,s),n=await this._store.getKey(i);return i===n}get(e,t,s){return this._store.get(_t(e,t,s))}set(e){const t=e;t.key=_t(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(_t(e,te,te),_t(e,F,F));this._store.delete(t)}countNonBackedUpSessions(){return this._store.index("byBackup").count(this._store.IDBKeyRange.only(0))}getFirstNonBackedUpSessions(e){return this._store.index("byBackup").selectLimit(this._store.IDBKeyRange.only(0),e)}async markAsBackedUp(e,t,s){const i=await this._store.get(_t(e,t,s));i&&(i.backup=1,this._store.put(i))}async markAllAsNotBackedUp(){const e=this._store.IDBKeyRange.only(1);let t=0;return await this._store.index("byBackup").iterateValues(e,(s,i,n)=>(s.backup=0,n.update(s),t+=1,!1)),t}}class Sc{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function ps(r,e,t){return`${r}|${e}|${t}`}class Ic{constructor(e){this._store=e}get(e,t,s){return this._store.get(ps(e,t,s))}set(e,t,s,i){i.key=ps(e,t,s),this._store.put(i)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ps(e,te,te),ps(e,F,F));this._store.delete(t)}}function Ut(r,e){return`${r}|${e}`}class Ec{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const s=Ut(t,e),i=[];return await this._store.index("byScopeAndType").iterateWhile(s,n=>n.scopeTypeKey!==s?!1:(i.push(n),!0)),i}add(e){e.scopeTypeKey=Ut(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(Ut(e,te),Ut(e,F));await this._store.index("byScopeAndType").iterateValues(t,(i,n,o)=>(o.delete(),!0))}}class kc{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}}class Rc{constructor(e,t,s,i){this.error=e,this.refItem=t,this.operationName=s,this.keys=i}}class xr{constructor(e,t,s){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=s,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new Ce(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new Vn(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const s=this._idbStore(e);this._stores[e]=t(s)}return this._stores[e]}get session(){return this._store(N.session,e=>new Ri(e,this._storage.localStorage))}get roomSummary(){return this._store(N.roomSummary,e=>new Cr(e))}get archivedRoomSummary(){return this._store(N.archivedRoomSummary,e=>new Cr(e))}get invites(){return this._store(N.invites,e=>new rc(e))}get timelineFragments(){return this._store(N.timelineFragments,e=>new mc(e))}get timelineEvents(){return this._store(N.timelineEvents,e=>new lc(e))}get timelineRelations(){return this._store(N.timelineRelations,e=>new hc(e))}get roomState(){return this._store(N.roomState,e=>new dc(e))}get roomMembers(){return this._store(N.roomMembers,e=>new Kn(e))}get pendingEvents(){return this._store(N.pendingEvents,e=>new _c(e))}get userIdentities(){return this._store(N.userIdentities,e=>new gc(e))}get deviceIdentities(){return this._store(N.deviceIdentities,e=>new yc(e))}get olmSessions(){return this._store(N.olmSessions,e=>new vc(e))}get inboundGroupSessions(){return this._store(N.inboundGroupSessions,e=>new bc(e))}get outboundGroupSessions(){return this._store(N.outboundGroupSessions,e=>new Sc(e))}get groupSessionDecryptions(){return this._store(N.groupSessionDecryptions,e=>new Ic(e))}get operations(){return this._store(N.operations,e=>new Ec(e))}get accountData(){return this._store(N.accountData,e=>new kc(e))}async complete(e){try{await zt(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof Ce&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e==null||e.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,s,i){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new Rc(e,t,s,i))}_logWriteErrors(e){const t=i=>{e||i.set("allowedStoreNames",this._allowedStoreNames);for(const n of this._writeErrors)i.wrap({l:n.operationName,id:n.keys},o=>{n.refItem&&o.refDetached(n.refItem),o.catch(n.error)})},s=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(s,t):this.logger.run(s,t)}}const Nr="782rh281re38-boguskey";class Cc{constructor(e,t,s,i,n,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=s,this._hasWebkitEarlyCloseTxnBug=i,this.storeNames=N,this.localStorage=n,this.logger=o}_validateStoreNames(e){const t=e.findIndex(s=>!Ht.includes(s));if(t!==-1)throw new Ce(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await z(t.objectStore(e[0]).get(Nr)),new xr(t,e,this)}catch(t){throw new Ce("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await z(t.objectStore(e[0]).get(Nr)),new xr(t,e,this)}catch(t){throw new Ce("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}}async function Tc(r){const e=r.transaction(Ht,"readonly"),t={};return await Promise.all(Ht.map(async s=>{const i=t[s]=[],n=e.objectStore(s);await U(n.openCursor(),o=>(i.push(o),be))})),t}async function Mc(r,e){const t=r.transaction(Ht,"readwrite");for(const s of Ht){const i=t.objectStore(s);for(const n of e[s])i.add(n)}await zt(t)}const hi=0,Dr=1;function $n(r,e,t){if(r){if(!r.roomIds.includes(t))return r.roomIds.push(t),r}else return r={userId:e,roomIds:[t],deviceTrackingStatus:hi},r}function Ac(r){var s;const e=r.device_id;return{userId:r.user_id,deviceId:e,ed25519Key:r.keys[`ed25519:${e}`],curve25519Key:r.keys[`curve25519:${e}`],algorithms:r.algorithms,displayName:(s=r.unsigned)==null?void 0:s.device_display_name}}class xc{constructor({storage:e,getSyncToken:t,olmUtil:s,ownUserId:i,ownDeviceId:n}){this._storage=e,this._getSyncToken=t,this._identityChangedForRoom=null,this._olmUtil=s,this._ownUserId=i,this._ownDeviceId=n}async writeDeviceChanges(e,t,s){const{userIdentities:i}=t;s.set("changed",e.length),await Promise.all(e.map(async n=>{const o=await i.get(n);o&&(s.log({l:"outdated",id:n}),o.deviceTrackingStatus=hi,i.set(o))}))}writeMemberChanges(e,t,s){return Promise.all(Array.from(t.values()).map(async i=>this._applyMemberChange(i,s)))}async trackRoom(e,t){if(e.isTrackingMembers||!e.isEncrypted)return;const s=await e.loadMemberList(t);try{const i=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities]);let n;try{n=e.writeIsTrackingMembers(!0,i);const o=Array.from(s.members.values());t.set("members",o.length),await this._writeJoinedMembers(o,i)}catch(o){throw i.abort(),o}await i.complete(),e.applyIsTrackingMembersChanges(n)}finally{s.release()}}async _writeJoinedMembers(e,t){await Promise.all(e.map(async s=>{s.membership==="join"&&await this._writeMember(s,t)}))}async _writeMember(e,t){const{userIdentities:s}=t,i=await s.get(e.userId),n=$n(i,e.userId,e.roomId);n&&s.set(n)}async _removeRoomFromUserIdentity(e,t,s){const{userIdentities:i,deviceIdentities:n}=s,o=await i.get(t);o&&(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(i.remove(t),n.removeAllForUser(t)):i.set(o))}async _applyMemberChange(e,t){if(e.hasJoined)await this._writeMember(e.member,t);else if(e.hasLeft){const{roomId:s}=e;if(e.userId===this._ownUserId){const i=await t.roomMembers.getAllUserIds(s);await Promise.all(i.map(n=>this._removeRoomFromUserIdentity(s,n,t)))}else await this._removeRoomFromUserIdentity(s,e.userId,t)}}async _queryKeys(e,t,s){const i=await t.queryKeys({timeout:1e4,device_keys:e.reduce((c,l)=>(c[l]=[],c),{}),token:this._getSyncToken()},{log:s}).response(),n=s.wrap("verify",c=>this._filterVerifiedDeviceKeys(i.device_keys,c)),o=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceIdentities]);let a;try{a=(await Promise.all(n.map(async({userId:l,verifiedKeys:h})=>{const d=h.map(Ac);return await this._storeQueriedDevicesForUserId(l,d,o)}))).reduce((l,h)=>l.concat(h),[]),s.set("devices",a.length)}catch(c){throw o.abort(),c}return await o.complete(),a}async _storeQueriedDevicesForUserId(e,t,s){const i=await s.deviceIdentities.getAllDeviceIds(e);for(const c of i)t.every(l=>l.deviceId!==c)&&s.deviceIdentities.remove(e,c);const n=[],o=[];await Promise.all(t.map(async c=>{if(i.includes(c.deviceId)){const l=await s.deviceIdentities.get(c.userId,c.deviceId);if(l.ed25519Key!==c.ed25519Key){n.push(l);return}}n.push(c),o.push(c)}));for(const c of o)s.deviceIdentities.set(c);const a=await s.userIdentities.get(e);return a.deviceTrackingStatus=Dr,s.userIdentities.set(a),n}_filterVerifiedDeviceKeys(e,t){const s=new Set;return Object.entries(e).map(([n,o])=>{const c=Object.entries(o).filter(([l,h])=>{var b,S;const d=h.device_id;if(h.user_id!==n||d!==l)return!1;const p=(b=h.keys)==null?void 0:b[`ed25519:${l}`],_=(S=h.keys)==null?void 0:S[`curve25519:${l}`];if(typeof p!="string"||typeof _!="string")return!1;if(s.has(_))return t.log({l:"ignore device with duplicate curve25519 key",keys:h},t.level.Warn),!1;s.add(_);const g=this._hasValidSignature(h,t);return g||t.log({l:"ignore device with invalid signature",keys:h},t.level.Warn),g}).map(([,l])=>l);return{userId:n,verifiedKeys:c}})}_hasValidSignature(e,t){var o;const s=e.device_id,i=e.user_id,n=(o=e==null?void 0:e.keys)==null?void 0:o[`${Tn}:${s}`];return Mn(this._olmUtil,i,s,n,e,t)}async devicesForTrackedRoom(e,t,s){const i=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),n=await i.roomMembers.getAllUserIds(e);return await this._devicesForUserIds(e,n,i,t,s)}async devicesForRoomMembers(e,t,s,i){const n=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIds(e,t,n,s,i)}async _devicesForUserIds(e,t,s,i,n){const a=(await Promise.all(t.map(g=>s.userIdentities.get(g)))).filter(g=>g&&g.roomIds.includes(e)),c=a.filter(g=>g.deviceTrackingStatus===Dr),l=a.filter(g=>g.deviceTrackingStatus===hi);n.set("uptodate",c.length),n.set("outdated",l.length);let h;l.length&&(h=await this._queryKeys(l.map(g=>g.userId),i,n));const d=await this._storage.readTxn([this._storage.storeNames.deviceIdentities]);let p=(await Promise.all(c.map(g=>d.deviceIdentities.getAllForUserId(g.userId)))).reduce((g,b)=>g.concat(b),[]);return h&&h.length&&(p=p.concat(h)),p.filter(g=>!(g.userId===this._ownUserId&&g.deviceId===this._ownDeviceId))}async getDeviceByCurve25519Key(e,t){return await t.deviceIdentities.getByCurve25519Key(e)}}const qn=[Dc,Lc,Oc,Uc,Pc,Vc,Bc,Fc,Kc,$c,qc,jc,Wc,Hc,zc,Gc];function Nc(r){return{databaseName:r.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}}}function Dc(r){r.createObjectStore("session",{keyPath:"key"}),r.createObjectStore("roomSummary",{keyPath:"roomId"}),r.createObjectStore("timelineFragments",{keyPath:"key"}),r.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),r.createObjectStore("roomState",{keyPath:"key"}),r.createObjectStore("pendingEvents",{keyPath:"key"})}async function Lc(r,e){const t=new Kn(r.createObjectStore("roomMembers",{keyPath:"key"})),s=e.objectStore("roomState");await U(s.openCursor(),i=>{if(i.event.type===oe){s.delete(i.key);const n=x.fromMemberEvent(i.roomId,i.event);n&&t.set(n.serialize())}return be})}async function Oc(r,e,t){const s=e.objectStore("session");try{const n=await z(s.get(1));if(n){s.delete(1);const{syncToken:o,syncFilterId:a,serverVersions:c}=n.value,l=new Ri(s,t);l.set("sync",{token:o,filterId:a}),l.set("serverVersions",c)}}catch(i){e.abort(),console.error("could not migrate session",i.stack)}}function Uc(r){r.createObjectStore("userIdentities",{keyPath:"userId"}),r.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),r.createObjectStore("olmSessions",{keyPath:"key"}),r.createObjectStore("inboundGroupSessions",{keyPath:"key"}),r.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),r.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),r.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function Pc(r,e){var n;const t=e.objectStore("roomSummary"),s=e.objectStore("roomState"),i=[];await U(t.openCursor(),o=>(i.push(o),be));for(const o of i){const a=await z(s.get(`${o.roomId}|m.room.encryption|`));a&&(o.encryption=(n=a==null?void 0:a.event)==null?void 0:n.content,delete o.isEncrypted,t.put(o))}}function Vc(r){r.createObjectStore("accountData",{keyPath:"type"})}function Bc(r){r.createObjectStore("invites",{keyPath:"roomId"})}function Fc(r){r.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function Kc(r,e){try{const t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await U(t.openCursor(),(s,i,n)=>{const{typeScopeKey:o}=s;delete s.typeScopeKey;const[a,c]=o.split("|");return s.scopeTypeKey=Ut(c,a),n.update(s),be}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function $c(r){r.createObjectStore("timelineRelations",{keyPath:"key"})}async function qc(r,e,t,s){const i=e.objectStore("roomSummary"),n=[];await U(i.openCursor(),l=>(l.isTrackingMembers&&n.push(l.roomId),be));const o=e.objectStore("outboundGroupSessions"),a=e.objectStore("userIdentities"),c=e.objectStore("roomMembers");for(const l of n){let h=!1;const d=[],m=IDBKeyRange.bound(l,`${l}|${F}`,!0,!0);await s.wrap({l:"room",id:l},async p=>{var _;await U(c.openCursor(m),g=>(g.membership==="join"&&d.push(g.userId),be)),p.set("joinedUserIds",d.length);for(const g of d){const b=await z(a.get(g)),S=(_=b==null?void 0:b.roomIds)==null?void 0:_.length,T=$n(b,g,l);T&&(p.log({l:"fixing up",id:g,roomsBefore:S,roomsAfter:T.roomIds.length}),a.put(T),h=!0)}p.set("foundMissing",h),h&&o.delete(l)})}}async function jc(r,e){const t=e.objectStore("session"),s=await z(t.get("ssssKey"));s&&t.put({key:`${ie}ssssKey`,value:s.value})}async function Wc(r,e,t,s){const i=e.objectStore("session"),n=new Ri(new Vn(i,Nc(r)),t);n.writeE2EEIdentityToLocalStorage();const o=await n.tryRestoreE2EEIdentityFromLocalStorage(s);s.set("restored",o)}async function Hc(r,e){for(const t of r.objectStoreNames){const s=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await U(s.openCursor(),(i,n,o)=>(n.startsWith(ie)||o.delete(),be));break}default:{s.clear();break}}}}async function zc(r,e,t,s){e.objectStore("inboundGroupSessions").createIndex("byBackup","backup",{unique:!1})}async function Gc(r,e,t,s){const i=e.objectStore("inboundGroupSessions");let n=0,o=0;await U(i.openCursor(),(a,c,l)=>(a.session?(a.backup=Ds.NotBackedUp,a.source=Xt.DeviceMessage,l.update(a),n+=1):o+=1,be)),s.set("countWithoutSession",o),s.set("countWithSession",n)}async function Jc(r){const e="hydrogen_webkit_test_inactive_txn_bug";try{const t=await ki(e,n=>{n.createObjectStore("test",{keyPath:"key"})},1,r),s=t.transaction(["test"],"readonly");await z(s.objectStore("test").get("somekey")),await new Promise(n=>setTimeout(n,0));const i=t.transaction(["test"],"readwrite");await Promise.resolve(),i.objectStore("test").add({key:"somekey",value:"foo"}),await zt(i),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}const jn=r=>`hydrogen_session_${r}`,Xs=function(r,e,t,s){const i=(n,o,a,c)=>Xc(n,o,a,c,t,s);return ki(jn(r),i,qn.length,e)};async function Qc(){var e,t;const r=this;if((t=(e=r==null?void 0:r.navigator)==null?void 0:e.storage)!=null&&t.persist)return await r.navigator.storage.persist();if(r!=null&&r.document.requestStorageAccess)try{return await r.document.requestStorageAccess(),!0}catch{return!1}else return!1}class Yc{constructor(e,t=window.indexedDB,s=window.IDBKeyRange,i=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=s,this._localStorage=i}async create(e,t){var n;await((n=this._serviceWorkerHandler)==null?void 0:n.preventConcurrentSessionAccess(e)),Qc().then(o=>{o||console.warn("no persisted storage, database can be evicted by browser")});const s=await Jc(this._idbFactory),i=await Xs(e,this._idbFactory,this._localStorage,t);return new Cc(i,this._idbFactory,this._IDBKeyRange,s,this._localStorage,t.logger)}delete(e){const t=jn(e),s=this._idbFactory.deleteDatabase(t);return z(s)}async export(e,t){const s=await Xs(e,this._idbFactory,this._localStorage,t);return await Tc(s)}async import(e,t,s){const i=await Xs(e,this._idbFactory,this._localStorage,s);return await Mc(i,t)}}async function Xc(r,e,t,s,i,n){const o=t||0;return n.wrap({l:"storage migration",oldVersion:t,version:s},async a=>{for(let c=o;c<s;++c){const l=qn[c];await a.wrap(`v${c+1}`,h=>l(r,e,i,h))}})}class Wn{constructor({roomId:e,ownUserId:t,fragmentIdComparer:s}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=s}async writeRelation(e,t,s){const{relatedEventId:i}=e;if(i){const n=qe(e.event);n&&n.rel_type&&t.timelineRelations.add(this._roomId,n.event_id,n.rel_type,e.id);const o=await t.timelineEvents.getByEventId(this._roomId,i);if(o){const a=await this._applyRelation(e,o,t,s);if(a)return a.map(c=>(t.timelineEvents.update(c),new ne(c,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,s,i){const n=new ne(e,this._fragmentIdComparer),o=await this.writeRelation(n,s,i);if(t.isBackward&&!ai(e.event)){const a=await s.timelineRelations.getAllForTarget(this._roomId,n.id);if(a.length)for(const c of a){const l=await s.timelineEvents.getByEventId(this._roomId,c.sourceEventId);if(l){const h=new ne(l,this._fragmentIdComparer);await this._applyRelation(h,e,s,i)}}}return o}async _applyRelation(e,t,s,i){if(e.eventType===fe)return i.wrap("redact",async n=>{const o=t.event,a=qe(o);if(this._applyRedaction(e.event,t,s,n)){const l=[t];if(a){const h=await this._reaggregateRelation(o,a,s,n);h&&l.push(h)}return l}return null});{const n=qe(e.event);if(n&&!ai(t.event)&&n.rel_type===We&&i.wrap("react",c=>this._aggregateAnnotation(e.event,t,c)))return[t]}return null}_applyRedaction(e,t,s,i){const n=t.event;i.set("redactionId",e.event_id),i.set("id",n.event_id);const o=qe(n);return o&&o.rel_type&&s.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,n.event_id),s.timelineRelations.removeAllForTarget(this._roomId,n.event_id),za(e,n),delete t.annotations,!0}_aggregateAnnotation(e,t){const s=qe(e);if(!s)return!1;let{annotations:i}=t;i||(t.annotations=i={});let n=i[s.key];n||(i[s.key]=n={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const o=e.sender===this._ownUserId;return n.me=n.me||o,n.count+=1,n.firstTimestamp=Math.min(n.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,s,i){return t.rel_type===We?i.wrap("reaggregate annotations",n=>this._reaggregateAnnotation(t.event_id,t.key,s,n)):null}async _reaggregateAnnotation(e,t,s,i){const n=await s.timelineEvents.getByEventId(this._roomId,e);if(!n||!n.annotations)return null;i.set("id",e);const o=await s.timelineRelations.getForTargetAndType(this._roomId,e,We);return i.set("relations",o.length),delete n.annotations[t],Zc(n.annotations)&&delete n.annotations,await Promise.all(o.map(async a=>{const c=await s.timelineEvents.getByEventId(this._roomId,a.sourceEventId);c||i.log({l:"missing annotation",id:a.sourceEventId}),qe(c.event).key===t&&this._aggregateAnnotation(c.event,n,i)})),n}}function Zc(r){for(const e in r)if(r.hasOwnProperty(e))return!1;return!0}class Ae{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?Ae.Backward:Ae.Forward}static get Forward(){return el}static get Backward(){return tl}}const el=new Ae(!0),tl=new Ae(!1);class ce extends Nn{constructor(e,t,s){super(s),this._fragment=e,this._isFragmentStart=t}static start(e,t){return new ce(e,!0,t)}static end(e,t){return new ce(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?O.minStorageKey:O.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return Ii(this.linkedFragmentId)}get direction(){return this.started?Ae.Backward:Ae.Forward}withUpdatedFragment(e){return new ce(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new ce(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}function sl(r){const e=new Set;return r.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}class il{constructor({roomId:e,fragmentIdComparer:t,memberWriter:s,relationWriter:i}){this._roomId=e,this._memberWriter=s,this._relationWriter=i,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s){const[i]=await e.timelineEvents.lastEvents(this._roomId,s.id,1),n=i?i.eventIndex:B.defaultLiveKey.eventIndex;this._lastLiveKey=new B(s.id,n)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s)return s;{t||(t=null);const i={roomId:this._roomId,id:B.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(i),this._fragmentIdComparer.add(i),i}}async _replaceLiveFragment(e,t,s,i){const n=await i.timelineFragments.get(this._roomId,e);if(!n)throw new Error(`old live fragment doesn't exist: ${e}`);n.nextId=t,i.timelineFragments.update(n);const o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:s,nextToken:null};return i.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:n,newFragment:o}}async _ensureLiveFragment(e,t,s,i,n){if(e){if(s.limited){const o=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:a,newFragment:c}=await this._replaceLiveFragment(o,e.fragmentId,s.prev_batch,i);t.push(ce.end(a,this._fragmentIdComparer)),t.push(ce.start(c,this._fragmentIdComparer)),n.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(i,s.prev_batch);e=new B(o.id,B.defaultLiveKey.eventIndex),t.push(ce.start(o,this._fragmentIdComparer)),n.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,s){let i=0;for(const n of e)n.type!==oe&&(t.roomState.set(this._roomId,n),i+=1);s.set("stateEvents",i)}async _writeTimeline(e,t,s,i,n,o){const a=[],c=[];if(e!=null&&e.length){i=await this._ensureLiveFragment(i,a,t,n,o),o.set("timelineEvents",e.length);let l=0;for(const h of e){i=i.nextKey();const d=On(i,this._roomId,h);let m=await s.lookupMemberAtEvent(h.sender,h,n);if(m&&(d.displayName=m.displayName,d.avatarUrl=m.avatarUrl),!await n.timelineEvents.tryInsert(d,o))continue;const _=new ne(d,this._fragmentIdComparer);a.push(_);const g=await this._relationWriter.writeRelation(_,n,o);g&&c.push(...g),typeof h.state_key=="string"&&h.type!==oe&&(l+=1,n.roomState.set(this._roomId,h))}o.set("timelineStateEventCount",l)}return{currentKey:i,entries:a,updatedEntries:c}}async _handleRejoinOverlap(e,t,s){if(this._lastLiveKey){const{fragmentId:i}=this._lastLiveKey,[n]=await t.timelineEvents.lastEvents(this._roomId,i,1);if(n){const o=n.event.event_id,{events:a}=e,c=a.findIndex(l=>l.event_id===o);if(c!==-1)return s.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(c+1)})}}return e.limited?e:(s.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,s,i,n){let{timeline:o}=e;n.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,i,n));let a;Array.isArray(o==null?void 0:o.events)&&(a=sl(o.events));const{state:c}=e;let l;Array.isArray(c==null?void 0:c.events)&&(l=c.events);const h=this._memberWriter.prepareMemberSync(l,a,s);l&&await this._writeStateEvents(l,i,n);const{currentKey:d,entries:m,updatedEntries:p}=await this._writeTimeline(a,o,h,this._lastLiveKey,i,n),_=await h.write(i);return{entries:m,updatedEntries:p,newLiveKey:d,memberChanges:_}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class Hn{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let s=t?this._entries.findIndex(t):-1;this._entries.unshift(e),s===-1?this._entries.length>this.limit&&(s=this._entries.length-1):s+=1,s!==-1&&(this.onEvictEntry(this._entries[s]),this._entries.splice(s,1))}onEvictEntry(e){}}class rl extends Hn{constructor(e,t){super(e),this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){const t=this._keyFn(e);this._set(e,s=>this._keyFn(s)===t)}}class nl{constructor(e){this._roomId=e,this._cache=new rl(5,t=>t.userId)}prepareMemberSync(e,t,s){return new ol(this,e,t,s)}async _writeMember(e,t){let s=this._cache.get(e.userId);if(!s){const i=await t.roomMembers.get(this._roomId,e.userId);i&&(s=new x(i))}if(!s||!s.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new Un(e,s==null?void 0:s.membership)}async lookupMember(e,t){let s=this._cache.get(e);if(!s){const i=await t.roomMembers.get(this._roomId,e);i&&(s=new x(i),this._cache.set(s))}return s}}class ol{constructor(e,t,s,i){this._memberWriter=e,this._timelineEvents=s,this._hasFetchedMembers=i,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const s of e)if(s.type===oe){const i=x.fromMemberEvent(this._roomId,s);i&&(t||(t=new Map),t.set(i.userId,i))}return t}_timelineEventsToMembers(e){let t;for(let s=e.length-1;s>=0;s--){const i=e[s],n=i.state_key;if(i.type===oe&&!(t!=null&&t.has(n))){const o=x.fromMemberEvent(this._roomId,i);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,s){var n;let i;return this._timelineEvents&&(i=this._findPrecedingMemberEventInTimeline(e,t),i)||(i=(n=this._newStateMembers)==null?void 0:n.get(e),i)?i:await this._memberWriter.lookupMember(e,s)}async write(e){const t=new Map;let s;if(this._timelineEvents&&(s=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(const i of this._newStateMembers.values())if(!(s!=null&&s.has(i.userId))){const n=await this._memberWriter._writeMember(i,e);n&&(!this._hasFetchedMembers&&!n.previousMembership&&(n.previousMembership=i.membership),t.set(n.userId,n))}}if(s)for(const i of s.values()){const n=await this._memberWriter._writeMember(i,e);n&&t.set(n.userId,n)}return t}_findPrecedingMemberEventInTimeline(e,t){let s=-1;for(let i=this._timelineEvents.length-1;i>=0;i--)if(this._timelineEvents[i].event_id===t.event_id){s=i;break}for(let i=s-1;i>=0;i--){const n=this._timelineEvents[i];if(n.type===oe&&n.state_key===e){const o=x.fromMemberEvent(this._roomId,n);if(o)return o}}}}class al{constructor({roomId:e,storage:t,fragmentIdComparer:s,relationWriter:i}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._relationWriter=i}async _findOverlappingEvents(e,t,s,i){const n=t.map(l=>l.event_id),o=await s.timelineEvents.getEventKeysForIds(this._roomId,n);i.set("existingEvents",o.size);const a=t.filter(l=>!o.has(l.event_id));i.set("nonOverlappingEvents",a.length);let c;if(e.hasLinkedFragment){i.set("linkedFragmentId",e.linkedFragmentId);for(const l of o.values())if(l.fragmentId===e.linkedFragmentId){i.set("foundLinkedFragment",!0);const h=await s.timelineFragments.get(this._roomId,e.linkedFragmentId);c=e.createNeighbourEntry(h);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:c}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:s,direction:i}=e,n=await this._findFragmentEdgeEvent(s,i,t);return n?new B(n.fragmentId,n.eventIndex):B.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,s){if(t.isBackward){const[i]=await s.timelineEvents.firstEvents(this._roomId,e,1);return i}else{const[i]=await s.timelineEvents.lastEvents(this._roomId,e,1);return i}}async _storeEvents(e,t,s,i,n,o){const a=[],c=[];let l=t;for(let h=0;h<e.length;++h){const d=e[h];l=l.nextKeyForDirection(s);const m=On(l,this._roomId,d),p=this._findMember(d.sender,i,e,h,s);p&&(m.displayName=p.displayName,m.avatarUrl=p.avatarUrl);const _=await this._relationWriter.writeGapRelation(m,s,n,o);if(_&&c.push(..._),await n.timelineEvents.tryInsert(m,o)){const g=new ne(m,this._fragmentIdComparer);Kt(a,g,s)}}return{entries:a,updatedEntries:c}}_findMember(e,t,s,i,n){function o(l){return l.type===oe&&l.state_key===e}const a=n.isBackward?1:-1;for(let l=i+a;l>=0&&l<s.length;l+=a){const h=s[l];if(o(h))return x.fromMemberEvent(this._roomId,h)}for(let l=i;l>=0&&l<s.length;l-=a){const h=s[l];if(o(h))return x.fromReplacingMemberEvent(this._roomId,h)}const c=t==null?void 0:t.find(o);if(c)return x.fromMemberEvent(this._roomId,c)}async _updateFragments(e,t,s,i,n,o){const{direction:a}=e,c=[];return Kt(i,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,n.timelineFragments.update(t.fragment),Kt(i,t,a),c.push(e.fragment),c.push(t.fragment)):e.token=s,n.timelineFragments.update(e.fragment),c}async writeFragmentFill(e,t,s,i){const{fragmentId:n,direction:o}=e,{chunk:a,start:c,state:l}=t;let{end:h}=t;if(!Array.isArray(a))throw new Error("Invalid chunk in response");if(typeof h!="string"&&typeof h!="undefined")throw new Error("Invalid end token in response");const d=await s.timelineFragments.get(this._roomId,n);if(!d)throw new Error(`Unknown fragment: ${n}`);if(e=e.withUpdatedFragment(d),e.token!==c)throw new Error("start is not equal to prev_batch or next_batch");if(a.length===0)return e.edgeReached=!0,await s.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let m=await this._findFragmentEdgeEventKey(e,s);i.set("lastKey",m.toString());const{nonOverlappingEvents:p,neighbourFragmentEntry:_}=await this._findOverlappingEvents(e,a,s,i),{entries:g,updatedEntries:b}=await this._storeEvents(p,m,o,l,s,i),S=await this._updateFragments(e,_,h,g,s,i);return{entries:g,updatedEntries:b,fragments:S}}}class Et extends wi{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t,this)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s,this)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t,this)}emitMove(e,t,s){for(let i of this._handlers)i.onMove(e,t,s,this)}}/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function He(r,e,t){let s=0,i=r.length;for(;s<i;){let n=s+i>>>1,o=t(e,r[n]);o>0?s=n+1:o<0?i=n:s=i=n}return i}class kt extends wi{emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t)}}class $t extends kt{constructor(e){super(),this._values=new Map(e)}update(e,t){const s=this._values.get(e);return s!==void 0?(this._values.set(e,s),this.emitUpdate(e,s,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e,void 0)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class cl extends Et{constructor(e,t){super(),this._sourceMap=e,this._comparator=(s,i)=>t(s.value,i.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const s={key:e,value:t},i=He(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,0,s),this.emitAdd(i,t)}onRemove(e,t){const s={key:e,value:t},i=He(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,1),this.emitRemove(i,t)}onUpdate(e,t,s){if(!this._sortedPairs)return;const i=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(i,1);const n={key:e,value:t},o=He(this._sortedPairs,n,this._comparator);this._sortedPairs.splice(o,0,n),i!==o&&this.emitMove(i,o,t),this.emitUpdate(o,t,s)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,s]of this._sourceMap)this._sortedPairs[e]={key:t,value:s},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class ll extends kt{constructor(e,t){super(),this._source=e,this._filter=t,this._included=null,this._subscription=null}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){const t=this._included;this._included=this._included||new Map;for(const[s,i]of this._source){const n=this._filter(i,s);if(this._included.set(s,n),!e){const o=t?t.get(s):!0;this._emitForUpdate(o,n,s,i)}}}else{if(this._included&&!e)for(const[t,s]of this._source)this._included.get(t)||this.emitAdd(t,s);this._included=null}}onAdd(e,t){if(this._filter){const s=this._filter(t,e);if(this._included.set(e,s),!s)return}this.emitAdd(e,t)}onRemove(e,t){const s=!this._filter||this._included.get(e);this._included.delete(e),s&&this.emitRemove(e,t)}onUpdate(e,t,s){if(!!this._included)if(this._filter){const i=this._included.get(e),n=this._filter(t,e);this._included.set(e,n),this._emitForUpdate(i,n,e,t,s)}else this.emitUpdate(e,t,s)}_emitForUpdate(e,t,s,i,n=null){e&&!t?this.emitRemove(s,i):!e&&t?this.emitAdd(s,i):e&&t&&this.emitUpdate(s,i,n)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=null,this._subscription=this._subscription()}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new hl(this._source,this._included)}get size(){let e=0;return this._included.forEach(t=>{t&&(e+=1)}),e}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class hl{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(;;){const e=this._sourceIterator.next();if(e.done)return e;const t=e.value[0];if(this._included.get(t))return e}}}class dl extends kt{constructor(e,t,s){super(),this._source=e,this._mapper=t,this._updater=s,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const s=this._mappedValues.get(e);s&&this.emitUpdate(e,s,t)}onAdd(e,t){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i),this.emitAdd(e,i)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&this.emitRemove(e,t)}onUpdate(e,t,s){var n;if(!this._mappedValues)return;const i=this._mappedValues.get(e);i!==void 0&&((n=this._updater)==null||n.call(this,i,s,t),this.emitUpdate(e,i,s))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription(),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class ul extends kt{constructor(e){super(),this._sources=e,this._subscriptions=null}onAdd(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitRemove(t,i),this.emitAdd(t,s)}}onRemove(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,s);const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitAdd(t,i)}}onUpdate(e,t,s,i){!this._subscriptions||this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,s,i)}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new pl(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const s=this._sources.indexOf(e);for(let i=0;i<s;i+=1)if(this._sources[i].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){const s=this._sources.indexOf(e);for(let i=s+1;i<this._sources.length;i+=1){const o=this._sources[i].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){super.onUnsubscribeLast();for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new ml(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(const t of this._sources){const s=t.get(e);if(s)return s}return null}}class ml{constructor(e){this._sources=e,this._sourceIndex=-1,this._currentIterator=null,this._encounteredKeys=new Set}next(){let e;for(;!e;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const t=this._currentIterator.next();if(t.done){this._currentIterator=null;continue}else{const s=t.value[0];this._encounteredKeys.has(s)||(this._encounteredKeys.add(s),e=t)}}return e}}class pl{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=null}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription=this._subscription()}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,s){this._joinedMap.onUpdate(this._source,e,t,s)}onReset(){this._joinedMap.onReset(this._source)}}class _l extends Et{constructor(e=[]){super(),this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let s of t)this.insert(e,s),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[s]=this._items.splice(e,1);this._items.splice(t,0,s),this.emitMove(e,t,s)}}update(e,t,s=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,s))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function zn(r,e,t,s){const i=e.findIndex(r);if(i!==-1){const n=e[i],o=s(n);return o!==!1&&t.emitUpdate(i,n,o),!0}return!1}class Ci extends Et{constructor(e){super(),this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return zn(e,this._items,this,t)}getAndUpdate(e,t,s=null){const i=this.indexOf(e);if(i!==-1){const n=this._items[i],o=t(n,e);this._items[i]=o,this.emitUpdate(i,o,s)}}update(e,t=null){const s=this.indexOf(e);s!==-1&&(this._items[s]=e,this.emitUpdate(s,e,t))}indexOf(e){const t=He(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=He(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const s=He(this._items,e,this._comparator);s>=this._items.length||this._comparator(this._items[s],e)!==0?(this._items.splice(s,0,e),this.emitAdd(s,e)):(this._items[s]=e,this.emitUpdate(s,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new gl(this)}}class gl{constructor(e){this._sortedArray=e,this._current=null}next(){if(this._sortedArray){if(this._current?this._current=this._sortedArray._getNext(this._current):this._current=this._sortedArray.get(0),this._current)return{value:this._current};this._sortedArray=null}if(!this._sortedArray)return{done:!0}}}class fl extends Et{constructor(e,t,s,i){super(),this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=s,this._removeCallback=i}findAndUpdate(e,t){return zn(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}function yl(r,e,t){r._mappedValues.splice(e,0,t),r.emitAdd(e,t)}function wl(r,e,t,s){const i=r._mappedValues[e];r._updater&&r._updater(i,s,t),r.emitUpdate(e,i,s)}function vl(r,e){const t=r._mappedValues[e];r._mappedValues.splice(e,1),r._removeCallback&&r._removeCallback(t),r.emitRemove(e,t)}function bl(r,e,t){const s=r._mappedValues[e];r._mappedValues.splice(e,1),r._mappedValues.splice(t,0,s),r.emitMove(e,t,s)}function Sl(r){r._mappedValues=[],r.emitReset()}class Il extends fl{constructor(){super(...arguments),this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new Lr(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new Cl),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new Lr(e,t)),this._flush())}onUpdate(e,t,s){this._eventQueue&&(this._eventQueue.push(new El(e,t,s)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new kl(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new Rl(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class Lr{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);yl(e,this.index,t)}}class El{constructor(e,t,s){this.index=e,this.value=t,this.params=s}async run(e){wl(e,this.index,this.value,this.params)}}class kl{constructor(e){this.index=e}async run(e){vl(e,this.index)}}class Rl{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){bl(e,this.fromIdx,this.toIdx)}}class Cl{async run(e){Sl(e)}}class Tl extends Et{constructor(...e){super(),this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let s=0;for(let i=0;i<t;++i)s+=this._sourceLists[i].length;return s}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,s){this.emitAdd(this._offsetForSource(s)+e,t)}onUpdate(e,t,s,i){!this._sourceUnsubscribes||this.emitUpdate(this._offsetForSource(i)+e,t,s)}onRemove(e,t,s){this.emitRemove(this._offsetForSource(s)+e,t)}onMove(e,t,s,i){const n=this._offsetForSource(i);this.emitMove(n+e,n+t,s)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let s=t.next();for(;s.done;){if(e+=1,e>=this._sourceLists.length)return s;t=this._sourceLists[e][Symbol.iterator](),s=t.next()}return s}}}}Object.assign(kt.prototype,{sortValues(r){return new cl(this,r)},mapValues(r,e){return new dl(this,r,e)},filterValues(r){return new ll(this,r)},join(...r){return new ul([this].concat(r))}});function Zs(r){typeof r=="function"?r():r.dispose()}function Ml(r){return r&&(typeof r=="function"||typeof r.dispose=="function")}class Ti{constructor(){this._disposables=[]}track(e){if(!Ml(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),Zs(e),e):(this._disposables.push(e),e)}untrack(e){if(this.isDisposed){console.warn("Disposables already disposed, cannot untrack");return}const t=this._disposables.indexOf(e);t>=0&&this._disposables.splice(t,1)}dispose(){if(this._disposables){for(const e of this._disposables)Zs(e);this._disposables=void 0}}get isDisposed(){return this._disposables===void 0}disposeTracked(e){if(e==null||this.isDisposed)return;const t=this._disposables.indexOf(e);if(t!==-1){const[s]=this._disposables.splice(t,1);Zs(s)}else console.warn("disposable not found, did it leak?",e)}}class Or{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}async function Al(r,e,t,s,i,n){let o=[];const a=n.timelineEvents,c=n.timelineFragments;for(;o.length<s&&e;){let l;t.isForward?l=await a.eventsAfter(r,e,s):l=await a.eventsBefore(r,e,s);let h=l.map(d=>new ne(d,i));if(o=ja(o,h,t),o.length<s){const d=await c.get(r,e.fragmentId);let m=new ce(d,t.isBackward,i);if(Kt(o,m,t),!m.token&&m.hasLinkedFragment){const p=await c.get(r,m.linkedFragmentId);i.add(p);const _=new ce(p,t.isForward,i);Kt(o,_,t),e=_.asEventKey()}else e=null}}return o}class Gn{constructor({roomId:e,storage:t,fragmentIdComparer:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,s,i){return new Or(async(n,o)=>{const a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,s,n,a,o)},i)}readFromEnd(e,t=null,s){return new Or(async(i,n)=>{const o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId);let c;if(!a)c=[];else{this._fragmentIdComparer.add(a);const l=ce.end(a,this._fragmentIdComparer),h=l.asEventKey();c=await this._readFrom(h,Ae.Backward,e,i,o,n),c.unshift(l)}return c},s)}async readById(e,t){let s=[this._storage.storeNames.timelineEvents];this._decryptEntries&&s.push(this._storage.storeNames.inboundGroupSessions);const i=await this._storage.readTxn(s),n=await i.timelineEvents.getByEventId(this._roomId,e);if(n){const o=new ne(n,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o],i,t).complete(),o}}async _readFrom(e,t,s,i,n,o){const a=await Al(this._roomId,e,t,s,this._fragmentIdComparer,n);if(this._decryptEntries){i.decryptRequest=this._decryptEntries(a,n,o);try{await i.decryptRequest.complete()}finally{i.decryptRequest=null}}return a}}class xl extends ne{get fragmentId(){throw new Error("Cannot access fragmentId for non-persisted EventEntry")}get entryIndex(){throw new Error("Cannot access entryIndex for non-persisted EventEntry")}get isNonPersisted(){return!0}get isRedacting(){return!1}get isRedacted(){return super.isRedacting}}class Nl{constructor(e){this._userId=e}get id(){return this._userId}}class ks{constructor({roomId:e,storage:t,closeCallback:s,fragmentIdComparer:i,pendingEvents:n,clock:o,powerLevelsObservable:a,hsApi:c}){this._roomId=e,this._storage=t,this._closeCallback=s,this._fragmentIdComparer=i,this._disposables=new Ti,this._pendingEvents=n,this._clock=o,this._remoteEntries=new Ci((l,h)=>l.compare(h)),this._ownMember=null,this._timelineReader=new Gn({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this._contextEntriesNotInTimeline=new Map,this._decryptEntries=null,this._hsApi=c,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,s){const i=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),n=await i.roomMembers.get(this._roomId,e.id);n?this._ownMember=new x(n):this._ownMember=x.fromUserId(this._roomId,e.id,t);const o=this._disposables.track(this._timelineReader.readFromEnd(20,i,s));try{const a=await o.complete();this._loadContextEntriesWhereNeeded(a),this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new Il(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,s)=>{t.notifyUpdate(s)},t=>this._applyAndEmitLocalRelationChange(t,s=>s.removeLocalRelation(t))):this._localEntries=new _l,this._allEntries=new Tl(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===fe&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const s=new $a({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._loadContextEntriesWhereNeeded([s]),this._applyAndEmitLocalRelationChange(s,i=>i.addLocalRelation(s)),s}_applyAndEmitLocalRelationChange(e,t){var i,n;const s=o=>{const a=t(o);return a||!1};if(this._findAndUpdateEntryById(e.pendingEvent.relatedTxnId,e.relatedEventId,s),e.redactingEntry){const o=(i=e.redactingEntry.pendingEvent)==null?void 0:i.relatedTxnId;this._findAndUpdateEntryById(o,e.redactingEntry.relatedEventId,s),(n=e.redactingEntry.contextForEntries)==null||n.forEach(a=>this._emitUpdateForEntry(a,"contextEntry"))}}_findAndUpdateEntryById(e,t,s){let i=!1;e&&(i=this._localEntries.findAndUpdate(n=>n.id===e,s)),!i&&t&&this._remoteEntries.findAndUpdate(n=>n.id===t,s)}async getOwnAnnotationEntry(e,t){const s=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),i=await s.timelineRelations.getForTargetAndType(this._roomId,e,We);for(const n of i){const o=await s.timelineEvents.getByEventId(this._roomId,n.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&qe(o.event).key===t){const a=new ne(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){var t;if(!!((t=this._localEntries)!=null&&t.hasSubscriptions))for(const s of this._localEntries){if(s.relatedEventId){const i=e.find(n=>n.id===s.relatedEventId);i==null||i.addLocalRelation(s)}if(s.redactingEntry){const i=s.redactingEntry.relatedEventId,n=e.find(o=>o.id===i);n==null||n.addLocalRelation(s)}}}static _entryUpdater(e,t){var s;return(s=e.contextForEntries)==null||s.forEach(i=>i.setContextEntry(t)),t.updateFrom(e),t}replaceEntries(e){var t;this._addLocalRelationsToNewRemoteEntries(e);for(const s of e)try{this._remoteEntries.getAndUpdate(s,ks._entryUpdater);const i=this._contextEntriesNotInTimeline.get(s.id);i&&(ks._entryUpdater(i,s),this._contextEntriesNotInTimeline.set(s.id,s)),(t=s.contextForEntries)==null||t.forEach(n=>this._emitUpdateForEntry(n,"contextEntry"))}catch(i){if(i.name==="CompareError")continue;throw i}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._updateEntriesFetchedFromHomeserver(e),this._moveEntryToRemoteEntries(e),this._loadContextEntriesWhereNeeded(e),this._remoteEntries.setManySorted(e)}_updateEntriesFetchedFromHomeserver(e){var t;for(const s of e){const i=this._contextEntriesNotInTimeline.get(s.relatedEventId);(i==null?void 0:i.isNonPersisted)&&(i==null?void 0:i.addLocalRelation(s))&&((t=i.contextForEntries)==null||t.forEach(n=>this._emitUpdateForEntry(n,"contextEntry")))}}_moveEntryToRemoteEntries(e){for(const t of e){const s=this._contextEntriesNotInTimeline.get(t.id);s&&(s.contextForEntries.forEach(i=>{i.setContextEntry(t),this._emitUpdateForEntry(i,"contextEntry")}),this._contextEntriesNotInTimeline.delete(t.id))}}_emitUpdateForEntry(e,t){const s=e.isPending?e.id:null,i=e.isPending?null:e.id;this._findAndUpdateEntryById(s,i,()=>t)}async _loadContextEntriesWhereNeeded(e){for(const t of e){if(!t.contextEventId)continue;const s=t.contextEventId;let i=e.find(n=>n.id===s);i||(i=this._findLoadedEventById(s)),i?t.setContextEntry(i):this._loadContextEntryNotInTimeline(t)}}async _loadContextEntryNotInTimeline(e){const t=e.contextEventId;let s=await this._getEventFromStorage(t);s||(s=await this._getEventFromHomeserver(t)),s&&(this._contextEntriesNotInTimeline.set(t,s),e.setContextEntry(s),this._emitUpdateForEntry(e,"contextEntry"))}_findLoadedEventById(e){var t;return(t=this.getByEventId(e))!=null?t:this._contextEntriesNotInTimeline.get(e)}async _getEventFromStorage(e){return await this._timelineReader.readById(e)}async _getEventFromHomeserver(e){const t=await this._hsApi.context(this._roomId,e,0).response(),s=t.event.sender,i=t.state.find(a=>a.type===oe&&a.user_id===s),n={event:t.event,displayName:i.content.displayname,avatarUrl:i.content.avatar_url},o=new xl(n,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o]).complete(),o}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find(i=>!!i.eventType);if(!t)return!0;const s=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),Ae.Backward,e));try{const i=await s.complete();return this.addEntries(i),i.length<e}finally{this._disposables.disposeTracked(s)}}async _getOrLoadEntry(e,t){var s;if(e){for(const i of this._localEntries)if(i.id===e)return i}return t?(s=this.getByEventId(t))!=null?s:await this._getEventFromStorage(t):null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const s=this._remoteEntries.get(t);if(s.id===e)return s}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._decryptEntries=e,this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function Dl({roomId:r,storage:e}){return(await(await e.readTxn([e.storeNames.roomMembers])).roomMembers.getAll(r)).map(i=>new x(i))}async function Ll({summary:r,syncToken:e,roomId:t,hsApi:s,storage:i,setChangedMembersMap:n},o){const a=new Map;n(a);const c=await s.members(t,{at:e},{log:o}).response(),l=await i.readWriteTxn([i.storeNames.roomSummary,i.storeNames.roomMembers]);let h,d;try{h=r.writeHasFetchedMembers(!0,l);const{roomMembers:m}=l,p=c.chunk;if(!Array.isArray(p))throw new Error("malformed");o.set("members",p.length),d=await Promise.all(p.map(async _=>{const g=_==null?void 0:_.state_key;if(!g)throw new Error("malformed");const b=a.get(g);if(b)return b;{const S=x.fromMemberEvent(t,_);return S&&m.set(S.serialize()),S}}))}catch(m){throw l.abort(),m}finally{n(null)}return await l.complete(),r.applyChanges(h),d}async function Ol(r,e){const{summary:t}=r;return t.data.hasFetchedMembers?Dl(r):e.wrapOrRun(r.log,"fetchMembers",s=>Ll(r,s))}async function Ul(r,e){const t=await Pl(r),{summary:s}=r;return!s.data.hasFetchedMembers&&!t?e.wrapOrRun(r.log,"fetchMember",i=>Vl(r,i)):t}async function Pl({roomId:r,userId:e,storage:t}){const i=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(r,e);return i?new x(i):null}async function Vl({roomId:r,userId:e,hsApi:t,storage:s},i){let n;try{n=await t.state(r,"m.room.member",e,{log:i}).response()}catch(c){if(c.name==="HomeServerError"&&c.errcode==="M_NOT_FOUND")return null;throw c}const o=new x({roomId:r,userId:e,membership:n.membership,avatarUrl:n.avatar_url,displayName:n.displayname}),a=await s.readWriteTxn([s.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(c){throw a.abort(),c}return await a.complete(),o}class Bl{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}}class Fl extends Bl{constructor({members:e,closeCallback:t}){super(t),this._members=new $t;for(const s of e)this._members.add(s.userId,s)}afterSync(e){for(const[t,s]of e.entries())this._members.set(t,s.member)}get members(){return this._members}}function di(r,e,t){const s=e.joinCount+e.inviteCount-1;if(r.length>=s)if(r.length>1){const i=r[r.length-1];return r.slice(0,r.length-1).map(o=>o.name).join(", ")+" and "+i.name}else{const i=r[0];return i?i.name:(t.log({l:"could get get other member name",length:r.length,otherMember:!!i,otherMemberMembership:i==null?void 0:i.membership}),"Unknown DM Name")}else return r.length<s?r.map(i=>i.name).join(", ")+` and ${s} others`:null}class Mi{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,s){const i=new Map,n=[];for(const o of this._members.keys())e.indexOf(o)===-1&&n.push(o);for(const[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&i.set(o,a.member);for(const o of e)if(!this._members.has(o)&&!i.has(o)){const a=await s.roomMembers.get(this._roomId,o);if(a){const c=new x(a);i.set(c.userId,c)}}return{updatedHeroMembers:i.values(),removedUserIds:n}}applyChanges({updatedHeroMembers:e,removedUserIds:t},s,i){for(const o of t)this._members.delete(o);for(const o of e)this._members.set(o.userId,o);const n=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=di(n,s,i)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(const e of this._members.keys())return e;return null}}class Kl{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let s=this._map.get(e);return s||(s=new $l(this,t,e),this._map.set(e,s)),s}updateEvents(e){for(let t=0;t<e.length;t+=1){const s=e[t],i=this._map.get(s.id);i==null||i.update(s)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}}class $l extends It{constructor(e,t,s){super(),this._eventMap=e,this._entry=t,this._id=s,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}function ql(r){return r||ac.item}const jl="m.room.power_levels";class bs{constructor({powerLevelEvent:e,createEvent:t,ownUserId:s,membership:i}){this._plEvent=e,this._createEvent=t,this._ownUserId=s,this._membership=i}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){var t,s,i,n;if(this._plEvent){let o=(s=(t=this._plEvent.content)==null?void 0:t.users)==null?void 0:s[e];if(typeof o!="number"&&(o=(i=this._plEvent.content)==null?void 0:i.users_default),typeof o=="number")return o}else if(this._createEvent&&e===((n=this._createEvent.content)==null?void 0:n.creator))return 100;return 0}_getActionLevel(e){var s;const t=(s=this._plEvent)==null?void 0:s.content[e];return typeof t=="number"?t:50}_getEventTypeLevel(e){var s,i,n;const t=(i=(s=this._plEvent)==null?void 0:s.content.events)==null?void 0:i[e];if(typeof t=="number")return t;{const o=(n=this._plEvent)==null?void 0:n.content.events_default;return typeof o=="number"?o:0}}}const Wl="m.room.encrypted";class Jn extends Ns{constructor({roomId:e,storage:t,hsApi:s,mediaRepository:i,emitCollectionChange:n,user:o,createRoomEncryption:a,getSyncToken:c,platform:l}){super(),this._roomId=e,this._storage=t,this._hsApi=s,this._mediaRepository=i,this._summary=new Da(e),this._fragmentIdComparer=new Xa([]),this._emitCollectionChange=n,this._timeline=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=c,this._platform=l,this._observedEvents=null,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null}async _eventIdsToEntries(e,t){const s=[];return await Promise.all(e.map(async i=>{const n=await t.timelineEvents.getByEventId(this._roomId,i);n&&s.push(new ne(n,this._fragmentIdComparer))})),s}_getAdditionalTimelineRetryEntries(e,t){let s=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const i=e.reduce((n,o)=>(n.add(o.id),n),new Set);return s=s.filter(n=>!i.has(n.id)),s}async notifyRoomKey(e,t,s){var o;if(!this._roomEncryption)return;const i=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let n=await this._eventIdsToEntries(t,i);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(n,[e]);n=n.concat(a)}if(n.length){await this._decryptEntries(tt.Retry,n,i,s).complete(),(o=this._timeline)==null||o.replaceEntries(n);const c=this._summary.data.applyTimelineEntries(n,!1,!1);await this._summary.writeAndApplyData(c,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,tt.Timeline)),!0):!1}_decryptEntries(e,t,s,i=null){return new Hl(async(o,a)=>{if(s||(s=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;const c=t.filter(_=>_.eventType===Wl).map(_=>_.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(c,null,e,s),o.cancelled)return;const l=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;const h=[this._storage.storeNames.groupSessionDecryptions],d=this._isTimelineOpen;d&&h.push(this._storage.storeNames.deviceIdentities);const m=await this._storage.readWriteTxn(h);let p;try{p=await l.write(m,a),d&&await p.verifySenders(m)}catch(_){throw m.abort(),_}await m.complete(),p.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t)},ql(i))}async _getSyncRetryDecryptEntries(e,t,s){let n=(await Promise.all(e.map(async o=>{const a=await t.getEventIdsForMissingKey(o,s);if(a)return this._eventIdsToEntries(a,s)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(n,e).map(c=>c.clone());n=n.concat(a)}return n}async load(e,t,s){s.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const i=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(i)}if(this._summary.data.needsHeroes){this._heroes=new Mi(this._roomId);const i=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(i,this._summary.data,s)}}catch(i){throw new Sn(`Could not load room ${this._roomId}`,i)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const s=await Ul({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!s)return null;const i=new ri(s,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,i),i}async loadMemberList(e=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const t=await Ol({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,syncToken:this._getSyncToken(),setChangedMembersMap:s=>this._changedMembersDuringSync=s,log:e},this._platform.logger);return this._memberList=new Fl({members:t,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,s=null){return this._platform.logger.wrapOrRun(s,"fillGap",async i=>{if(i.set("id",this.id),i.set("fragment",e.fragmentId),i.set("dir",e.direction.asApiString()),e.edgeReached){i.set("edgeReached",!0);return}const n=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:i}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let a,c;try{a=await this._writeGapFill(n.chunk,o,i);const l=new Wn({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});c=await new al({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:l}).writeFragmentFill(e,n,o,i)}catch(l){throw o.abort(),l}await o.complete(),this._roomEncryption&&await this._decryptEntries(tt.Timeline,c.entries,null,i).complete();for(const l of c.fragments)this._fragmentIdComparer.add(l);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(c.updatedEntries),this._timeline.addEntries(c.entries))})}async _writeGapFill(e,t,s){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}isDirectMessageForUserId(e){if(this._summary.data.dmUserId===e)return!0;{const{heroes:t,joinCount:s,inviteCount:i}=this._summary.data;if(t&&t.includes(e)&&s+i===2)return!0}return!1}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new bs({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const s=await e.roomState.get(this._roomId,"m.room.create","");if(s)return new bs({createEvent:s.event,ownUserId:this._user.id,membership:this.membership});{const i=this.membership;return new bs({ownUserId:this._user.id,membership:i})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new ri(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableKeyBackup(e){var t;(t=this._roomEncryption)==null||t.enableKeyBackup(e),this._timeline&&e&&this._platform.logger.run("enableKeyBackup",s=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,s))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}openTimeline(e=null){return this._platform.logger.wrapOrRun(e,"open timeline",async t=>{if(t.set("id",this.id),this._timeline)throw new Error("not dealing with load race here for now");this._timeline=new ks({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels(),hsApi:this._hsApi});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,tt.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(s){throw this._timeline.dispose(),s}return this._timeline})}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new Kl(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const s=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(i=>{s.update(i)}).catch(i=>{console.warn(`could not load event ${e} from storage`,i)}),s}async _readEventById(e){return await new Gn({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}).readById(e)}dispose(){var e,t;(e=this._roomEncryption)==null||e.dispose(),(t=this._timeline)==null||t.dispose()}}class Hl{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",s=>e(this,s))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}function Rs(){const e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return"t"+"0".repeat(14-e.length)+e}function Ur(r){return r.startsWith("t")&&r.length===15}class zl{constructor({roomId:e,storage:t,hsApi:s,pendingEvents:i}){i=i||[],this._roomId=e,this._storage=t,this._hsApi=s,this._pendingEvents=new Ci((n,o)=>n.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(i.map(n=>this._createPendingEvent(n))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){const s=new qa({data:e,remove:()=>this._removeEvent(s),emitUpdate:i=>this._pendingEvents.update(s,i),attachments:t});return s}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(const s of this._pendingEvents)await t.wrap("send event",async i=>{i.set("queueIndex",s.queueIndex);try{this._currentQueueIndex=s.queueIndex,await this._sendEvent(s,i)}catch(n){n instanceof je?(this._offline=!0,i.set("offline",!0),s.setWaiting()):(i.catch(n),n.name==="HomeServerError"&&(n.statusCode===400||n.statusCode===403||n.statusCode===404)?(i.set("remove",!0),await s.abort()):s.setError(n))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",s=>e.uploadAttachments(this._hsApi,s)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const s=e.contentForEncryption,{type:i,content:n}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,s,this._hsApi,o));e.setEncrypted(i,n),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,s),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,s)}catch(i){throw s.abort(),i}await s.complete()}}async _resolveRemoteIdInPendingRelations(e,t,s){const i=this._pendingEvents.array.filter(n=>n.relatedTxnId===e&&n.relatedEventId!==t);for(const n of i)n.setRelatedEventId(t),await this._tryUpdateEventWithTxn(n,s);return i}async removeRemoteEchos(e,t,s){const i=[];for(const n of e){const o=n.unsigned&&n.unsigned.transaction_id;let a;if(o?a=this._pendingEvents.array.findIndex(c=>c.txnId===o):a=this._pendingEvents.array.findIndex(c=>c.remoteId===n.event_id),a!==-1){const c=this._pendingEvents.get(a),l=n.event_id;s.log({l:"removeRemoteEcho",queueIndex:c.queueIndex,remoteId:l,txnId:o}),t.pendingEvents.remove(c.roomId,c.queueIndex),i.push(c),await this._resolveRemoteIdInPendingRelations(o,l,t)}}return i}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{s.pendingEvents.remove(e.roomId,e.queueIndex)}catch{s.abort()}await s.complete();const i=this._pendingEvents.array.indexOf(e);i!==-1&&this._pendingEvents.remove(i)}e.dispose()}emitRemovals(e){for(const t of e){const s=this._pendingEvents.array.indexOf(t);s!==-1&&this._pendingEvents.remove(s),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,s,i){const n=ze(t);let o=null;if(n){const a=Si(n);if(Ur(a)&&(o=a,Dn(n,null)),n.rel_type===We&&this._pendingEvents.array.some(l=>{const h=ze(l.content);return l.eventType===e&&h&&h.key===n.key&&(l.relatedTxnId===o||h.event_id===n.event_id)})){i.set("already_annotating",!0);return}}await this._enqueueEvent(e,t,s,o,null,i)}async _enqueueEvent(e,t,s,i,n,o){const a=await this._createAndStoreEvent(e,t,i,n,s);this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem)}async enqueueRedaction(e,t,s){if(this._pendingEvents.array.some(a=>a.eventType===fe&&(a.relatedTxnId===e||a.relatedEventId===e))){s.set("already_redacting",!0);return}let n,o;if(Ur(e)){n=e;const a=e,c=this._pendingEvents.array.find(l=>l.txnId===a);if(c&&!c.remoteId&&c.status!==M.Sending){s.set("remove",n),await c.abort();return}else if(c)o=c.remoteId;else return}else{o=e;const a=this._pendingEvents.array.find(c=>c.remoteId===o);a&&(n=a.txnId)}s.set("relatedTxnId",n),s.set("relatedEventId",o),await this._enqueueEvent(fe,{reason:t},null,n,o,s)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(s){throw t.abort(),s}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,s,i,n){const o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let a;try{const c=o.pendingEvents,l=await c.getMaxQueueIndex(this._roomId)||0,d=Math.max(l,this._currentQueueIndex)+1,m=e!==fe&&e!==La&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:d,eventType:e,content:t,relatedTxnId:s,relatedEventId:i,txnId:Rs(),needsEncryption:m,needsUpload:!!n},n),c.add(a.data)}catch(c){throw o.abort(),c}return await o.complete(),a}dispose(){for(const e of this._pendingEvents)e.dispose()}}class Qn{constructor({filename:e,blob:t,platform:s}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=s,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){var e;(e=this._uploadRequest)==null||e.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await pa(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,s){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:n=>{this._sentBytes=n,t()},log:s});const{content_uri:i}=await this._uploadRequest.response();this._mxcUrl=i}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let s=e.substr(0,e.lastIndexOf("url"));_s(`${s}info.size`,t,this._transferredBlob.size),_s(`${s}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?_s(`${s}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):_s(`${s}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function _s(r,e,t){const s=r.split(".");let i=e;for(let o=0;o<s.length-1;o+=1){const a=s[o];i[a]||(i[a]={}),i=i[a]}const n=s[s.length-1];i[n]=t}const Gl="m.room.encrypted";class Jl extends Jn{constructor(e){super(e);const{pendingEvents:t}=e,s=new Wn({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new il({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:s,memberWriter:new nl(this.id)}),this._sendQueue=new zl({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}async prepareSync(e,t,s,i,n){var h;n.set("id",this.id),s&&n.set("newKeys",s.length);let o=this._summary.data.applySyncResponse(e,t,this._user.id),a=this._roomEncryption;!a&&o.encryption&&(n.set("enableEncryption",!0),a=this._createRoomEncryption(this,o.encryption));let c,l;if(a){let d=((h=e==null?void 0:e.timeline)==null?void 0:h.events)||[];s&&(c=await this._getSyncRetryDecryptEntries(s,a,i),c.length&&(n.set("retry",c.length),d=d.concat(c.map(m=>m.event)))),d=d.filter(m=>(m==null?void 0:m.type)===Gl),d.length&&(l=await a.prepareDecryptAll(d,s,tt.Sync,i))}return{roomEncryption:a,summaryChanges:o,decryptPreparation:l,decryptChanges:null,retryEntries:c}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async s=>{s.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:s,decryptChanges:i,roomEncryption:n,retryEntries:o},a,c){var P;c.set("id",this.id);const l=s.isNewJoin(this._summary.data);l&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));const{entries:h,updatedEntries:d,newLiveKey:m,memberChanges:p}=await c.wrap("syncWriter",D=>this._syncWriter.writeSync(e,l,s.hasFetchedMembers,a,D),c.level.Detail);if(i){const D=await c.wrap("decryptChanges",V=>i.write(a,V));c.set("decryptionResults",D.results.size),c.set("decryptionErrors",D.errors.size),this._isTimelineOpen&&await D.verifySenders(a),D.applyToEntries(h),o!=null&&o.length&&(D.applyToEntries(o),d.push(...o))}c.set("newEntries",h.length),c.set("updatedEntries",d.length);let _=!1;n&&this.isTrackingMembers&&(p==null?void 0:p.size)&&(_=await n.writeMemberChanges(p,a,c),c.set("shouldFlushKeyShares",_));const g=h.concat(d);s=s.applyTimelineEntries(g,t,!this._isTimelineOpen,this._user.id),s.membership!=="join"?a.roomSummary.remove(this.id):s=this._summary.writeData(s,a),s&&c.set("summaryChanges",s.changedKeys(this._summary.data));let b;s!=null&&s.needsHeroes&&(this._heroes||(this._heroes=new Mi(this._roomId)),b=await this._heroes.calculateChanges(s.heroes,p,a));let S;Array.isArray((P=e.timeline)==null?void 0:P.events)&&(S=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,c));const T=this._getPowerLevelsEvent(e);return{summaryChanges:s,roomEncryption:n,newEntries:h,updatedEntries:d,newLiveKey:m,removedPendingEvents:S,memberChanges:p,heroChanges:b,powerLevelsEvent:T,shouldFlushKeyShares:_}}afterSync(e,t){const{summaryChanges:s,newEntries:i,updatedEntries:n,newLiveKey:o,removedPendingEvents:a,memberChanges:c,powerLevelsEvent:l,heroChanges:h,roomEncryption:d}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(d),c.size){if(this._changedMembersDuringSync)for(const[p,_]of c.entries())this._changedMembersDuringSync.set(p,_.member);if(this._memberList&&this._memberList.afterSync(c),this._observedMembers&&this._updateObservedMembers(c),this._timeline){for(const[p,_]of c.entries())if(p===this._user.id){this._timeline.updateOwnMember(_.member);break}}}let m=!1;if(s&&(this._summary.applyChanges(s),this._summary.data.needsHeroes||(this._heroes=null),m=!0),this._heroes&&h){const p=this.name;this._heroes.applyChanges(h,this._summary.data,t),p!==this.name&&(m=!0)}l&&this._updatePowerLevels(l),m&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(n),this._timeline.addEntries(i)),this._observedEvents&&(this._observedEvents.updateEvents(n),this._observedEvents.updateEvents(i)),a&&this._sendQueue.emitRemovals(a)}_updateObservedMembers(e){for(const[t,s]of e){const i=this._observedMembers.get(t);i&&i.set(s.member)}}_getPowerLevelsEvent(e){var i,n,o;const t=a=>a.state_key===""&&a.type===jl;return(o=(i=e.timeline)==null?void 0:i.events.find(t))!=null?o:(n=e.state)==null?void 0:n.events.find(t)}_updatePowerLevels(e){if(this._powerLevels){const t=new bs({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}needsAfterSyncCompleted({shouldFlushKeyShares:e}){return e}async afterSyncCompleted(e,t){t.set("id",this.id),this._roomEncryption&&await this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,t)}start(e,t){if(this._roomEncryption){const s=e==null?void 0:e.get("share_room_key");s&&t.wrapDetached("flush room keys",i=>(i.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,s,i)))}this._sendQueue.resumeSending(t)}async load(e,t,s){try{await super.load(e,t,s),await this._syncWriter.load(t,s)}catch(i){throw new Sn(`Could not load room ${this._roomId}`,i)}}async _writeGapFill(e,t,s){return await this._sendQueue.removeRemoteEchos(e,t,s)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,s,i=null){return this._platform.logger.wrapOrRun(i,"send",n=>(n.set("id",this.id),this._sendQueue.enqueueEvent(e,t,s,n)))}sendRedaction(e,t,s=null){return this._platform.logger.wrapOrRun(s,"redact",i=>(i.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,i)))}async ensureMessageKeyIsShared(e=null){if(!!this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){var e;return((e=this._heroes)==null?void 0:e.roomAvatarColorId)||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){var t;const e=this._syncWriter.lastMessageKey;if(e){const i=await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,e);return(t=i==null?void 0:i.event)==null?void 0:t.event_id}}async clearUnread(e=null){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async t=>{t.set("id",this.id);const s=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let i;try{i=this._summary.writeClearUnread(s)}catch(n){throw s.abort(),n}await s.complete(),this._summary.applyChanges(i),this._emitUpdate();try{const n=await this._getLastEventId();n&&await this._hsApi.receipt(this._roomId,"m.read",n)}catch(n){if(n.name!=="ConnectionError")throw n}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}_getPendingEvents(){return this._sendQueue.pendingEvents}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new Qn({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class Ql extends Jn{constructor(e){super(e),this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){const s=await t.roomMembers.get(this.id,e);return s?new x(s):x.fromUserId(this.id,e,"join")}async load(e,t,s){const{summary:i,kickDetails:n}=e;return this._kickDetails=n,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(i,t,s)}async writeSync(e,t,s,i,n){if(n.set("id",this.id),s==="leave"){const o=Yl(t,this._user.id);if(o||e){const a=o||this._kickDetails;let c;o&&(c=await this._getKickAuthor(o.sender,i));const l=e||this._summary.data;return i.archivedRoomSummary.set({summary:l.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:c,summaryData:l}}}else s==="join"&&i.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:s},i){i.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),s&&(this._kickedBy=s),this._emitUpdate()}get isKicked(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="leave"}get isBanned(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){var e;return(e=this._kickDetails)==null?void 0:e.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();const s=this._storage.storeNames,i=await this._storage.readWriteTxn([s.roomState,s.archivedRoomSummary,s.roomMembers,s.timelineEvents,s.timelineFragments,s.timelineRelations,s.pendingEvents,s.inboundGroupSessions,s.groupSessionDecryptions,s.operations]);i.roomState.removeAllForRoom(this.id),i.archivedRoomSummary.remove(this.id),i.roomMembers.removeAllForRoom(this.id),i.timelineEvents.removeAllForRoom(this.id),i.timelineFragments.removeAllForRoom(this.id),i.timelineRelations.removeAllForRoom(this.id),i.pendingEvents.removeAllForRoom(this.id),i.inboundGroupSessions.removeAllForRoom(this.id),i.groupSessionDecryptions.removeAllForRoom(this.id),await i.operations.removeAllForScope(this.id),await i.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}}function Yl(r,e){var s,i;const t=An(r,(n,o)=>(o.type===oe&&o.state_key===e&&o.sender!==o.state_key&&(n=o),n),null);if(t)return{membership:(s=t.content)==null?void 0:s.membership,reason:(i=t.content)==null?void 0:i.reason,sender:t.sender}}async function Xl(r,e,t){const s=await Promise.all(r.map(async i=>{const n=await e.profile(i,{log:t}).response();return new Zl(i,n.displayname,n.avatar_url)}));return s.sort((i,n)=>i.name.localeCompare(n.name)),s}class Zl{constructor(e,t,s){this.userId=e,this.displayName=t,this.avatarUrl=s}get name(){return this.displayName||this.userId}}class eh{constructor(e){this.userId=e}get displayName(){}get name(){return this.userId}get avatarUrl(){}}function th(r){switch(r){case re.DirectMessage:case re.Private:return!0;case re.Public:return!1}}function sh(r){switch(r){case re.DirectMessage:return"trusted_private_chat";case re.Private:return"private_chat";case re.Public:return"public_chat"}}class ih extends Ns{constructor(e,t,s,i,n,o){var a;if(super(),this.id=e,this.options=t,this.updateCallback=s,this.mediaRepository=i,this.platform=n,this.profiles=[],this._isCancelled=!1,this.isEncrypted=t.isEncrypted===void 0?th(t.type):t.isEncrypted,t.name)this._calculatedName=t.name;else{const c={joinCount:1,inviteCount:((a=t.invites)==null?void 0:a.length)||0},l=(t.invites||[]).map(h=>new eh(h));this._calculatedName=di(l,c,o)}}async create(e,t){try{let s;if(this.options.avatar){const{avatar:o}=this.options,a=new Qn({filename:o.name,blob:o.blob,platform:this.platform});await a.upload(e,()=>{},t),s={info:o.info},a.applyToContent("url",s)}const i={is_direct:this.options.type===re.DirectMessage,preset:sh(this.options.type),initial_state:[]};this.options.name&&(i.name=this.options.name),this.options.topic&&(i.topic=this.options.topic),this.options.invites&&(i.invite=this.options.invites),this.options.alias&&(i.room_alias_name=this.options.alias),this.options.isFederationDisabled===!0&&(i.creation_content={"m.federate":!1}),this.isEncrypted&&i.initial_state.push(Ra()),s&&i.initial_state.push({type:"m.room.avatar",state_key:"",content:s});const n=await e.createRoom(i,{log:t}).response();this._roomId=n.room_id}catch(s){this._error=s}this.emitChange()}async loadProfiles(e,t){try{if(!this.options.name&&this.options.invites){this.profiles=await Xl(this.options.invites,e,t);const s={joinCount:1,inviteCount:this.options.invites.length};this._calculatedName=di(this.profiles,s,t),this.emitChange()}}catch{}}emitChange(e){this.updateCallback(this,e),this.emit("change")}get avatarColorId(){var e,t,s;return(s=(t=(e=this.options.invites)==null?void 0:e[0])!=null?t:this._roomId)!=null?s:this.id}get avatarUrl(){var e,t;return(t=(e=this.profiles)==null?void 0:e[0])==null?void 0:t.avatarUrl}get avatarBlobUrl(){var e,t;return(t=(e=this.options.avatar)==null?void 0:e.blob)==null?void 0:t.url}get roomId(){return this._roomId}get name(){return this._calculatedName}get isBeingCreated(){return!0}get error(){return this._error}cancel(){this._isCancelled||(this.dispose(),this._isCancelled=!0,this.emitChange("isCancelled"))}get isCancelled(){return this._isCancelled}dispose(){this.options.avatar&&this.options.avatar.blob.dispose()}async adjustDirectMessageMapIfNeeded(e,t,s,i){if(!this.options.invites||this.options.type!==re.DirectMessage)return;const n=this.options.invites[0],o="m.direct";await i.wrap("set "+o,async a=>{try{const c=await t.readWriteTxn([t.storeNames.accountData]);let l;try{l=await c.accountData.get(o),l||(l={type:o,content:{}});const h=l.content;let d=h[n];d||(h[n]=d=[]),d.push(this._roomId),c.accountData.set(l),await c.complete()}catch(h){throw c.abort(),h}await s.setAccountData(e.id,o,l.content,{log:a}).response()}catch(c){a.catch(c)}})}}class rh extends Ns{constructor({roomId:e,user:t,hsApi:s,mediaRepository:i,emitCollectionRemove:n,emitCollectionUpdate:o,platform:a}){super(),this._roomId=e,this._user=t,this._hsApi=s,this._emitCollectionRemove=n,this._emitCollectionUpdate=o,this._mediaRepository=i,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}isDirectMessageForUserId(e){return this.isDirectMessage&&this._inviter.userId===e}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new x(e.inviter):null}async writeSync(e,t,s,i){var n;if(e==="invite"){i.set("id",this.id),i.set("add",!0);const o=(n=t.invite_state)==null?void 0:n.events;if(!Array.isArray(o))return null;const a=this._createSummaryData(o);let c;!a.name&&!a.canonicalAlias&&(c=await this._createHeroes(o,i));const l=this._getMyInvite(o);if(!l)return null;const h=this._getInviter(l,o),d=this._createData(o,l,h,a,c);return s.invites.set(d),{inviteData:d,inviter:h}}else return i.set("id",this.id),i.set("membership",e),s.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,s,i,n){const o=n?n.roomName:i.name,a=n?n.roomAvatarUrl:i.avatarUrl,c=(n==null?void 0:n.roomAvatarColorId)||this.id;return{roomId:this.id,isEncrypted:!!i.encryption,isDirectMessage:i.isDirectMessage,name:o,avatarUrl:a,avatarColorId:c,canonicalAlias:i.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:s==null?void 0:s.serialize()}}_createSummaryData(e){return e.reduce((t,s)=>xn(t,s,this._user.id),new ke(null,this.id))}async _createHeroes(e,t){const s=e.filter(h=>h.type===oe),i=s.filter(h=>h.state_key!==this._user.id),n=i.reduce((h,d)=>{const m=x.fromMemberEvent(this.id,d);return h.set(m.userId,new Un(m,null)),h},new Map),o=i.map(h=>h.state_key),a=new Mi(this.id),c=await a.calculateChanges(o,n,null),l=new ke(null,this.id);return l.joinCount=s.reduce((h,d)=>{var m;return h+(((m=d.content)==null?void 0:m.membership)==="join"?1:0)},0),l.inviteCount=s.reduce((h,d)=>{var m;return h+(((m=d.content)==null?void 0:m.membership)==="invite"?1:0)},0),a.applyChanges(c,l,t),a}_getMyInvite(e){return e.find(t=>t.type===oe&&t.state_key===this._user.id)}_getInviter(e,t){const s=t.find(i=>i.type===oe&&i.state_key===e.sender);if(s)return x.fromMemberEvent(this.id,s)}_getJoinRule(e){var s;const t=e.find(i=>i.type==="m.room.join_rules");return t?(s=t.content)==null?void 0:s.join_rule:null}}class et{constructor(e){this._description=e}static httpPusher(e,t,s,i){return new et({kind:"http",append:!0,data:Object.assign({},i,{url:e+"/_matrix/push/v1/notify"}),pushkey:s,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const s=Object.assign({},this._description,{kind:null});await e.setPusher(s,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}}function wt(r,e){return Ai(r,e,()=>[],(t,s)=>t.push(s))}function Ai(r,e,t,s){return r.reduce((i,n)=>{const o=e(n);let a=i.get(o);return a||(a=t(),i.set(o,a)),s(a,n),i},new Map)}function Pr(r,e){return r.reduce((t,s)=>{const i=e(s);return t[i]?t[i]+=1:t[i]=1,t},{})}class nh{constructor({storage:e}){this._storage=e,this._olmDecryption=null,this._megolmDecryption=null}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){var t;return(t=this._olmDecryption)==null?void 0:t.obtainDecryptionLock(e)}async prepareSync(e,t,s,i){i.set("messageTypes",Pr(e,a=>a.type));const n=e.filter(a=>a.type==="m.room.encrypted");if(!this._olmDecryption){i.log("can't decrypt, encryption not enabled",i.level.Warn);return}const o=n.filter(a=>{var c;return((c=a.content)==null?void 0:c.algorithm)===bi});if(o.length){const a=await this._olmDecryption.decryptAll(o,t,s);i.set("decryptedTypes",Pr(a.results,l=>{var h;return(h=l.event)==null?void 0:h.type}));for(const l of a.errors)i.child("decrypt_error").catch(l);const c=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,i);return new oh(a,c)}}async writeSync(e,t){return e.olmDecryptChanges.write(t),(await Promise.all(e.newRoomKeys.map(i=>this._megolmDecryption.writeRoomKey(i,t)))).some(i=>!!i)}}class oh{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=wt(t,s=>s.roomId)}}const Pt=ie+"olmAccount",ui=ie+"areDeviceKeysUploaded",Ss=ie+"serverOTKCount";async function Vr(r,e,t,s,i){const n=r.pickle(e),o=await i.readWriteTxn([i.storeNames.session]);try{o.session.add(Pt,n),o.session.add(ui,t),o.session.add(Ss,s)}catch(a){throw o.abort(),a}await o.complete()}class it{static async load({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:n,olmWorker:o,txn:a}){const c=await a.session.get(Pt);if(c){const l=new e.Account,h=await a.session.get(ui);l.unpickle(t,c);const d=await a.session.get(Ss);return new it({pickleKey:t,hsApi:s,account:l,userId:i,deviceId:n,areDeviceKeysUploaded:h,serverOTKCount:d,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:s,hsApi:i,userId:n,olmWorker:o,storage:a}){const c=t.adoptUnpickledOlmAccount(),l=JSON.parse(c.one_time_keys()),d=Object.entries(l.curve25519).length,m=!0;return await Vr(c,s,m,d,a),new it({pickleKey:s,hsApi:i,account:c,userId:n,deviceId:t.deviceId,areDeviceKeysUploaded:m,serverOTKCount:d,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:n,olmWorker:o,storage:a}){const c=new e.Account;o?await o.createAccountAndOTKs(c,c.max_number_of_one_time_keys()):(c.create(),c.generate_one_time_keys(c.max_number_of_one_time_keys()));const l=!1,h=0;return a&&await Vr(c,t,l,h,a),new it({pickleKey:t,hsApi:s,account:c,userId:i,deviceId:n,areDeviceKeysUploaded:l,serverOTKCount:h,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:s,userId:i,deviceId:n,areDeviceKeysUploaded:o,serverOTKCount:a,olm:c,olmWorker:l}){this._olm=c,this._pickleKey=e,this._hsApi=t,this._account=s,this._userId=i,this._deviceId=n,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=l,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,s){var o;const i=JSON.parse(this._account.one_time_keys()),n=Object.entries(i.curve25519);if(n.length||!this._areDeviceKeysUploaded){const a={};if(!this._areDeviceKeysUploaded){s.set("identity",!0);const h=JSON.parse(this._account.identity_keys());a.device_keys=this._deviceKeysPayload(h)}n.length&&(s.set("otks",!0),a.one_time_keys=this._oneTimeKeysPayload(n));const c=t?this._deviceId:void 0,l=await this._hsApi.uploadKeys(c,a,{log:s}).response();this._serverOTKCount=(o=l==null?void 0:l.one_time_key_counts)==null?void 0:o.signed_curve25519,s.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,h=>{n.length&&(this._account.mark_keys_as_published(),h==null||h.set(Pt,this._account.pickle(this._pickleKey)),h==null||h.set(Ss,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,h==null||h.set(ui,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){const s=this._account.max_number_of_one_time_keys(),i=Math.floor(s/2);if(this._serverOTKCount<i){const n=JSON.parse(this._account.one_time_keys()),a=Object.entries(n.curve25519).length,c=i-a-this._serverOTKCount;return c>0&&await t.wrap("generate otks",l=>{l.set("max",s),l.set("server",this._serverOTKCount),l.set("unpublished",a),l.set("new",c),l.set("limit",i),this._account.generate_one_time_keys(c),this._updateSessionStorage(e,h=>{h.set(Pt,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){const s=new this._olm.Session;try{return s.create_inbound_from(this._account,e,t),s}catch(i){throw s.free(),i}}async createOutboundOlmSession(e,t){const s=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,s,e,t):s.create_outbound(this._account,e,t),s}catch(i){throw s.free(),i}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set(Pt,this._account.pickle(this._pickleKey))}writeSync(e,t,s){const i=e.signed_curve25519;if(Number.isSafeInteger(i)&&i!==this._serverOTKCount)return t.session.set(Ss,i),s.set("otkCount",i),i}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_deviceKeysPayload(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[bi,ve],keys:{}};for(const[s,i]of Object.entries(e))t.keys[`${s}:${this._deviceId}`]=i;return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[s,i]of e){const n={key:i};this.signObject(n),t[`signed_curve25519:${s}`]=n}return t}async _updateSessionStorage(e,t){if(e){const s=await e.readWriteTxn([e.storeNames.session]);try{await t(s.session)}catch(i){throw s.abort(),i}await s.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(Cn.stringify(e)),e.signatures=t,s!==void 0&&(e.unsigned=s)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}class xi{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){var e;return(e=this._keyDescription)==null?void 0:e.passphrase}get algorithm(){var e;return(e=this._keyDescription)==null?void 0:e.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){const s=this._keyDescription;if(s.mac){const i=await ah(e.binaryKey,s.iv,t);return s.mac===i}else if(s.passphrase){const i=e.description._keyDescription;return i.passphrase?s.passphrase.algorithm===i.passphrase.algorithm&&s.passphrase.iterations===i.passphrase.iterations&&s.passphrase.salt===i.passphrase.salt:!1}}return!1}}class Zt{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new Zt(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}async function ah(r,e,t){const{crypto:s,encoding:i}=t,{utf8:n,base64:o}=i,{derive:a,aes:c,hmac:l}=s,h=o.decode(e),d=new Uint8Array(8),m="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",p=n.encode(""),_=await a.hkdf(r,d,p,"SHA-256",512),g=_.slice(0,32),b=_.slice(32),S=await c.encryptCTR({key:g,iv:h,data:n.encode(m)}),T=await l.compute(b,S,"SHA-256");return o.encode(T)}const ch=5e5,lh=256;async function hh(r,e,t){const{passphraseParams:s}=r;if(!s)throw new Error("not a passphrase key");if(s.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${s.algorithm}`);const{utf8:i}=t.encoding,n=await t.crypto.derive.pbkdf2(i.encode(e),s.iterations||ch,i.encode(s.salt),"SHA-512",s.bits||lh);return new Zt(r,n)}const xt=[139,1];function dh(r,e,t,s){const i=s.encoding.base58.decode(e.replace(/ /g,""));let n=0;for(const a of i)n^=a;if(n!==0)throw new Error("Incorrect parity");for(let a=0;a<xt.length;++a)if(i[a]!==xt[a])throw new Error("Incorrect prefix");if(i.length!==xt.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(i.slice(xt.length,xt.length+t.PRIVATE_KEY_LENGTH));return new Zt(r,o)}const Ni=`${ie}ssssKey`,Br=`${ie}keyBackupVersion`;var Gt=(r=>(r[r.RecoveryKey=0]="RecoveryKey",r[r.Passphrase=1]="Passphrase",r))(Gt||{});async function Yn(r){var n;const e=await r.readTxn([r.storeNames.accountData]),t=await e.accountData.get("m.secret_storage.default_key"),s=(n=t==null?void 0:t.content)==null?void 0:n.key;if(!s)return;const i=await e.accountData.get(`m.secret_storage.key.${s}`);if(!!i)return new xi(s,i.content)}async function uh(r,e,t){const s=await t.session.get(Br);return t.session.set(Br,e),t.session.set(Ni,{id:r.id,binaryKey:r.binaryKey}),s}async function mh(r){const e=await r.session.get(Ni);if(!e)return;const t=await r.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new Zt(new xi(e.id,t.content),e.binaryKey)}async function ph(r){r.session.remove(Ni)}async function _h(r,e,t,s,i){const n=await Yn(t);if(!n)throw new Error("Could not find a default secret storage key in account data");return await Xn(r,e,n,s,i)}async function Xn(r,e,t,s,i){let n;if(r===1)n=await hh(t,e,s);else if(r===0)n=dh(t,e,i,s);else throw new Error(`Invalid type: ${r}`);return n}async function gh(r,e,t){const s=await Yn(e);if(await(s==null?void 0:s.isCompatible(r,t)))return r.withDescription(s)}const Zn="org.matrix.msc2697.v1.olm.libolm_pickle";async function fh(r,e,t,s){try{const i=await r.getDehydratedDevice({log:s}).response();if(i.device_data.algorithm===Zn)return new wh(i,e,t)}catch(i){i.name!=="HomeServerError"&&(s.error=i);return}}async function yh(r,e,t,s,i){var a;const o=(await e.createDehydratedDevice({device_data:{algorithm:Zn,account:r.pickleWithKey(t.binaryKey.slice()),passphrase:((a=t.description)==null?void 0:a.passphraseParams)||{}},initial_device_display_name:s}).response()).device_id;return r.setDeviceId(o),await r.uploadKeys(void 0,!0,i),o}class wh{constructor(e,t,s){this._dehydratedDevice=e,this._olm=t,this._platform=s}async decrypt(e,t){const s=new xi("dehydrated_device",this._dehydratedDevice.device_data.passphrase),i=await Xn(e,t,s,this._platform,this._olm),n=new this._olm.Account;try{const o=this._dehydratedDevice.device_data.account;return n.unpickle(i.binaryKey.slice(),o),new vh(this._dehydratedDevice,n,i)}catch(o){if(n.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}}class vh{constructor(e,t,s){this._dehydratedDevice=e,this._account=t,this._key=s}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){var e;(e=this._account)==null||e.free(),this._account=void 0}}class bh{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class Sh{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function eo(r,e,t,s){return{session:r.pickle(s),sessionId:r.session_id(),senderKey:e,lastUsed:t}}class Cs{constructor(e,t,s,i=!1){this.data=e,this.pickleKey=t,this.olm=s,this.isNew=i,this.isModified=i}static create(e,t,s,i,n){const o=eo(t,e,n,i);return new Cs(o,i,s,!0)}get id(){return this.data.sessionId}load(){const e=new this.olm.Session;return e.unpickle(this.pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this.pickleKey),this.isModified=!0}}class to{constructor(e,t,s){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=s,this.roomTracked=!0}setDevice(e){this.device=e}setRoomNotTrackedYet(){this.roomTracked=!1}get isVerified(){return this.device?this.device.ed25519Key===this.claimedEd25519Key:!1}get isUnverified(){return this.device?!this.isVerified:!this.isVerificationUnknown}get isVerificationUnknown(){return!this.device&&!this.roomTracked}}var Ts=(r=>(r[r.PreKey=0]="PreKey",r[r.Normal=1]="Normal",r))(Ts||{});const Fr=4;function so(r){r.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}class Ih{constructor(e,t,s,i,n,o){this.account=e,this.pickleKey=t,this.now=s,this.ownUserId=i,this.olm=n,this.senderKeyLock=o}async obtainDecryptionLock(e){var i;const t=new Set;for(const n of e){const o=(i=n.content)==null?void 0:i.sender_key;o&&t.add(o)}const s=await Promise.all(Array.from(t).map(n=>this.senderKeyLock.takeLock(n)));return new Sh(s)}async decryptAll(e,t,s){try{const i=wt(e,h=>{var d;return(d=h.content)==null?void 0:d.sender_key}),n=this.now(),o=await Promise.all(Array.from(i.entries()).map(([h,d])=>this._decryptAllForSenderKey(h,d,n,s))),a=o.reduce((h,d)=>h.concat(d.results),[]),c=o.reduce((h,d)=>h.concat(d.errors),[]),l=o.map(h=>h.senderKeyDecryption);return new kh(l,a,c,this.account,t)}catch(i){throw t.release(),i}}async _decryptAllForSenderKey(e,t,s,i){const n=await this._getSessions(e,i),o=new Eh(e,n,s),a=[],c=[];for(const l of t)try{const h=this._decryptForSenderKey(o,l,s);a.push(h)}catch(h){c.push(h)}return{results:a,errors:c,senderKeyDecryption:o}}_decryptForSenderKey(e,t,s){const i=e.senderKey,n=this._getMessageAndValidateEvent(t);let o;try{o=e.decrypt(n)}catch(a){throw new H("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:i,error:a.message})}if(typeof o!="string"&&n.type===Ts.PreKey){let a;try{a=this._createSessionAndDecrypt(i,n,s)}catch(c){throw new H(`Could not create inbound olm session: ${c.message}`,t,{senderKey:i,error:c})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(c){throw new H("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:c})}return this._validatePayload(a,t),new to(a,i,a.keys.ed25519)}else throw new H("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,s){let i;const n=this.account.createInboundOlmSession(e,t.body);try{i=n.decrypt(t.type,t.body);const o=Cs.create(e,n,this.olm,this.pickleKey,s);return o.unload(n),{session:o,plaintext:i}}catch(o){throw n.free(),o}}_getMessageAndValidateEvent(e){var i;const t=(i=e.content)==null?void 0:i.ciphertext;if(!t)throw new H("OLM_MISSING_CIPHERTEXT",e);const s=t==null?void 0:t[this.account.identityKeys.curve25519];if(!s)throw new H("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return s}async _getSessions(e,t){const i=(await t.olmSessions.getAll(e)).map(n=>new Cs(n,this.pickleKey,this.olm));return so(i),i}_validatePayload(e,t){var s,i,n;if(e.sender!==t.sender)throw new H("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this.ownUserId)throw new H("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(((s=e.recipient_keys)==null?void 0:s.ed25519)!==this.account.identityKeys.ed25519)throw new H("OLM_BAD_RECIPIENT_KEY",t,{key:(i=e.recipient_keys)==null?void 0:i.ed25519});if(!e.type)throw new H("missing type on payload",t,{payload:e});if(typeof((n=e.keys)==null?void 0:n.ed25519)!="string")throw new H("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class Eh{constructor(e,t,s){this.senderKey=e,this.sessions=t,this.timestamp=s}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const s=this.decryptWithSession(t,e);if(typeof s=="string")return so(this.sessions),s}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}decryptWithSession(e,t){if(t.type===void 0||t.body===void 0)throw new Error("Invalid message without type or body");const s=e.load();try{if(t.type===Ts.PreKey&&!s.matches_inbound(t.body))return;try{const i=s.decrypt(t.type,t.body);return e.save(s),e.data.lastUsed=this.timestamp,i}catch(i){if(t.type===Ts.PreKey)throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${i.message}`);return}}finally{e.unload(s)}}}class kh{constructor(e,t,s,i,n){this.senderKeyDecryptions=e,this.results=t,this.errors=s,this.account=i,this.lock=n}get hasNewSessions(){return this.senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(const t of this.senderKeyDecryptions){for(const s of t.getModifiedSessions())if(e.olmSessions.set(s.data),s.isNew){const i=s.load();try{this.account.writeRemoveOneTimeKey(i,e)}finally{s.unload(i)}}if(t.sessions.length>Fr){const{senderKey:s,sessions:i}=t;for(let n=i.length-1;n>=Fr;n-=1){const o=i[n];e.olmSessions.remove(s,o.id)}}}}finally{this.lock.release()}}}function Rh(r){return r.reduce((e,t)=>!e||t<e?t:e,null)}const Kr="signed_curve25519",$r=20;class Ch{constructor(e,t,s,i,n,o,a,c){this.account=e,this.pickleKey=t,this.olm=s,this.storage=i,this.now=n,this.ownUserId=o,this.olmUtil=a,this.senderKeyLock=c}async encrypt(e,t,s,i,n){let o=[];for(let a=0;a<s.length;a+=$r){const c=s.slice(a,a+$r),l=await this._encryptForMaxDevices(e,t,c,i,n);o=o.concat(l)}return o}async _encryptForMaxDevices(e,t,s,i,n){const o=await Promise.all(s.map(a=>this.senderKeyLock.takeLock(a.curve25519Key)));try{const{devicesWithoutSession:a,existingEncryptionTargets:c}=await this._findExistingSessions(s),l=this.now();let h=[];try{if(a.length){const p=await n.wrap("create sessions",_=>this._createNewSessions(a,i,l,_));h=h.concat(p)}await this._loadSessions(c),h=h.concat(c);const d={l:"encrypt",targets:h.length},m=n.wrap(d,()=>h.map(p=>{const _=this._encryptForDevice(e,t,p);return new Th(_,p.device)}));return await this._storeSessions(h,l),m}finally{for(const d of h)d.dispose()}}finally{for(const a of o)a.release()}}async _findExistingSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]),s=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(o.curve25519Key))),i=e.filter((o,a)=>{const c=s[a];return!(c!=null&&c.length)}),n=e.map((o,a)=>{const c=s[a];if((c==null?void 0:c.length)>0){const l=Rh(c);return Jt.fromSessionId(o,l)}}).filter(o=>!!o);return{devicesWithoutSession:i,existingEncryptionTargets:n}}_encryptForDevice(e,t,s){const{session:i,device:n}=s,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,n)),a=i.encrypt(o);return{algorithm:bi,sender_key:this.account.identityKeys.curve25519,ciphertext:{[n.curve25519Key]:a}}}_buildPlainTextMessageForDevice(e,t,s){return{keys:{ed25519:this.account.identityKeys.ed25519},recipient_keys:{ed25519:s.ed25519Key},recipient:s.userId,sender:this.ownUserId,content:t,type:e}}async _createNewSessions(e,t,s,i){const n=await i.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(const o of n){const{device:a,oneTimeKey:c}=o;o.session=await this.account.createOutboundOlmSession(a.curve25519Key,c)}await this._storeSessions(n,s)}catch(o){for(const a of n)a.dispose();throw o}return n}async _claimOneTimeKeys(e,t,s){const i=Ai(t,c=>c.userId,()=>new Map,(c,l)=>c.set(l.deviceId,l)),n=Array.from(i.entries()).reduce((c,[l,h])=>(c[l]=Array.from(h.values()).reduce((d,m)=>(d[m.deviceId]=Kr,d),{}),c),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:n},{log:s}).response();Object.keys(o.failures).length&&s.log({l:"failures",servers:Object.keys(o.failures)},s.level.Warn);const a=o==null?void 0:o.one_time_keys;return this._verifyAndCreateOTKTargets(a,i,s)}_verifyAndCreateOTKTargets(e,t,s){var n;const i=[];for(const[o,a]of Object.entries(e))for(const[c,l]of Object.entries(a)){const[h,d]=Object.entries(l)[0],[m]=h.split(":");if(m===Kr){const p=(n=t.get(o))==null?void 0:n.get(c);if(p&&Mn(this.olmUtil,o,c,p.ed25519Key,d,s)){const g=Jt.fromOTK(p,d.key);i.push(g)}}}return i}async _loadSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]);let s=!1;try{await Promise.all(e.map(async i=>{const n=await t.olmSessions.get(i.device.curve25519Key,i.sessionId);if(n&&!s){const o=new this.olm.Session;o.unpickle(this.pickleKey,n.session),i.session=o}}))}catch(i){s=!0;for(const n of e)n.dispose();throw i}}async _storeSessions(e,t){const s=await this.storage.readWriteTxn([this.storage.storeNames.olmSessions]);try{for(const i of e){const n=eo(i.session,i.device.curve25519Key,t,this.pickleKey);s.olmSessions.set(n)}}catch(i){throw s.abort(),i}await s.complete()}}class Jt{constructor(e,t,s){this.device=e,this.oneTimeKey=t,this.sessionId=s,this.session=null}static fromOTK(e,t){return new Jt(e,t,null)}static fromSessionId(e,t){return new Jt(e,null,t)}dispose(){this.session&&this.session.free()}}class Th{constructor(e,t){this.content=e,this.device=t}}class Mh{constructor(e,t,s,i){this._roomId=e,this._results=t,this._errors=s,this._replayEntries=i}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(s){this._errors.set(t.eventId,s)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,s){const{messageIndex:i,sessionId:n,eventId:o,timestamp:a}=t,c=await s.groupSessionDecryptions.get(e,n,i);if(c&&c.eventId!==o){const h=c.timestamp<a?o:c.eventId;throw this._results.delete(o),new H("MEGOLM_REPLAYED_INDEX",event,{messageIndex:i,badEventId:h,otherEventId:c.eventId})}c||s.groupSessionDecryptions.set(e,n,i,{eventId:o,timestamp:a})}}function mi(r,e){if(r)for(const[t,s]of r.entries())e.set(t,s)}class Ah{constructor(e,t,s){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=s}async decrypt(){try{const e=this._initialErrors,t=new Map,s=[];return await Promise.all(this._sessionDecryptions.map(async i=>{const n=await i.decryptAll();mi(n.errors,e),mi(n.results,t),s.push(...n.replayEntries)})),new Mh(this._roomId,t,e,s)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class xh{constructor(e,t,s){this.sessionId=e,this.messageIndex=t,this.event=s}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class Nh{constructor(e,t,s,i){this.key=e,this.events=t,this.olmWorker=s,this.keyLoader=i,this.decryptionRequests=s?[]:void 0}async decryptAll(){const e=[],t=new Map;let s;return await this.keyLoader.useKey(this.key,async i=>{for(const n of this.events)try{const o=n.content.ciphertext;let a;if(this.olmWorker){const d=this.olmWorker.megolmDecrypt(i,o);this.decryptionRequests.push(d),a=await d.response()}else a=i.decrypt(o);const{plaintext:c}=a;let l;try{l=JSON.parse(c)}catch(d){throw new H("PLAINTEXT_NOT_JSON",n,{plaintext:c,err:d})}if(l.room_id!==this.key.roomId)throw new H("MEGOLM_WRONG_ROOM",n,{encryptedRoomId:l.room_id,eventRoomId:this.key.roomId});e.push(new xh(this.key.sessionId,a.message_index,n));const h=new to(l,this.key.senderKey,this.key.claimedEd25519Key);t.set(n.event_id,h)}catch(o){if(o.name==="AbortError")return;s||(s=new Map),s.set(n.event_id,o)}}),{results:t,errors:s,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function Di(r){var e;return(e=r.content)==null?void 0:e.sender_key}function Li(r){var e;return(e=r.content)==null?void 0:e.session_id}function Dh(r){var e;return(e=r.content)==null?void 0:e.ciphertext}function Lh(r){return typeof Di(r)=="string"&&typeof Li(r)=="string"&&typeof Dh(r)=="string"}class Oh{constructor(){this.events=[]}get senderKey(){return Di(this.events[0])}get sessionId(){return Li(this.events[0])}}function pi(r){return Ai(r,e=>`${Di(e)}|${Li(e)}`,()=>new Oh,(e,t)=>e.events.push(t))}class io{isForSession(e,t,s){return this.roomId===e&&this.senderKey===t&&this.sessionId===s}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function ro(r,e){return r.first_known_index()<e.first_known_index()}class Oi extends io{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let s;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(n,o)=>{s=n.pickle(o)},t),this.isBetter===!1)return!1;s||(s=await e.useKey(this,(n,o)=>n.pickle(o)));const i={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:s,backup:this.backupStatus,source:this.keySource,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(i),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,s){if(this.isBetter!==void 0)return this.isBetter;let i=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!i){const n=await ao(this.roomId,this.senderKey,this.sessionId,s);n&&(n.hasSession?i=n:n.eventIds&&(this._eventIds=n.eventIds))}if(i){const n=i;await e.useKey(this,async o=>{await e.useKey(n,(a,c)=>{this.isBetter=ro(o,a),n.isBetter=!this.isBetter,this.isBetter&&t&&t(o,c)})})}else this.isBetter=!0;return this.isBetter}get backupStatus(){return Ds.NotBackedUp}}class Uh extends Oi{constructor(e){super(),this._decryptionResult=e}get roomId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_key}get serializationType(){return"create"}get keySource(){return Xt.DeviceMessage}loadInto(e){e.create(this.serializationKey)}}class Ph extends Oi{constructor(e,t,s){super(),this._roomId=e,this.outboundSession=t,this.identityKeys=s,this.isBetter=!0,this._sessionKey=this.outboundSession.session_key()}get roomId(){return this._roomId}get senderKey(){return this.identityKeys.curve25519}get sessionId(){return this.outboundSession.session_id()}get claimedEd25519Key(){return this.identityKeys.ed25519}get serializationKey(){return this._sessionKey}get serializationType(){return"create"}get keySource(){return Xt.Outbound}loadInto(e){e.create(this.serializationKey)}}class Vh extends Oi{constructor(e,t,s){super(),this._roomId=e,this._sessionId=t,this._backupInfo=s}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){var e;return(e=this._backupInfo.sender_claimed_keys)==null?void 0:e.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}get keySource(){return Xt.Backup}loadInto(e){e.import_session(this.serializationKey)}get backupStatus(){return Ds.BackedUp}}class no extends io{constructor(e){super(),this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function Bh(r){var s;const e=(s=r.event.content)==null?void 0:s.session_key,t=new Uh(r);if(typeof t.roomId=="string"&&typeof t.sessionId=="string"&&typeof t.senderKey=="string"&&typeof e=="string")return t}function oo(r,e,t){var o;const s=t.session_key,i=t.sender_key,n=(o=t.sender_claimed_keys)==null?void 0:o.ed25519;if(typeof r=="string"&&typeof e=="string"&&typeof i=="string"&&typeof s=="string"&&typeof n=="string")return new Vh(r,e,t)}async function ao(r,e,t,s){const i=await s.inboundGroupSessions.get(r,e,t);if(i)return new no(i)}class Fh{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,s,i,n){let o=await n.inboundGroupSessions.get(e,t,s);if(!(o!=null&&o.session)){if(o){const a=new Set(o.eventIds);for(const c of i)a.add(c);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:s,eventIds:i};n.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,s,i){const n=await i.inboundGroupSessions.get(e,t,s);if(n&&!n.session)return n.eventIds}async hasSession(e,t,s,i){const n=await i.inboundGroupSessions.get(e,t,s);return typeof(n==null?void 0:n.session)=="string"}async prepareDecryptAll(e,t,s,i){const n=new Map,o=[];for(const l of t)Lh(l)?o.push(l):n.set(l.event_id,new H("MEGOLM_INVALID_EVENT",l));const a=pi(o),c=[];return await Promise.all(Array.from(a.values()).map(async l=>{const h=await this.getRoomKey(e,l.senderKey,l.sessionId,s,i);if(h)c.push(new Nh(h,l.events,this.olmWorker,this.keyLoader));else for(const d of l.events)n.set(d.event_id,new H("MEGOLM_NO_SESSION",d))})),new Ah(e,c,n)}async getRoomKey(e,t,s,i,n){if(i){const c=i.find(l=>l.isForSession(e,t,s));if(c&&await c.checkBetterThanKeyInStorage(this.keyLoader,n))return c}const o=this.keyLoader.getCachedKey(e,t,s);if(o)return o;const a=await ao(e,t,s,n);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){var i,n;const s=[];for(const o of e)((i=o.event)==null?void 0:i.type)!=="m.room_key"||((n=o.event.content)==null?void 0:n.algorithm)!==ve||t.wrap("room_key",a=>{const c=Bh(o);c?(a.set("roomId",c.roomId),a.set("id",c.sessionId),s.push(c)):(a.logLevel=a.level.Warn,a.set("invalid",!0))},t.level.Detail);return s}roomKeyFromBackup(e,t,s){return oo(e,t,s)}dispose(){this.keyLoader.dispose()}}class Kh extends Hn{constructor(e,t,s){super(s),this.pickleKey=t,this.olm=e}getCachedKey(e,t,s){const i=this.findCachedKeyIndex(e,t,s);if(i!==-1)return this._getByIndexAndMoveUp(i).key}async useKey(e,t){const s=await this.allocateOperation(e);try{return await t(s.session,this.pickleKey)}finally{this.releaseOperation(s)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){const s=this._getByIndexAndMoveUp(t);return s.isForKey(e)?(s.refCount+=1,s):(s.refCount=1,s.key=e,e.loadInto(s.session,this.pickleKey),s)}else{const s=new this.olm.InboundGroupSession;e.loadInto(s,this.pickleKey);const i=new $h(e,s);return this._set(i),i}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,s){return this._entries.reduce((i,n,o,a)=>{const c=i===-1?void 0:a[i];return n.isBest===!0&&n.isForSameSession(e,t,s)&&(!c||n.isBetter(c))?o:i},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,s,i,n)=>{const o=t===-1?void 0:n[t];return s.refCount===0&&s.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!s.isBetter(o))?i:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}}class $h{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,s){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===s}isBetter(e){return ro(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}const qh="m.megolm_backup.v1.curve25519-aes-sha2";class Ui{constructor(e,t){this.encryption=e,this.decryption=t}static fromAuthData(e,t,s){const i=e.public_key,n=new s.PkDecryption,o=new s.PkEncryption;try{const a=n.init_with_private_key(t);if(a!==i)throw new Error(`Bad backup key, public key does not match. Calculated ${a} but expected ${i}`);o.set_recipient_key(a)}catch(a){throw n.free(),a}return new Ui(o,n)}decryptRoomKey(e){const t=this.decryption.decrypt(e.ephemeral,e.mac,e.ciphertext);return JSON.parse(t)}encryptRoomKey(e,t){const s={algorithm:ve,sender_key:e.senderKey,sender_claimed_keys:{ed25519:e.claimedEd25519Key},forwarding_curve25519_key_chain:[],session_key:t};return this.encryption.encrypt(JSON.stringify(s))}dispose(){var e,t;(e=this.decryption)==null||e.free(),this.decryption=void 0,(t=this.encryption)==null||t.free(),this.encryption=void 0}}const jh=200;class Pi{constructor(e,t,s,i,n,o,a=1e4){this.backupInfo=e,this.crypto=t,this.hsApi=s,this.keyLoader=i,this.storage=n,this.platform=o,this.maxDelay=a,this.operationInProgress=new we(void 0),this._stopped=!1,this._needsNewKey=!1,this._hasBackedUpAllKeys=!1}get hasStopped(){return this._stopped}get error(){return this._error}get version(){return this.backupInfo.version}get needsNewKey(){return this._needsNewKey}get hasBackedUpAllKeys(){return this._hasBackedUpAllKeys}async getRoomKey(e,t,s){const i=await this.hsApi.roomKeyForRoomAndSession(this.backupInfo.version,e,t,{log:s}).response();if(!i.session_data)return;const n=this.crypto.decryptRoomKey(i.session_data);if((n==null?void 0:n.algorithm)===ve)return oo(e,t,n);n!=null&&n.algorithm&&s.set("unknown algorithm",n.algorithm)}markAllForBackup(e){return e.inboundGroupSessions.markAllAsNotBackedUp()}flush(e){this.operationInProgress.get()||e.wrapDetached("flush key backup",async t=>{if(this._needsNewKey){t.set("needsNewKey",this._needsNewKey);return}this._stopped=!1,this._error=void 0,this._hasBackedUpAllKeys=!1;const s=this._runFlushOperation(t);this.operationInProgress.set(s);try{await s.result,this._hasBackedUpAllKeys=!0}catch(i){this._stopped=!0,i.name==="HomeServerError"&&(i.errcode==="M_WRONG_ROOM_KEYS_VERSION"||i.errcode==="M_NOT_FOUND")?(t.set("wrong_version",!0),this._needsNewKey=!0):(i.name!=="AbortError"||i.name==="StorageError"&&i.errcode==="AbortError")&&(this._error=i),t.catch(i)}this.operationInProgress.set(void 0)})}_runFlushOperation(e){return new vn(async(t,s)=>{let i=0,n=0;for(;;){const o=this.platform.random()*this.maxDelay,a=this.platform.clock.createTimeout(o);t(a),await a.elapsed();const c=await this.storage.readTxn([N.inboundGroupSessions]);t(c),i=n+await c.inboundGroupSessions.countNonBackedUpSessions(),s(new qr(i,n));const l=(await c.inboundGroupSessions.getFirstNonBackedUpSessions(jh)).map(m=>new no(m));if(l.length===0){e.set("total",i);return}const h=await this.encodeKeysForBackup(l),d=this.hsApi.uploadRoomKeysToBackup(this.backupInfo.version,h,{log:e});t(d),await d.response(),await this.markKeysAsBackedUp(l,t),n+=l.length,s(new qr(i,n))}})}async encodeKeysForBackup(e){const t={rooms:{}},s=t.rooms;for(const i of e){let n=s[i.roomId];n||(n=s[i.roomId]={sessions:{}}),n.sessions[i.sessionId]=await this.encodeRoomKey(i)}return t}async markKeysAsBackedUp(e,t){const s=await this.storage.readWriteTxn([N.inboundGroupSessions]);t(s);try{await Promise.all(e.map(i=>s.inboundGroupSessions.markAsBackedUp(i.roomId,i.senderKey,i.sessionId)))}catch(i){throw s.abort(),i}await s.complete()}async encodeRoomKey(e){return await this.keyLoader.useKey(e,t=>{const s=t.first_known_index(),i=t.export_session(s);return{first_message_index:s,forwarded_count:0,is_verified:!1,session_data:this.crypto.encryptRoomKey(e,i)}})}dispose(){this.crypto.dispose()}static async fromSecretStorage(e,t,s,i,n,o,a){const c=await s.readSecret("m.megolm_backup.v1",a);if(c){const l=new Uint8Array(e.encoding.base64.decode(c)),h=await i.roomKeysVersion().response();if(h.algorithm===qh){const d=Ui.fromAuthData(h.auth_data,l,t);return new Pi(h,d,i,n,o,e)}else throw new Error(`Unknown backup algorithm: ${h.algorithm}`)}}}class qr{constructor(e,t){this.total=e,this.finished=t}}class Wh{constructor({pickleKey:e,olm:t,account:s,keyLoader:i,storage:n,now:o,ownDeviceId:a}){this._pickleKey=e,this._olm=t,this._account=s,this._keyLoader=i,this._storage=n,this._now=o,this._ownDeviceId=a}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let s=await t.outboundGroupSessions.get(e);if(s){const i=new this._olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,s.session),this._createRoomKeyMessage(i,e)}finally{i.free()}}}createWithheldMessage(e,t,s){return{algorithm:e.algorithm,code:t,reason:s,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let s=new this._olm.OutboundGroupSession;try{const i=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let n;try{let o=await i.outboundGroupSessions.get(e);n=await this._readOrCreateSession(s,o,e,t,i),n&&this._writeSession(this._now(),s,e,i)}catch(o){throw i.abort(),o}return await i.complete(),n}finally{s.free()}}async _readOrCreateSession(e,t,s,i,n){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,i)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const o=this._createRoomKeyMessage(e,s);return await new Ph(s,e,this._account.identityKeys).write(this._keyLoader,n),o}}_writeSession(e,t,s,i){i.outboundGroupSessions.set({roomId:s,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,s,i){let n=new this._olm.OutboundGroupSession;try{const o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let a,c;try{let l=await o.outboundGroupSessions.get(e);a=await this._readOrCreateSession(n,l,e,i,o),c=this._encryptContent(e,n,t,s);const h=a?this._now():l.createdAt;this._writeSession(h,n,e,o)}catch(l){throw o.abort(),l}return await o.complete(),new Hh(c,a)}finally{n&&n.free()}}_needsToRotate(e,t,s){let i=6048e5;Number.isSafeInteger(s==null?void 0:s.rotation_period_ms)&&(i=s==null?void 0:s.rotation_period_ms);let n=100;if(Number.isSafeInteger(s==null?void 0:s.rotation_period_msgs)&&(n=s==null?void 0:s.rotation_period_msgs),this._now()>t+i||e.message_index()>=n)return!0}_encryptContent(e,t,s,i){const n=JSON.stringify({room_id:e,type:s,content:i}),o=t.encrypt(n);return{algorithm:ve,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:ve,chain_index:e.message_index()}}}class Hh{constructor(e,t){this.content=e,this.roomKeyMessage=t}}const jr="m.room.encrypted",zh=60*1e3;class Gh{constructor({room:e,deviceTracker:t,olmEncryption:s,megolmEncryption:i,megolmDecryption:n,encryptionParams:o,storage:a,keyBackup:c,notifyMissingMegolmSession:l,clock:h}){this._room=e,this._deviceTracker=t,this._olmEncryption=s,this._megolmEncryption=i,this._megolmDecryption=n,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._keyBackup=c,this._notifyMissingMegolmSession=l,this._clock=h,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._disposed=!1}enableKeyBackup(e){this._keyBackup&&!!e||(this._keyBackup=e)}async restoreMissingSessionsFromBackup(e,t){const s=e.filter(h=>h.isEncrypted&&!h.isDecrypted&&h.event).map(h=>h.event),i=pi(s),n=Array.from(i.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(n.map(async h=>this._megolmDecryption.hasSession(this._room.id,h.senderKey,h.sessionId,o))),c=n.filter((h,d)=>!a[d]);if(c.length)for(var l=c.length-1;l>=0;l--){const h=c[l];await t.wrap("session",d=>this._requestMissingSessionFromBackup(h.senderKey,h.sessionId,d))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeMemberChanges(e,t,s){let i=!1;const n=Array.from(e.values());return n.some(o=>o.hasLeft)&&(s.log({l:"discardOutboundSession",leftUsers:n.filter(o=>o.hasLeft).map(o=>o.userId)}),this._megolmEncryption.discardOutboundSession(this._room.id,t)),n.some(o=>o.hasJoined)&&(i=await this._addShareRoomKeyOperationForNewMembers(n,t,s)),await this._deviceTracker.writeMemberChanges(this._room,e,t),i}async prepareDecryptAll(e,t,s,i){var c,l,h;const n=new Map,o=[];for(const d of e)d.redacted_because||((c=d.unsigned)==null?void 0:c.redacted_because)||(((l=d.content)==null?void 0:l.algorithm)!==ve&&n.set(d.event_id,new Error("Unsupported algorithm: "+((h=d.content)==null?void 0:h.algorithm))),o.push(d));const a=await this._megolmDecryption.prepareDecryptAll(this._room.id,o,t,i);return new Jh(a,n,s,this,e)}async _processDecryptionResults(e,t,s,i,n,o){const a=e.filter(l=>{const h=s.get(l.event_id);return(h==null?void 0:h.code)==="MEGOLM_NO_SESSION"});if(!a.length)return;const c=pi(a);i===tt.Sync&&await Promise.all(Array.from(c.values()).map(async l=>{const h=l.events.map(d=>d.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,l.senderKey,l.sessionId,h,n)})),this._keyBackup&&o.wrapDetached("check key backup",async l=>{if(l.set("source",i),l.set("events",a.length),l.set("sessions",c.size),i===tt.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const h=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(c).map(async([d,m])=>{await this._megolmDecryption.hasSession(this._room.id,m.senderKey,m.sessionId,h)&&c.delete(d)}))}await Promise.all(Array.from(c.values()).map(h=>l.wrap("session",d=>this._requestMissingSessionFromBackup(h.senderKey,h.sessionId,d))))})}async _verifyDecryptionResult(e,t){let s=this._senderDeviceCache.get(e.senderCurve25519Key);s||(s=await this._deviceTracker.getDeviceByCurve25519Key(e.senderCurve25519Key,t),this._senderDeviceCache.set(e.senderCurve25519Key,s)),s?e.setDevice(s):this._room.isTrackingMembers||e.setRoomNotTrackedYet()}async _requestMissingSessionFromBackup(e,t,s){if(!this._keyBackup){s.set("enabled",!1),this._notifyMissingMegolmSession();return}s.set("id",t),s.set("senderKey",e);try{const i=await this._keyBackup.getRoomKey(this._room.id,t,s);if(i){if(i.senderKey!==e){s.set("wrong_sender_key",i.senderKey),s.logLevel=s.level.Warn;return}let n=!1,o;const a=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{n=await this._megolmDecryption.writeRoomKey(i,a),s.set("isBetter",n),n&&(o=i.eventIds)}catch(c){throw a.abort(),c}await a.complete(),n&&await s.wrap("retryDecryption",c=>this._room.notifyRoomKey(i,o||[],c))}}catch(i){i.name==="HomeServerError"&&i.errcode==="M_NOT_FOUND"?(s.error=i,s.logLevel=s.level.Error):s.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){var s;if(!(((s=this._lastKeyPreShareTime)==null?void 0:s.measure())<zh)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{var n;const i=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);i&&((n=this._keyBackup)==null||n.flush(t),await t.wrap("share key",o=>this._shareNewRoomKey(i,e,o)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,s,i){var o;this._keySharePromise&&(i.set("waitForRunningKeyShare",!0),await this._keySharePromise);const n=await i.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return n.roomKeyMessage&&((o=this._keyBackup)==null||o.flush(i),await i.wrap("share key",a=>this._shareNewRoomKey(n.roomKeyMessage,s,a))),{type:jr,content:n.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,s){let i=await this._storage.readWriteTxn([this._storage.storeNames.operations]),n;try{n=this._writeRoomKeyShareOperation(e,null,i)}catch(o){throw i.abort(),o}await this._processShareRoomKeyOperation(n,t,s)}async _addShareRoomKeyOperationForNewMembers(e,t,s){const i=e.filter(o=>o.hasJoined).map(o=>o.userId),n=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return n?(s.log({l:"share key for new members",userIds:i,id:n.session_id,chain_index:n.chain_index}),this._writeRoomKeyShareOperation(n,i,t),!0):!1}async flushPendingRoomKeyShares(e,t,s){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(const i of t)i.type==="share_room_key"&&await s.wrap("operation",n=>this._processShareRoomKeyOperation(i,e,n))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,s){const n={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return s.operations.add(n),n}async _processShareRoomKeyOperation(e,t,s){s.set("id",e.id),await this._deviceTracker.trackRoom(this._room,s);let i;if(e.userIds===null){i=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,s);const a=Array.from(i.reduce((c,l)=>c.add(l.userId),new Set));e.userIds=a,await this._updateOperationsStore(c=>c.update(e))}else i=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,s);const n=await s.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,i,t,a)),o=i.filter(a=>!n.some(c=>c.device===a));await s.wrap("send",a=>this._sendMessagesToDevices(jr,n,t,a)),o.length&&await s.wrap("missingDevices",async a=>{a.set("devices",o.map(h=>h.deviceId));const c=e.userIds.filter(h=>o.some(d=>d.userId===h));a.set("unsentUserIds",c),e.userIds=c,await this._updateOperationsStore(h=>h.update(e));const l=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",l,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(s){throw t.abort(),s}await t.complete()}async _sendSharedMessageToDevices(e,t,s,i,n){const o=wt(s,l=>l.userId),a={messages:Array.from(o.entries()).reduce((l,[h,d])=>(l[h]=d.reduce((m,p)=>(m[p.deviceId]=t,m),{}),l),{})},c=Rs();await i.sendToDevice(e,a,c,{log:n}).response()}async _sendMessagesToDevices(e,t,s,i){i.set("messages",t.length);const n=wt(t,c=>c.device.userId),o={messages:Array.from(n.entries()).reduce((c,[l,h])=>(c[l]=h.reduce((d,m)=>(d[m.device.deviceId]=m.content,d),{}),c),{})},a=Rs();await s.sendToDevice(e,o,a,{log:i}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(s=>{var i,n;if(s.isEncrypted&&!s.isDecrypted){const{event:o}=s;if(o){const a=(i=o.content)==null?void 0:i.sender_key,c=(n=o.content)==null?void 0:n.session_id;return t.some(l=>a===l.senderKey&&c===l.sessionId)}}return!1})}dispose(){this._disposed=!0}}class Jh{constructor(e,t,s,i,n){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=n}async decrypt(){return new Qh(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class Qh{constructor(e,t,s,i,n){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=n}async write(e,t){const{results:s,errors:i}=await this._megolmDecryptionChanges.write(e);return mi(this._extraErrors,i),await this._roomEncryption._processDecryptionResults(this._events,s,i,this._source,e,t),new Yh(s,i,this._roomEncryption)}}class Yh{constructor(e,t,s){this.results=e,this.errors=t,this._roomEncryption=s}applyToEntries(e){for(const t of e){const s=this.results.get(t.id);if(s)t.setDecryptionResult(s);else{const i=this.errors.get(t.id);i&&t.setDecryptionError(i)}}}verifySenders(e){return Promise.all(Array.from(this.results.values()).map(t=>this._roomEncryption._verifyDecryptionResult(t,e)))}}class Xh{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new bh,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}}class Zh{constructor({key:e,platform:t}){this._key=e,this._platform=t}async readSecret(e,t){var n,o;const s=await t.accountData.get(e);if(!s)return;const i=(o=(n=s==null?void 0:s.content)==null?void 0:n.encrypted)==null?void 0:o[this._key.id];if(!i)throw new Error(`Secret ${s.type} is not encrypted for key ${this._key.id}`);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(s.type,i);throw new Error(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`)}async _decryptAESSecret(e,t){const{base64:s,utf8:i}=this._platform.encoding,n=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,i.encode(e),"SHA-256",512),o=n.slice(0,32),a=n.slice(32),c=s.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,s.decode(t.mac),c,"SHA-256"))throw new Error("Bad MAC");const h=await this._platform.crypto.aes.decryptCTR({key:o,iv:s.decode(t.iv),data:c});return i.decode(h)}}const Ye="DEFAULT_KEY",Nt="pusher";class ed{constructor({storage:e,hsApi:t,sessionInfo:s,olm:i,olmWorker:n,platform:o,mediaRepository:a}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._syncInfo=null,this._sessionInfo=s,this._rooms=new $t,this._roomUpdateCallback=(c,l)=>this._rooms.update(c.id,l),this._activeArchivedRooms=new Map,this._invites=new $t,this._inviteUpdateCallback=(c,l)=>this._invites.update(c.id,l),this._roomsBeingCreatedUpdateCallback=(c,l)=>{c.isCancelled?this._roomsBeingCreated.remove(c.id):this._roomsBeingCreated.update(c.id,l)},this._roomsBeingCreated=new $t,this._user=new Nl(s.userId),this._deviceMessageHandler=new nh({storage:e}),this._olm=i,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._keyLoader=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=n,this._keyBackup=new we(void 0),this._observedRoomStatus=new Map,i&&(this._olmUtil=new i.Utility,this._deviceTracker=new xc({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:s.userId,ownDeviceId:s.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsKeyBackup=new we(!1)}get fingerprintKey(){var e;return(e=this._e2eeAccount)==null?void 0:e.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}_setupEncryption(){const e=new Xh,t=new Ih(this._e2eeAccount,Ye,this._platform.clock.now,this._user.id,this._olm,e);this._olmEncryption=new Ch(this._e2eeAccount,Ye,this._olm,this._storage,this._platform.clock.now,this._user.id,this._olmUtil,e),this._keyLoader=new Kh(this._olm,Ye,20),this._megolmEncryption=new Wh({account:this._e2eeAccount,pickleKey:Ye,olm:this._olm,storage:this._storage,keyLoader:this._keyLoader,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId}),this._megolmDecryption=new Fh(this._keyLoader,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption})}_createRoomEncryption(e,t){var s;if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==ve?null:new Gh({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,keyBackup:(s=this._keyBackup)==null?void 0:s.get(),encryptionParams:t,notifyMissingMegolmSession:()=>{this._keyBackup.get()||this.needsKeyBackup.set(!0)},clock:this._platform.clock})}enableSecretStorage(e,t,s=void 0){return this._platform.logger.wrapOrRun(s,"enable secret storage",async i=>{if(!this._olm)throw new Error("olm required");this._keyBackup.get()&&(this._keyBackup.get().dispose(),this._keyBackup.set(null));const n=await _h(e,t,this._storage,this._platform,this._olm),o=await this._storage.readTxn([this._storage.storeNames.accountData]);if(await this._createKeyBackup(n,o,i))return await this._writeSSSSKey(n,i),this._keyBackup.get().flush(i),n;throw new Error("Could not read key backup with the given key")})}async _writeSSSSKey(e,t){const s=this._keyBackup.get();if(!s)return;const i=s.version,n=await this._storage.readWriteTxn([this._storage.storeNames.session,this._storage.storeNames.inboundGroupSessions]);try{const o=await uh(e,i,n);if(t.set("previousBackupVersion",o),t.set("backupVersion",i),!!o&&o!==i){const a=await s.markAllForBackup(n);t.set("amountMarkedForBackup",a)}}catch(o){throw n.abort(),o}await n.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{ph(e)}catch(t){throw e.abort(),t}if(await e.complete(),this._keyBackup.get()){for(const t of this._rooms.values())t.isEncrypted&&t.enableKeyBackup(void 0);this._keyBackup.get().dispose(),this._keyBackup.set(null)}}_createKeyBackup(e,t,s){return s.wrap("enable key backup",async i=>{try{const n=new Zh({key:e,platform:this._platform}),o=await Pi.fromSecretStorage(this._platform,this._olm,n,this._hsApi,this._keyLoader,this._storage,t);if(o){for(const a of this._rooms.values())a.isEncrypted&&a.enableKeyBackup(o);return this._keyBackup.set(o),!0}}catch(n){i.catch(n)}return!1})}get keyBackup(){return this._keyBackup}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()),await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t)))}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await it.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:Ye,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return it.create({hsApi:this._hsApi,olm:this._olm,pickleKey:Ye,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async s=>{const i=await this._createNewAccount("temp-device-id");try{const n=await yh(i,this._hsApi,e,"Dehydrated device",s);return s.set("deviceId",n),n}finally{i.dispose()}})}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await it.load({hsApi:this._hsApi,olm:this._olm,pickleKey:Ye,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&(e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()));const s=await this._getPendingEventsByRoom(t),i=await t.invites.getAll(),n=Promise.all(i.map(async c=>{const l=this.createInvite(c.roomId);e.wrap("invite",h=>l.load(c,h)),this._invites.add(l.id,l)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async c=>{const l=this.createJoinedRoom(c.roomId,s.get(c.roomId));await e.wrap("room",h=>l.load(c,t,h)),this._rooms.add(l.id,l)}));await Promise.all([n,a]);for(const[c,l]of this.invites){const h=this.rooms.get(c);h&&h.setInvite(l)}}dispose(){var e,t,s,i;(e=this._olmWorker)==null||e.dispose(),this._olmWorker=void 0,(t=this._keyBackup.get())==null||t.dispose(),this._keyBackup.set(void 0),(s=this._megolmDecryption)==null||s.dispose(),this._megolmDecryption=void 0,(i=this._e2eeAccount)==null||i.dispose(),this._e2eeAccount=void 0;for(const n of this._rooms.values())n.dispose();this._rooms=void 0}async start(e,t,s){var a;if(e){const c=await this._storage.readWriteTxn([this._storage.storeNames.session]);c.session.set("serverVersions",e),await c.complete()}if(!this._keyBackup.get()){t&&await s.wrap("SSSSKeyFromDehydratedDeviceKey",async h=>{const d=await gh(t.key,this._storage,this._platform);d&&(h.set("success",!0),await this._writeSSSSKey(d))});const c=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.accountData]),l=await mh(c);l&&await this._createKeyBackup(l,c,s)&&((a=this._keyBackup.get())==null||a.flush(s)),this._keyBackup.get()||this._keyBackup.set(null)}const n=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),o=wt(n,c=>c.scope);for(const c of this._rooms.values()){let l;const h=o.get(c.id);h&&(l=wt(h,d=>d.type)),c.start(l,s)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((s,i)=>{const n=s.get(i.roomId);return n?n.push(i):s.set(i.roomId,[i]),s},new Map)}get rooms(){return this._rooms}findDirectMessageForUserId(e){for(const[,t]of this._rooms)if(t.isDirectMessageForUserId(e))return t;for(const[,t]of this._invites)if(t.isDirectMessageForUserId(e))return t}createJoinedRoom(e,t){return new Jl({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform})}_createArchivedRoom(e){const t=new Ql({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new rh({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}get roomsBeingCreated(){return this._roomsBeingCreated}createRoom(e){let t;return this._platform.logger.runDetached("create room",async s=>{const i=`local-${Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER)}`;t=new ih(i,e,this._roomsBeingCreatedUpdateCallback,this._mediaRepository,this._platform,s),this._roomsBeingCreated.set(i,t);const n=[t.create(this._hsApi,s)];e.loadProfiles!==!1&&n.push(t.loadProfiles(this._hsApi,s)),await Promise.all(n),t.roomId&&(this.rooms.get(t.roomId)&&this._tryReplaceRoomBeingCreated(t.roomId,s),await t.adjustDirectMessageMapIfNeeded(this._user,this._storage,this._hsApi,s))}),t}async obtainSyncLock(e){var s;const t=(s=e.to_device)==null?void 0:s.events;if(Array.isArray(t)&&t.length)return await this._deviceMessageHandler.obtainSyncLock(t)}async prepareSync(e,t,s,i){var o;const n=(o=e.to_device)==null?void 0:o.events;if(Array.isArray(n)&&n.length)return await i.wrap("deviceMsgs",a=>this._deviceMessageHandler.prepareSync(n,t,s,a))}async writeSync(e,t,s,i,n){const o={syncInfo:null,e2eeAccountChanges:null},a=e.next_batch;if(a!==this.syncToken){const d={token:a,filterId:t};i.session.set("sync",d),o.syncInfo=d}const c=e.device_one_time_keys_count;this._e2eeAccount&&c&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(c,i,n));const l=e.device_lists;this._deviceTracker&&Array.isArray(l==null?void 0:l.changed)&&l.changed.length&&await n.wrap("deviceLists",d=>this._deviceTracker.writeDeviceChanges(l.changed,i,d)),s&&(o.hasNewRoomKeys=await n.wrap("deviceMsgs",d=>this._deviceMessageHandler.writeSync(s,i,d)));const h=e.account_data;if(Array.isArray(h==null?void 0:h.events))for(const d of h.events)typeof d.type=="string"&&i.accountData.set(d);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,s){var i;t||await this._e2eeAccount.generateOTKsIfNeeded(this._storage,s)&&await s.wrap("uploadKeys",o=>this._e2eeAccount.uploadKeys(this._storage,!1,o)),e.hasNewRoomKeys&&((i=this._keyBackup.get())==null||i.flush(s))}_tryReplaceRoomBeingCreated(e,t){for(const[,s]of this._roomsBeingCreated)if(s.roomId===e){const i=this._observedRoomStatus.get(s.id);i&&(t.log("replacing room being created").set("localId",s.id).set("roomId",s.roomId),i.set(i.get()|L.Replaced)),s.dispose(),this._roomsBeingCreated.remove(s.id);return}}applyRoomCollectionChangesAfterSync(e,t,s,i){var n,o;for(const a of t)a.shouldAdd?(this._rooms.add(a.id,a.room),this._tryReplaceRoomBeingCreated(a.id,i)):a.shouldRemove&&this._rooms.remove(a.id);for(const a of e)a.shouldAdd?this._invites.add(a.id,a.invite):a.shouldRemove&&this._invites.remove(a.id);if(this._observedRoomStatus.size!==0){for(const a of s)a.shouldAdd&&((n=this._observedRoomStatus.get(a.id))==null||n.set(L.Archived));for(const a of t)a.shouldAdd&&((o=this._observedRoomStatus.get(a.id))==null||o.set(L.Joined));for(const a of e){const c=this._observedRoomStatus.get(a.id);if(c){const l=c.get()|L.Invited;if(a.shouldAdd)c.set(l);else if(a.shouldRemove){const h=l^L.Invited;c.set(h)}}}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set((t.get()|L.Archived)^L.Archived)}get syncToken(){var e;return(e=this._syncInfo)==null?void 0:e.token}get syncFilterId(){var e;return(e=this._syncInfo)==null?void 0:e.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{const t=et.createDefaultPayload(this._sessionInfo.id),s=await this._platform.notificationService.enablePush(et,t);if(!s)return e.set("no_pusher",!0),!1;await s.enable(this._hsApi,e);const i=await this._storage.readWriteTxn([this._storage.storeNames.session]);return i.session.set(Nt,s.serialize()),await i.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();const s=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Nt);if(!s)return!0;await new et(s).disable(this._hsApi,e);const n=await this._storage.readWriteTxn([this._storage.storeNames.session]);return n.session.remove(Nt),await n.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Nt):!1}async checkPusherEnabledOnHomeserver(){const t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Nt);if(!t)return!1;const s=new et(t),i=await this._hsApi.getPushers().response();return((i==null?void 0:i.pushers)||[]).map(o=>new et(o)).some(o=>o.equals(s))}async getRoomStatus(e){if(!!this._roomsBeingCreated.get(e))return L.BeingCreated;if(!!this._rooms.get(e))return L.Joined;{const i=!!this._invites.get(e),o=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return i&&o?L.Invited|L.Archived:i?L.Invited:o?L.Archived:L.None}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){const s=await this.getRoomStatus(e);t=new ri(s,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t)}return t}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async s=>{s.set("id",e);const i=this._activeArchivedRooms.get(e);if(i)return i.retain(),i;const n=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await n.archivedRoomSummary.get(e);if(o){const a=this._createArchivedRoom(e);return await a.load(o,n,s),a}})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async s=>(await this._hsApi.joinIdOrAlias(e,{log:s}).response()).room_id)}}class td{constructor({username:e,password:t,homeserver:s}){this._username=e,this._password=t,this.homeserver=s}async login(e,t,s){return await e.passwordLogin(this._username,this._password,t,{log:s}).response()}}class sd{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,s){return await e.tokenLogin(this._loginToken,Rs(),t,{log:s}).response()}}class id{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${e}`}}class Vi{constructor(e,t){this._session=e,this._params=t}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}}class rd extends Vi{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.dummy"}}class nd extends Vi{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.terms"}get privacyPolicy(){var e;return(e=this._params)==null?void 0:e.policies.privacy_policy}get termsOfService(){var e;return(e=this._params)==null?void 0:e.policies.terms_of_service}}class od extends Vi{constructor(e,t,s){super(e,t),this._type=s}generateAuthenticationData(){if(!this._token)throw new Error("No token provided for TokenAuth");return{session:this._session,type:this._type,token:this._token}}setToken(e){this._token=e}get type(){return this._type}}class ad{constructor(e,t,s){this._hsApi=e,this._accountDetails=t,this._flowSelector=s!=null?s:i=>i[0]}async start(){const e=await this._hsApi.register(this._accountDetails.username,this._accountDetails.password,this._accountDetails.initialDeviceDisplayName,void 0,this._accountDetails.inhibitLogin).response();return this.parseStagesFromResponse(e)}async submitStage(e){const t=e.generateAuthenticationData(),{username:s,password:i,initialDeviceDisplayName:n,inhibitLogin:o}=this._accountDetails,a=this._hsApi.register(s,i,n,t,o),c=await a.response(),l=await a.responseCode(),h=pr(as({},c),{status:l});return this.parseRegistrationResponse(h,e)}parseStagesFromResponse(e){const{session:t,params:s}=e,i=this._flowSelector(e.flows);if(!i)throw new Error("flowSelector did not return any flow!");let n,o;for(const a of i.stages){const c=this._createRegistrationStage(a,t,s);n?(o.setNextStage(c),o=c):(n=c,o=c)}return n}async parseRegistrationResponse(e,t){var s;switch(e.status){case 200:this._sessionInfo=e;return;case 401:if((s=e.completed)!=null&&s.includes(t.type))return t.nextStage;throw new Error("This stage could not be completed!")}}_createRegistrationStage(e,t,s){switch(e){case"m.login.dummy":return new rd(t,s==null?void 0:s[e]);case"m.login.terms":return new nd(t,s==null?void 0:s[e]);case"org.matrix.msc3231.login.registration_token":case"m.login.registration_token":return new od(t,s==null?void 0:s[e],e);default:throw new Error(`Unknown stage: ${e}`)}}get sessionInfo(){return this._sessionInfo}}const k=Ne("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),Te=Ne("Connection","Credentials","Unknown");class Bi{constructor(e){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new we(k.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=e.loadOlm(),this._workerPromise=e.loadOlmWorker(),this._accountSetup=void 0}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===k.NotLoading&&(this._status.set(k.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{const s=await this._platform.sessionInfoStorage.get(e);if(!s)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(s,null,t),t.set("status",this._status.get())}catch(s){t.catch(s),this._error=s,this._status.set(k.Error)}}))}_parseLoginOptions(e,t){const s=e.flows,i={homeserver:t};for(const n of s)n.type==="m.login.password"?i.password=(o,a)=>new td({homeserver:t,username:o,password:a}):n.type==="m.login.sso"&&s.find(o=>o.type==="m.login.token")?i.sso=new id(t):n.type==="m.login.token"&&(i.token=o=>new sd({homeserver:t,loginToken:o}));return i}queryLogin(e){return new vn(async t=>{e=await ra(e,(n,o)=>t(this._platform.request(n,o)));const s=new Xe({homeserver:e,request:this._platform.request}),i=await t(s.getLoginFlows()).response();return this._parseLoginOptions(i,e)})}async startRegistration(e,t,s,i,n){const o=this._platform.request,a=new Xe({homeserver:e,request:o});return new ad(a,{username:t,password:s,initialDeviceDisplayName:i},n)}async startWithLogin(e,{inspectAccountSetup:t}={}){const s=this._status.get();s!==k.LoginFailed&&s!==k.NotLoading&&s!==k.Error||(this._resetStatus(),await this._platform.logger.run("login",async i=>{this._status.set(k.Login);const n=this._platform.clock;let o;try{const c=this._platform.request,l=new Xe({homeserver:e.homeserver,request:c}),h=await e.login(l,"Hydrogen",i),d=this.createNewSessionId();o={id:d,deviceId:h.device_id,userId:h.user_id,homeServer:e.homeserver,homeserver:e.homeserver,accessToken:h.access_token,lastUsed:n.now()},i.set("id",d)}catch(c){this._error=c,c.name==="HomeServerError"?(c.errcode==="M_FORBIDDEN"?this._loginFailure=Te.Credentials:this._loginFailure=Te.Unknown,i.set("loginFailure",this._loginFailure),this._status.set(k.LoginFailed)):c.name==="ConnectionError"?(this._loginFailure=Te.Connection,this._status.set(k.LoginFailed)):this._status.set(k.Error);return}let a;t&&(a=await this._inspectAccountAfterLogin(o,i),a&&(o.deviceId=a.deviceId)),await this._platform.sessionInfoStorage.add(o);try{await this._loadSessionInfo(o,a,i),i.set("status",this._status.get())}catch(c){i.catch(c),a==null||a.dispose(),this._error=c,this._status.set(k.Error)}}))}async _loadSessionInfo(e,t,s){s.set("appVersion",this._platform.version);const i=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(k.Loading),this._reconnector=new ua({onlineStatus:this._platform.onlineStatus,retryDelay:new En(i.createTimeout),createMeasure:i.createMeasure});const n=new Xe({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,s);const o={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer},a=await this._olmPromise;let c=null;this._workerPromise&&(c=await this._workerPromise),this._requestScheduler=new fa({hsApi:n,clock:i}),this._requestScheduler.start();const l=new _a({homeserver:e.homeServer,platform:this._platform});if(this._session=new ed({storage:this._storage,sessionInfo:o,hsApi:this._requestScheduler.hsApi,olm:a,olmWorker:c,mediaRepository:l,platform:this._platform}),await this._session.load(s),t?(await s.wrap("dehydrateIdentity",h=>this._session.dehydrateIdentity(t,h)),await this._session.setupDehydratedDevice(t.key,s)):this._session.hasIdentity||(this._status.set(k.SessionSetup),await s.wrap("createIdentity",h=>this._session.createIdentity(h))),this._sync=new va({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(h=>{h===Ft.Online&&this._platform.logger.runDetached("reconnect",async d=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;const m=t;t=void 0,await d.wrap("session start",p=>this._session.start(this._reconnector.lastVersionsResponse,m,p))})}),await s.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(k.Ready),!this._sessionStartedByReconnector)){const h=await n.versions({timeout:1e4,log:s}).response();if(this._isDisposed)return;const d=t;t=void 0,await s.wrap("session start",m=>this._session.start(h,d,m))}}async _waitForFirstSync(){this._sync.start(),this._status.set(k.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>{var t;return e===A.Stopped?((t=this._sync.error)==null?void 0:t.name)!=="ConnectionError":e===A.Syncing});try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===A.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async s=>{var a;this._status.set(k.QueryAccount);const i=new Xe({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),n=await this._olmPromise;let o;try{o=await fh(i,n,this._platform,s)}catch(c){if(c.name==="HomeServerError")s.set("not_supported",!0);else throw c}if(o){let c;const l=new Promise(d=>c=d);this._accountSetup=new cd(o,c),this._status.set(k.AccountSetup),await l;const h=(a=this._accountSetup)==null?void 0:a._dehydratedDevice;return this._accountSetup=null,h}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}startLogout(e){return this._platform.logger.run("logout",async t=>{this._sessionId=e,t.set("id",this._sessionId);const s=await this._platform.sessionInfoStorage.get(this._sessionId);if(!s)throw new Error(`Could not find session for id ${this._sessionId}`);try{await new Xe({homeserver:s.homeServer,accessToken:s.accessToken,request:this._platform.request}).logout({log:t}).response()}catch{}await this.deleteSession(t)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(k.NotLoading),this._error=null,this._loginFailure=null}}class cd{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class R extends Ns{constructor(e){super(),this._isDisposed=!1,this._options=e}childOptions(e){return Object.assign({},this._options,e)}get options(){return this._options}getOption(e){return this._options[e]}observeNavigation(e,t){const i=this.navigation.observe(e).subscribe(n=>{t(n,e)});this.track(i)}track(e){return this.disposables||(this.disposables=new Ti),this.disposables.track(e)}untrack(e){if(this.disposables)return this.disposables.untrack(e)}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){if(this.disposables)return this.disposables.disposeTracked(e)}i18n(e,...t){let s="";for(let i=0;i<e.length;++i)s=s+e[i],i<t.length&&(s=s+t[i]);return s}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlCreator(){return this._options.urlCreator}get navigation(){return this._options.navigation}}function he(r){let e=r.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=r.charAt(1)),e.toUpperCase()}function ld(r){let e=0,t,s;if(r.length===0)return e;for(t=0;t<r.length;t++)s=r.charCodeAt(t),e=(e<<5)-e+s,e|=0;return Math.abs(e)}function de(r){return ld(r)%8+1}function Le(r,e,t,s){if(r){const i=e*t.devicePixelRatio;return s.mxcUrlThumbnail(r,i,i,"crop")}return null}const Wr=["roomBeingCreated","invite","room"];class Fi extends R{constructor(e){super(e),this._isOpen=!1,this._hidden=!1}get hidden(){return this._hidden}set hidden(e){e!==this._hidden&&(this._hidden=e,this.emitChange("hidden"))}close(){this._isOpen&&(this._isOpen=!1,this.emitChange("isOpen"))}open(){this._isOpen||(this._isOpen=!0,this.emitChange("isOpen"))}get isOpen(){return this._isOpen}compare(e){return e.kind!==this.kind?Wr.indexOf(this.kind)-Wr.indexOf(e.kind):0}get avatarLetter(){return he(this.name)}get avatarColorNumber(){return de(this._avatarSource.avatarColorId)}avatarUrl(e){return Le(this._avatarSource.avatarUrl,e,this.platform,this._avatarSource.mediaRepository)}get avatarTitle(){return this.name}}class hd extends Fi{constructor(e){super(e);const{room:t}=e;this._room=t,this._url=this.urlCreator.openRoomActionUrl(this._room.id)}get kind(){return"room"}get url(){return this._url}compare(e){const t=super.compare(e);if(t!==0)return t;const s=this._room,i=e._room;if(s.isLowPriority!==i.isLowPriority)return s.isLowPriority?1:-1;const n=s.lastMessageTimestamp,o=i.lastMessageTimestamp,a=Number.isSafeInteger(n),c=Number.isSafeInteger(o);if(a!==c)return c?1:-1;const l=o-n;if(l===0||!c||!a){const h=this.name.localeCompare(e.name);return h===0?this._room.id.localeCompare(e._room.id):h}return l}get isUnread(){return this._room.isUnread}get name(){return this._room.name||this.i18n`Empty Room`}get badgeCount(){return this._room.notificationCount}get isHighlighted(){return this._room.highlightCount!==0}get _avatarSource(){return this._room}}function _i(r,e){return r===e?0:r<e?-1:1}class dd extends Fi{constructor(e){super(e);const{invite:t}=e;this._invite=t,this._url=this.urlCreator.openRoomActionUrl(this._invite.id)}get busy(){return this._invite.accepting||this._invite.rejecting}get kind(){return"invite"}get url(){return this._url}get name(){return this._invite.name}get isHighlighted(){return!0}get isUnread(){return!0}get badgeCount(){return this.i18n`!`}get _avatarSource(){return this._invite}compare(e){const t=super.compare(e);if(t!==0)return t;const s=e._invite.timestamp-this._invite.timestamp;return s!==0?s:_i(this._invite.id,e._invite.id)}}class ud extends Fi{constructor(e){super(e);const{roomBeingCreated:t}=e;this._roomBeingCreated=t,this._url=this.urlCreator.openRoomActionUrl(this._roomBeingCreated.id)}get busy(){return!this._roomBeingCreated.error}get kind(){return"roomBeingCreated"}get isHighlighted(){return!this.busy}get badgeCount(){return!this.busy&&this.i18n`Failed`}get url(){return this._url}get name(){return this._roomBeingCreated.name}get _avatarSource(){return this._roomBeingCreated}compare(e){const t=super.compare(e);if(t!==0)return t;const s=_i(this.name,e.name);return s===0?_i(this._roomBeingCreated.id,e._roomBeingCreated.id):s}avatarUrl(e){var t;return(t=this._roomBeingCreated.avatarBlobUrl)!=null?t:super.avatarUrl(e)}}class md{constructor(e){this._parts=e.split(" ").map(t=>t.toLowerCase().trim())}matches(e){const t=e.name.toLowerCase();return this._parts.every(s=>t.includes(s))}}class pd extends kt{constructor(e,t){super(),this._source=e,this._apply=t,this._subscription=null}hasApply(){return!!this._apply}setApply(e){this._apply=e,e&&this.applyOnce(this._apply)}applyOnce(e){for(const[t,s]of this._source)e(t,s)}onAdd(e,t){this._apply&&this._apply(e,t),this.emitAdd(e,t)}onRemove(e,t){this.emitRemove(e,t)}onUpdate(e,t,s){this._apply&&this._apply(e,t,s),this.emitUpdate(e,t,s)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._apply&&this.applyOnce(this._apply),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription()}onReset(){this._apply&&this.applyOnce(this._apply),this.emitReset()}[Symbol.iterator](){return this._source[Symbol.iterator]()}get size(){return this._source.size}get(e){return this._source.get(e)}}class _d{constructor(e){this._allowsChild=e,this._path=new Re([],e),this._observables=new Map,this._pathObservable=new we(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,t=void 0){return this.applyPath(this.path.with(new se(e,t)))}applyPath(e){const t=this._path;this._path=e;for(let s=t.segments.length-1;s>=0;s-=1){const i=t.segments[s];if(!this._path.get(i.type)){const n=this._observables.get(i.type);n==null||n.emitIfChanged()}}for(const s of this._path.segments){const i=this._observables.get(s.type);i==null||i.emitIfChanged()}this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new fd(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,s;for(s=0;s<e.length;s+=1){if(!this._allowsChild(t,e[s]))return new Re(e.slice(0,s),this._allowsChild);t=e[s]}return new Re(e,this._allowsChild)}segment(e,t){return new se(e,t)}}function gd(r,e){if(r===e)return!0;if(Array.isArray(r)&&Array.isArray(e)){const t=Math.max(r.length,e.length);for(let s=0;s<t;s+=1)if(r[s]!==e[s])return!1;return!0}return!1}class se{constructor(e,t){this.type=e,this.value=t===void 0?!0:t}}class Re{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new Re(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const s=this._segments.slice(0,t+1);return s.push(e),new Re(s,this._allowsChild)}t-=1}while(t>=-1);return null}until(e){const t=this._segments.findIndex(s=>s.type===e);return t!==-1?new Re(this._segments.slice(0,t+1),this._allowsChild):new Re([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){const t=this._segments.findIndex(s=>s.type===e.type);if(t!==-1){const s=this._segments[t-1];if(this._allowsChild(s,e)){const i=this._segments[t+1];if(!i||this._allowsChild(e,i)){const n=this._segments.slice();return n[t]=e,new Re(n,this._allowsChild)}}}return null}get segments(){return this._segments}}class fd extends It{constructor(e,t){var s;super(),this._navigation=e,this._type=t,this._lastSetValue=(s=e.path.get(t))==null?void 0:s.value}get(){const t=this._navigation.path.get(this._type);return t==null?void 0:t.value}emitIfChanged(){const e=this.get();gd(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}class yd{constructor({history:e,navigation:t,parseUrlPath:s,stringifyPath:i}){this._history=e,this._navigation=t,this._parseUrlPath=s,this._stringifyPath=i,this._subscription=null,this._pathSubscription=null,this._isApplyingUrl=!1,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){var s;const t=(s=this._urlAsNavPath(this._history.getLastUrl()||"").get("session"))==null?void 0:s.value;return typeof t=="string"?t:null}attach(){this._subscription=this._history.subscribe(e=>this._applyUrl(e)),this._pathSubscription=this._navigation.pathObservable.subscribe(e=>this._applyNavPathToHistory(e)),this._applyUrl(this._history.get())}dispose(){this._subscription=this._subscription(),this._pathSubscription=this._pathSubscription()}_applyNavPathToHistory(e){const t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){const t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){const t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){const e=this._urlAsNavPath(this._history.getLastUrl()||"");return e.segments.length!==0?(this._applyNavPathToNavigation(e),!0):!1}urlForSegments(e){let t=this._navigation.path;for(const s of e)if(t=t.with(s),!t)return;return this.urlForPath(t)}urlForSegment(e,t){return this.urlForSegments([this._navigation.segment(e,t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){const t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${e}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.origin}normalizeUrl(){this._history.replaceUrlSilently(`${window.location.origin}/${window.location.hash}`)}}function wd(){return new _d(bd)}function vd({history:r,navigation:e}){return new yd({history:r,navigation:e,stringifyPath:Ed,parseUrlPath:Id})}function bd(r,e){const{type:t}=e;switch(r==null?void 0:r.type){case void 0:return t==="login"||t==="session"||t==="sso"||t==="logout";case"session":return t==="room"||t==="rooms"||t==="settings"||t==="create-room";case"rooms":return t==="room"||t==="empty-grid-tile";case"room":return t==="lightbox"||t==="right-panel";case"right-panel":return t==="details"||t==="members"||t==="member";default:return!1}}function Sd(r,e,t){if(r.value.includes(e))return r;{const s=t.get("empty-grid-tile"),i=t.get("room");let n=0;s?n=s.value:i&&(n=r.value.indexOf(i.value));const o=r.value.slice();return o[n]=e,new se("rooms",o)}}function Hr(r,e,t=!0){r.push(new se("right-panel")),r.push(new se(e,t))}function gi(r,e){const t=r.path.segments,s=t.findIndex(n=>n.type==="right-panel");let i=e;return s!==-1&&(i=e.until("room"),i=i.with(t[s]),i=i.with(t[s+1])),i}function Id(r,e,t){const s=r.substr(1).split("/"),i=s[Symbol.iterator](),n=[];let o;for(;!(o=i.next()).done;){const a=o.value;if(a==="rooms"){const c=i.next().value;if(c===void 0)break;const l=c.split(",");n.push(new se(a,l));const h=parseInt(i.next().value||"0",10),d=l[h];d?n.push(new se("room",d)):n.push(new se("empty-grid-tile",h))}else if(a==="open-room"){const c=i.next().value;if(!c)break;const l=e.get("rooms");if(l&&n.push(Sd(l,c,e)),n.push(new se("room",c)),s.findIndex(m=>m==="open-room")>=s.length-2){const m=e.segments,p=m.findIndex(_=>_.type==="right-panel");p!==-1&&n.push(...m.slice(p))}}else if(a==="last-session"){let c=e.get("session");typeof(c==null?void 0:c.value)!="string"&&t&&(c=new se("session",t)),c&&n.push(c)}else if(a==="details"||a==="members")Hr(n,a);else if(a==="member"){const c=i.next().value;if(!c)break;Hr(n,a,c)}else if(a.includes("loginToken")){const c=a.split("=").pop();n.push(new se("sso",c))}else{const c=i.next().value;n.push(new se(a,c))}}return n}function Ed(r){let e="",t;for(const s of r.segments){switch(s.type){case"rooms":e+=`/rooms/${s.value.join(",")}`;break;case"empty-grid-tile":e+=`/${s.value}`;break;case"room":(t==null?void 0:t.type)==="rooms"?e+=`/${t.value.indexOf(s.value)}`:e+=`/${s.type}/${s.value}`;break;case"right-panel":case"sso":continue;default:e+=`/${s.type}`,s.value&&s.value!==!0&&(e+=`/${s.value}`)}t=s}return e}class kd extends R{constructor(e){super(e);const{session:t}=e;this._tileViewModelsMap=this._mapTileViewModels(t.roomsBeingCreated,t.invites,t.rooms),this._tileViewModelsFilterMap=new pd(this._tileViewModelsMap),this._tileViewModels=this._tileViewModelsFilterMap.sortValues((s,i)=>s.compare(i)),this._currentTileVM=null,this._setupNavigation(),this._closeUrl=this.urlCreator.urlForSegment("session"),this._settingsUrl=this.urlCreator.urlForSegment("settings"),this._createRoomUrl=this.urlCreator.urlForSegment("create-room")}_mapTileViewModels(e,t,s){return t.join(e,s).mapValues((n,o)=>{var l;let a;return n.isBeingCreated?a=new ud(this.childOptions({roomBeingCreated:n,emitChange:o})):n.isInvite?a=new dd(this.childOptions({invite:n,emitChange:o})):a=new hd(this.childOptions({room:n,emitChange:o})),((l=this.navigation.path.get("room"))==null?void 0:l.value)===n.id&&(a.open(),this._updateCurrentVM(a)),a})}_updateCurrentVM(e){var t;(t=this._currentTileVM)==null||t.close(),this._currentTileVM=e}get closeUrl(){return this._closeUrl}get settingsUrl(){return this._settingsUrl}get createRoomUrl(){return this._createRoomUrl}_setupNavigation(){const e=this.navigation.observe("room");this.track(e.subscribe(s=>this._open(s)));const t=this.navigation.observe("rooms");this.gridEnabled=!!t.get(),this.track(t.subscribe(s=>{const i=this.gridEnabled^!!s;this.gridEnabled=!!s,i&&this.emitChange("gridEnabled")}))}_open(e){var t,s;(t=this._currentTileVM)==null||t.close(),this._currentTileVM=null,e&&(this._currentTileVM=this._tileViewModelsMap.get(e),(s=this._currentTileVM)==null||s.open())}toggleGrid(){const e=this.navigation.path.get("room");let t=this.navigation.path.until("session");this.gridEnabled?e&&(t=t.with(e),t=gi(this.navigation,t)):e?(t=t.with(this.navigation.segment("rooms",[e.value])),t=t.with(e),t=gi(this.navigation,t)):(t=t.with(this.navigation.segment("rooms",[])),t=t.with(this.navigation.segment("empty-grid-tile",0))),this.navigation.applyPath(t)}get tileViewModels(){return this._tileViewModels}clearFilter(){this._tileViewModelsFilterMap.setApply(null),this._tileViewModelsFilterMap.applyOnce((e,t)=>t.hidden=!1)}setFilter(e){if(e=e.trim(),e.length===0)return this.clearFilter(),!1;{const t=!this._tileViewModelsFilterMap.hasApply(),s=new md(e);return this._tileViewModelsFilterMap.setApply((i,n)=>{n.hidden=!s.matches(n)}),t}}}class ge{constructor(e,t,s,i){this._remove=e,this._update=t,this._replace=s,this._updateParams=i}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new ge(!0,!1,!1,null)}static Update(e){return new ge(!1,!0,!1,e)}static Nothing(){return new ge(!1,!1,!1,null)}static Replace(e){return new ge(!1,!1,!0,e)}}class Rd extends Et{constructor(e,t){super(),this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileOptions=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_createTile(e){const t=this._tileOptions.tileClassForEntry(e);if(t)return new t(e,this._tileOptions)}_emitSpontanousUpdate(e,t){const s=e.lowerEntry,i=this._findTileIdx(s);this.emitUpdate(i,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._tiles=[];let e=null;for(let s of this._entries)(!e||!e.tryIncludeEntry(s))&&(e=this._createTile(s),e&&this._tiles.push(e));let t=null;for(let s of this._tiles)t&&t.updateNextSibling(s),s.updatePreviousSibling(t),t=s;t&&t.updateNextSibling(null);for(const s of this._tiles)s.setUpdateEmit(this._emitSpontanousUpdate)}_findTileIdx(e){return He(this._tiles,e,(t,s)=>-s.compareEntry(t))}_findTileAtIdx(e,t){const s=this._getTileAtIdx(t);if(s&&s.compareEntry(e)===0)return s}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const s=this._findTileIdx(t),i=this._getTileAtIdx(s-1);if(i&&i.tryIncludeEntry(t)){this.emitUpdate(s-1,i);return}const n=this._getTileAtIdx(s);if(n&&n.tryIncludeEntry(t)){this.emitUpdate(s,n);return}const o=this._createTile(t);o&&(i&&(i.updateNextSibling(o),o.updatePreviousSibling(i)),n&&(o.updateNextSibling(n),n.updatePreviousSibling(o)),this._tiles.splice(s,0,o),this.emitAdd(s,o),o.setUpdateEmit(this._emitSpontanousUpdate))}onUpdate(e,t,s){if(!this._tiles)return;const i=this._findTileIdx(t),n=this._findTileAtIdx(t,i);if(n){const o=n.updateEntry(t,s);if(o.shouldReplace){const a=this._createTile(t);a?(this._replaceTile(i,n,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(i,n)}o.shouldRemove&&this._removeTile(i,n),o.shouldUpdate&&this.emitUpdate(i,n,o.updateParams)}}_replaceTile(e,t,s,i){t.dispose();const n=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=s,n==null||n.updateNextSibling(s),s.updatePreviousSibling(n),s.updateNextSibling(o),o==null||o.updatePreviousSibling(s),this.emitUpdate(e,s,i)}_removeTile(e,t){const s=this._getTileAtIdx(e-1),i=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),s==null||s.updateNextSibling(i),i==null||i.updatePreviousSibling(s)}onRemove(e,t){const s=this._findTileIdx(t),i=this._findTileAtIdx(t,s);i&&(i.removeEntry(t)?this._removeTile(s,i):this.emitUpdate(s,i))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=He(this._tiles,e,(i,n)=>i.compare(n)),s=this._tiles[t];return(s==null?void 0:s.compare(e))===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class Cd extends R{constructor(e){super(e);const{timeline:t,tileOptions:s}=e;this._timeline=this.track(t),this._tiles=new Rd(t.entries,s),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let s;if(e&&t){this._startTile=e,this._endTile=t;const i=this._tiles.getTileIndex(this._startTile),n=this._tiles.getTileIndex(this._endTile);for(const o of this._tiles.sliceIterator(i,n+1))o.notifyVisible();s=i<10,this._setShowJumpDown(n<this._tiles.length-1)}else s=!0,this._setShowJumpDown(!1);s&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(i=>{this._topLoadingPromise=null,i||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class Td extends R{constructor(e){super(e.options),this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){var s;(new Boolean(e)!==new Boolean(this._replyVM)||!((s=this._replyVM)!=null&&s.id.equals(e.asEventKey())))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e)),this._replyVM.notifyVisible()),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}function qt(r){return{w:r.width,h:r.height,mimetype:r.blob.mimeType,size:r.blob.size}}class es extends R{constructor(e,t){super(t),this._entry=e,this._emitUpdate=void 0}get shape(){return null}get isContinuation(){return!1}get hasDateSeparator(){return!1}get id(){return this._entry.asEventKey()}get eventId(){return this._entry.id}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==M.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}abortSending(){var e;(e=this._entry.pendingEvent)==null||e.abort()}setUpdateEmit(e){this._emitUpdate=e}emitChange(e){this._emitUpdate&&this._emitUpdate(this,e),super.emitChange(e)}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}compare(e){return this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const s=this.shape==="redacted";return!e.isGap&&e.isRedacted!==s?ge.Replace("shape"):(this._entry=e,ge.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(){}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(null),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this._options.roomVM}get _timeline(){return this._options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this._options.timeline.me}}class Md extends es{constructor(e,t){super(e,t),this._loading=!1,this._error=null,this._isAtTop=!0,this._siblingChanged=!1}async fill(){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(e){throw console.error(`room.fillGap(): ${e.message}:
${e.stack}`),this._error=e,this.emitChange("error"),e}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t){return super.updateEntry(e,t),e.isGap?ge.Nothing():ge.Remove()}get shape(){return"gap"}get isLoading(){return this._loading}get error(){return this._error?`Could not load ${this._entry.prev_batch?"previous":"next"} messages: ${this._error.message}`:null}}class Ad{constructor(e){this._parentTile=e,this._map=new $t,this._reactions=this._map.sortValues((t,s)=>t._compare(s))}update(e,t){if(e){for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],n=this._map.get(s);n?n._tryUpdate(i)&&this._map.update(s):this._map.add(s,new zr(s,i,null,this._parentTile))}}if(t)for(const[s,i]of t.entries()){const n=this._map.get(s);n?(n._tryUpdatePending(i),this._map.update(s)):this._map.add(s,new zr(s,null,i,this._parentTile))}for(const s of this._map.keys()){const i=t==null?void 0:t.has(s),n=e==null?void 0:e.hasOwnProperty(s);!n&&!i?this._map.remove(s):n?i||this._map.get(s)._tryUpdatePending(null)&&this._map.update(s):this._map.get(s)._tryUpdate(null)&&this._map.update(s)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class zr{constructor(e,t,s,i){this._key=e,this._annotation=t,this._pending=s,this._parentTile=i,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,i=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||i?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){var e,t;return(((e=this._pending)==null?void 0:e.count)||0)+(((t=this._annotation)==null?void 0:t.count)||0)}get isPending(){return this._pending!==null}get isActive(){var e;return((e=this._annotation)==null?void 0:e.me)||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}class Ge extends es{constructor(e,t){super(e,t),this._date=this._entry.timestamp?new Date(this._entry.timestamp):null,this._isContinuation=!1,this._reactions=null,this._replyTile=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions(),this._updateReplyTileIfNeeded(void 0)}notifyVisible(){var e;super.notifyVisible(),(e=this._replyTile)==null||e.notifyVisible()}get _mediaRepository(){return this._room.mediaRepository}get permaLink(){return`https://matrix.to/#/${encodeURIComponent(this._room.id)}/${encodeURIComponent(this._entry.id)}`}get senderProfileLink(){return`https://matrix.to/#/${encodeURIComponent(this.sender)}`}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}get memberPanelLink(){return`${this.urlCreator.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return de(this._entry.sender)}avatarUrl(e){return Le(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return he(this.sender)}get avatarTitle(){return this.displayName}get date(){return this._date&&this._date.toLocaleDateString({},{month:"numeric",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}get isReply(){return this._entry.isReply}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof Ge&&e.sender===this.sender){const s=this._entry.timestamp,i=e._entry.timestamp;t=s-i<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t){const s=super.updateEntry(e,t);return s.shouldUpdate&&this._updateReactions(),this._updateReplyTileIfNeeded(t),s}_updateReplyTileIfNeeded(e){var s,i;const t=this._entry.contextEntry;if(t){const n=(s=this._replyTile)==null?void 0:s.updateEntry(t,e);if((n==null?void 0:n.shouldReplace)||!this._replyTile){this.disposeTracked(this._replyTile);const a=this._options.tileClassForEntry(t);a&&(this._replyTile=new a(t,this._options))}n!=null&&n.shouldUpdate&&((i=this._replyTile)==null||i.emitChange())}}startReply(){this._roomVM.startReply(this._entry)}reply(e,t,s=null){return this._room.sendEvent("m.room.message",this._entry.reply(e,t),null,s)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async s=>{var n,o;if(!this.canReact){s.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){s.set("already_reacted",!0);return}const i=(o=(n=this._entry.pendingAnnotations)==null?void 0:n.get(e))==null?void 0:o.redactionEntry;i&&!i.pendingEvent.hasStartedSending?(s.set("abort_redaction",!0),await i.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,s)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async s=>{var n,o;if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){s.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){s.set("not_yet_reacted",!0);return}let i=(o=(n=this._entry.pendingAnnotations)==null?void 0:n.get(e))==null?void 0:o.annotationEntry;i||(i=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),i?await this._room.sendRedaction(i.id,null,s):s.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async s=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,s):await this.react(e,s)})}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new Ad(this)),this._reactions.update(e,t))}get replyTile(){return this._entry.contextEventId?this._replyTile:null}}const xd="(?:https|http|ftp):\\/\\/",co="[^\\s.,?!)]",Gr="[a-zA-Z0-9:.\\[\\]-]",Nd=`${Gr}*(?=${Gr})${co}`,Dd=`(?:[\\/#](?:[^\\s]*${co})?)`,Ld=`${xd}${Nd}${Dd}?`,Od=new RegExp(Ld,"gi");function lo(r,e){const t=r.matchAll(Od);let s=0;for(let n of t){const o=r.slice(s,n.index);e(o,!1),e(n[0],!0);const a=n[0].length;s=n.index+a}const i=r.slice(s);e(i,!1)}function Ud(r){const e=[],t=r.split(`
`),s=(i,n)=>{n?e.push(new fi(i,[new vt(i)])):e.push(new vt(i))};for(let i=0;i<t.length;i+=1){const n=t[i];n.length&&lo(n,s),i>=t.length-1||e.push(new ho)}return new Ki(r,e)}function Pd(r){return new Ki(r,[new vt(r)])}class Vd{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class Jr{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class Bd{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class Fd{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class Kd{get type(){return"rule"}}class ho{get type(){return"newline"}}class gs{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class $d{constructor(e,t,s,i,n){this.src=e,this.width=t,this.height=s,this.alt=i,this.title=n}get type(){return"image"}}class qd{constructor(e,t,s){this.id=e,this.href=t,this.children=s}get type(){return"pill"}get avatarColorNumber(){return de(this.id)}get avatarInitials(){return he(this.id)}}class fi{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class vt{constructor(e){this.text=e}get type(){return"text"}}function jd(r){return r.type==="format"&&r.format==="blockquote"}class Ki{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&jd(this.parts[t]);t++);this.parts.splice(t,0,new vt(e))}}const Vt=Ne("Plain","Html");class uo extends Ge{constructor(e,t){super(e,t),this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return Pd(e)}_getBodyFormat(){return Vt.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const Wd=["EM","STRONG","CODE","DEL","SPAN"],Hd=["DIV","BLOCKQUOTE"],zd=["https","http","ftp","mailto","magnet"].map(r=>`${r}://`),Gd="https://matrix.to",Qr=`${Gd}/#/`;class Jd{constructor(e,t){this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(Qr))return null;const t=e.substring(Qr.length);return t[0]==="@"?t:null}parseLink(e,t){const s=this.result.getAttributeValue(e,"href"),i=s==null?void 0:s.toLowerCase();if(!i||!zd.some(o=>i.startsWith(o)))return new gs("span",t);const n=this.parsePillLink(s);return n?new qd(n,s,t):new fi(s,t)}parseList(e){const t=this.result;let s=null;t.getNodeElementName(e)==="OL"&&(s=parseInt(t.getAttributeValue(e,"start"))||1);const i=[];for(const n of t.getChildNodes(e)){if(t.getNodeElementName(n)!=="LI")continue;const o=this.parseAnyNodes(t.getChildNodes(n));i.push(o)}return new Bd(s,i)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let s;for(const o of t.getChildNodes(e)){s=o;break}let i=null;if(!this._ensureElement(s,"CODE"))return new Jr(i,this.result.getNodeText(e));const n=t.getAttributeValue(s,"class")||"";for(const o of n.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){i=o.substring(9);break}return new Jr(i,this.result.getNodeText(s))}parseImage(e){const t=this.result,s=t.getAttributeValue(e,"src")||"",i=this.mediaRepository.mxcUrl(s);if(!i)return null;const n=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),c=t.getAttributeValue(e,"title");return new $d(i,n,o,a,c)}parseTableRow(e,t){const s=[];for(const i of this.result.getChildNodes(e)){if(!this._ensureElement(i,t))continue;const n=this.result.getChildNodes(i),o=this.parseInlineNodes(n);s.push(o)}return s}parseTableHead(e){let t=null;for(const s of this.result.getChildNodes(e)){t=s;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const s of this.result.getChildNodes(e))!this._ensureElement(s,"TR")||t.push(this.parseTableRow(s,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let s,i;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(s=this.parseTableHead(t[0]),i=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(s=null,i=this.parseTableBody(t[0])),new Fd(s,i)}parseInlineElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"A":{const n=this.parseInlineNodes(i);return this.parseLink(e,n)}case"BR":return new ho;default:{if(!Wd.includes(s))return null;const n=this.parseInlineNodes(i);return new gs(s,n)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const n=this.parseInlineNodes(i);return new Vd(parseInt(s[1]),n)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new Kd;case"IMG":return this.parseImage(e);case"P":{const n=this.parseInlineNodes(i);return new gs(s,n)}case"TABLE":return this.parseTable(e);default:{if(!Hd.includes(s))return null;const n=this.parseAnyNodes(i);return new gs(s,n)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;const s=(i,n)=>{n?t.push(new fi(i,[new vt(i)])):t.push(new vt(i))};return lo(this.result.getNodeText(e),s),!0}_isAllowedNode(e){return!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseInlineNodes(this.result.getChildNodes(s),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s)||this.parseBlockNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseAnyNodes(this.result.getChildNodes(s),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}function Qd(r,e,t){const s=r.parseHTML(t),n=new Jd(s,e).parseAnyNodes(s.rootNodes);return new Ki(t,n)}class Yd extends uo{_getContentString(e){var t;return((t=this._getContent())==null?void 0:t[e])||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===Vt.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){var e;return((e=this._getContent())==null?void 0:e.format)==="org.matrix.custom.html"?Vt.Html:Vt.Plain}_parseBody(e,t){var i;let s;return t===Vt.Html?s=Qd(this.platform,this._mediaRepository,e):s=Ud(e),((i=this._getContent())==null?void 0:i.msgtype)==="m.emote"&&s.insertEmote(`* ${this.displayName} `),s}}class Yr extends Ge{get shape(){return"redacted"}get description(){const{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})…`:this.i18n`This message is being deleted…`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}}const Xd=300,Zd=400;class mo extends Ge{constructor(e,t){super(e,t),this._decryptedThumbnail=null,this._decryptedFile=null,this._isVisible=!1,this._error=null,this._downloading=!1,this._downloadError=null}async downloadMedia(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("status");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s==null||s.dispose(),this._downloading=!1}this.emitChange("status")}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===M.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get status(){const{pendingEvent:e}=this._entry;switch(e==null?void 0:e.status){case M.Waiting:return this.i18n`Waiting…`;case M.EncryptingAttachments:case M.Encrypting:return this.i18n`Encrypting…`;case M.UploadingAttachments:return this.i18n`Uploading…`;case M.Sending:return this.i18n`Sending…`;case M.Error:return this.i18n`Error: ${e.error.message}`;default:return this._downloadError?"Download failed":this._downloading?this.i18n`Downloading…`:""}}get thumbnailUrl(){var e,t;if(!this._isVisible)return"";if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const s=(e=this._getContent().info)==null?void 0:e.thumbnail_url;if(s)return this._mediaRepository.mxcUrlThumbnail(s,this.width,this.height,"scale")}if(this._entry.isPending){const s=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return s&&s.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const s=(t=this._getContent())==null?void 0:t.url;if(typeof s=="string")return this._mediaRepository.mxcUrlThumbnail(s,this.width,this.height,"scale")}}return""}notifyVisible(){super.notifyVisible(),this._isVisible=!0,this.emitChange("thumbnailUrl"),this.isPending||this._tryLoadEncryptedThumbnail()}get width(){var t;const e=(t=this._getContent())==null?void 0:t.info;return Math.round((e==null?void 0:e.w)*this._scaleFactor())}get height(){var t;const e=(t=this._getContent())==null?void 0:t.info;return Math.round((e==null?void 0:e.h)*this._scaleFactor())}get mimeType(){var t;const e=(t=this._getContent())==null?void 0:t.info;return e==null?void 0:e.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){var e;try{const t=(e=this._getContent().info)==null?void 0:e.thumbnail_file,s=this._getContent().file;t?(this._decryptedThumbnail=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl")):s&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(s),this.emitChange("thumbnailUrl"))}catch(t){this._error=t,this.emitChange("error")}}_scaleFactor(){var i;const e=(i=this._getContent())==null?void 0:i.info,t=Xd/(e==null?void 0:e.h),s=Zd/(e==null?void 0:e.w);return Math.min(s,t,1)}_isMainResourceImage(){return!0}}class eu extends mo{constructor(e,t){super(e,t),this._lightboxUrl=this.urlCreator.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class tu extends mo{async loadVideo(){const e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){var t;if(this._decryptedFile)return this._decryptedFile.url;const e=(t=this._getContent())==null?void 0:t.url;return typeof e=="string"?this._mediaRepository.mxcUrl(e):""}get shape(){return"video"}_isMainResourceImage(){return!1}}function su(r,e=2){if(Number.isSafeInteger(r)){const t=Math.min(3,Math.floor(Math.log(r)/Math.log(1024))),s=Math.round(r/Math.pow(1024,t)).toFixed(e);switch(t){case 0:return`${s} bytes`;case 1:return`${s} KB`;case 2:return`${s} MB`;case 3:return`${s} GB`}}return""}class iu extends Ge{constructor(e,t){super(e,t),this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("label");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s==null||s.dispose(),this._downloading=!1}this.emitChange("label")}get label(){var s;if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;const t=this._getContent().body;if(this._entry.isPending){const{pendingEvent:i}=this._entry;switch(i==null?void 0:i.status){case M.Waiting:return this.i18n`Waiting to send ${t}…`;case M.EncryptingAttachments:case M.Encrypting:return this.i18n`Encrypting ${t}…`;case M.UploadingAttachments:{const n=Math.round(i.attachmentsSentBytes/i.attachmentsTotalBytes*100);return this.i18n`Uploading ${t}: ${n}%`}case M.Sending:case M.Sent:return this.i18n`Sending ${t}…`;case M.Error:return this.i18n`Error: could not send ${t}: ${i.error.message}`;default:return`Unknown send status for ${t}`}}else{const i=su((s=this._getContent().info)==null?void 0:s.size);return this._downloading?this.i18n`Downloading ${t} (${i})…`:this.i18n`Download ${t} (${i})`}}get shape(){return"file"}}class ru extends Ge{get shape(){return"location"}get mapsLink(){try{const e=new URL(this._getContent().geo_uri);if(e.protocol!=="geo:")return"";const[t,...s]=e.pathname.split(";"),[i,n]=t.split(","),o=parseFloat(i),a=parseFloat(n);let c;for(const l of s){const[h,d]=l.split("=");h==="u"&&(c=parseFloat(d))}if(this.platform.isIOS)return`http://maps.apple.com/?ll=${o},${a}`;{let l=`geo:${o},${a}`;return c&&(l=l+`;u=${c}`),l}}catch{return""}}get label(){return this.i18n`${this.displayName} sent their location`}}class nu extends es{get shape(){return"announcement"}get announcement(){const e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e==null?void 0:e.name}"`}}class ou extends es{get shape(){return"announcement"}get announcement(){var l,h;const{sender:e,content:t,prevContent:s,stateKey:i}=this._entry,n=this._entry.displayName||e,o=e===i?n:((l=this._entry.content)==null?void 0:l.displayname)||i,a=t&&t.membership,c=s&&s.membership;if(c==="join"&&a==="join"){if(t.avatar_url!==s.avatar_url)return`${n} changed their avatar`;if(t.displayname!==s.displayname)return t.displayname?`${(h=s.displayname)!=null?h:i} changed their name to ${t.displayname}`:`${i} removed their name (${s.displayname})`}else{if(a==="join")return`${o} joined the room`;if(a==="invite")return`${o} was invited to the room by ${n}`;if(c==="invite"){if(a==="join")return`${o} accepted the invitation to join the room`;if(a==="leave")return`${o} declined the invitation to join the room`}else if(a==="leave"){if(i===e)return`${o} left the room`;{const d=t.reason;return`${o} was kicked from the room by ${n}${d?`: ${d}`:""}`}}else if(a==="ban")return`${o} was banned from the room by ${n}`}return`${e} membership changed to ${t.membership}`}}class au extends uo{updateEntry(e,t){const s=super.updateEntry(e,t);return e.eventType!=="m.room.encrypted"?ge.Replace("shape"):s}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e==null?void 0:e.code;let s;return t==="MEGOLM_NO_SESSION"?s=this.i18n`The sender hasn't sent us the key for this message yet.`:s=(e==null?void 0:e.message)||this.i18n`Could not decrypt message because of unknown reason.`,s}}class cu extends es{get shape(){return"announcement"}get announcement(){const e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}}class lu extends Ge{get shape(){return"missing-attachment"}get label(){const e=this._getContent().body;return this._getContent().msgtype==="m.image"?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}}function hu(r){if(r.isGap)return Md;if(r.isPending&&r.pendingEvent.isMissingAttachments)return lu;if(r.eventType)switch(r.eventType){case"m.room.message":{if(r.isRedacted)return Yr;const e=r.content;switch(e&&e.msgtype){case"m.text":case"m.notice":case"m.emote":return Yd;case"m.image":return eu;case"m.video":return tu;case"m.file":return iu;case"m.location":return ru;default:return}}case"m.room.name":return nu;case"m.room.member":return ou;case"m.room.encrypted":return r.isRedacted?Yr:au;case"m.room.encryption":return cu;default:return}}class Xr extends R{constructor(e){super(e);const{room:t,tileClassForEntry:s}=e;this._room=t,this._timelineVM=null,this._tileClassForEntry=s!=null?s:hu,this._tileOptions=void 0,this._onRoomChange=this._onRoomChange.bind(this),this._timelineError=null,this._sendError=null,this._composerVM=null,t.isArchived?this._composerVM=new uu(this.childOptions({archivedRoom:t})):this._composerVM=new Td(this),this._clearUnreadTimout=null,this._closeUrl=this.urlCreator.urlUntilSegment("session")}async load(){this._room.on("change",this._onRoomChange);try{const e=await this._room.openTimeline();this._tileOptions=this.childOptions({roomVM:this,timeline:e,tileClassForEntry:this._tileClassForEntry}),this._timelineVM=this.track(new Cd(this.childOptions({tileOptions:this._tileOptions,timeline:e}))),this.emitChange("timelineViewModel")}catch(e){console.error(`room.openTimeline(): ${e.message}:
${e.stack}`),this._timelineError=e,this.emitChange("error")}this._clearUnreadAfterDelay()}async _clearUnreadAfterDelay(){if(!(this._room.isArchived||this._clearUnreadTimout)){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(),this._clearUnreadTimout=null}catch(e){if(e.name!=="AbortError")throw e}}}focus(){this._clearUnreadAfterDelay()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){this._composerVM.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get error(){return this._timelineError?`Something went wrong loading the timeline: ${this._timelineError.message}`:this._sendError?`Something went wrong sending your message: ${this._sendError.message}`:""}get avatarLetter(){return he(this.name)}get avatarColorNumber(){return de(this._room.avatarColorId)}avatarUrl(e){return Le(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){if(this._tileOptions){const t=this._tileOptions.tileClassForEntry(e);if(t)return new t(e,this._tileOptions)}}async _sendMessage(e,t){if(!this._room.isArchived&&e){try{let s="m.text";e.startsWith("/me ")&&(e=e.substr(4).trim(),s="m.emote"),t?await t.reply(s,e):await this._room.sendEvent("m.room.message",{msgtype:s,body:e})}catch(s){return console.error(`room.sendMessage(): ${s.message}:
${s.stack}`),this._sendError=s,this._timelineError=null,this.emitChange("error"),!1}return!0}return!1}async _pickAndSendFile(){try{const e=await this.platform.openFile();return e?this._sendFile(e):void 0}catch(e){console.error(e)}}async _sendFile(e){const t={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",t,{url:this._room.createAttachment(e.blob,e.name)})}async _pickAndSendVideo(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const e=await this.platform.openFile("video/*");if(!e)return;if(!e.blob.mimeType.startsWith("video/"))return this._sendFile(e);let t;try{t=await this.platform.loadVideo(e.blob)}catch(c){throw c instanceof window.MediaError&&c.code===4?new Error(`this browser does not support videos of type ${e==null?void 0:e.blob.mimeType}.`):c}const s={body:e.name,msgtype:"m.video",info:du(t)},i={url:this._room.createAttachment(t.blob,e.name)},o=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(t.maxDimension,800),a=await t.scale(o);s.info.thumbnail_info=qt(a),i["info.thumbnail_url"]=this._room.createAttachment(a.blob,e.name),await this._room.sendEvent("m.room.message",s,i)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}async _pickAndSendPicture(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const e=await this.platform.openFile("image/*");if(!e)return;if(!e.blob.mimeType.startsWith("image/"))return this._sendFile(e);let t=await this.platform.loadImage(e.blob);const s=await this.platform.settingsStorage.getInt("sentImageSizeLimit");if(s&&t.maxDimension>s){const o=await t.scale(s);t.dispose(),t=o}const i={body:e.name,msgtype:"m.image",info:qt(t)},n={url:this._room.createAttachment(t.blob,e.name)};if(t.maxDimension>600){const o=await t.scale(400);i.info.thumbnail_info=qt(o),n["info.thumbnail_url"]=this._room.createAttachment(o.blob,e.name)}await this._room.sendEvent("m.room.message",i,n)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}get room(){return this._room}get composerViewModel(){return this._composerVM}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}}function du(r){const e=qt(r);return e.duration=r.duration,e}class uu extends R{constructor(e){super(e),this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"archived"}}class mu extends R{constructor(e){super(e);const{roomIdOrAlias:t,session:s}=e;this._session=s,this.roomIdOrAlias=t,this._error=null,this._busy=!1}get error(){var e;return(e=this._error)==null?void 0:e.message}async join(){this._busy=!0,this.emitChange("busy");try{const e=await this._session.joinRoom(this.roomIdOrAlias);this.navigation.push("room",e)}catch(e){this._error=e,this._busy=!1,this.emitChange("error")}}get busy(){return this._busy}get kind(){return"unknown"}}class pu extends R{constructor(e){super(e);const{invite:t,mediaRepository:s}=e;this._invite=t,this._mediaRepository=s,this._onInviteChange=this._onInviteChange.bind(this),this._error=null,this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._invite.on("change",this._onInviteChange),this._inviter=null,this._invite.inviter&&(this._inviter=new _u(this._invite.inviter,s,this.platform)),this._roomDescription=this._createRoomDescription()}get kind(){return"invite"}get closeUrl(){return this._closeUrl}get name(){return this._invite.name}get id(){return this._invite.id}get isEncrypted(){return this._invite.isEncrypted}get isDirectMessage(){return this._invite.isDirectMessage}get inviter(){return this._inviter}get busy(){return this._invite.accepting||this._invite.rejecting}get error(){return this._error?`Something went wrong: ${this._error.message}`:""}get avatarLetter(){return he(this.name)}get avatarColorNumber(){return de(this._invite.avatarColorId)}avatarUrl(e){return Le(this._invite.avatarUrl,e,this.platform,this._mediaRepository)}_createRoomDescription(){const e=[];return this._invite.isPublic?e.push("Public room"):e.push("Private room"),this._invite.canonicalAlias&&e.push(this._invite.canonicalAlias),e.join(" \u2022 ")}get roomDescription(){return this._roomDescription}get avatarTitle(){return this.name}focus(){}async accept(){try{await this._invite.accept()}catch(e){this._error=e,this.emitChange("error")}}async reject(){try{await this._invite.reject()}catch(e){this._error=e,this.emitChange("error")}}_onInviteChange(){this.emitChange()}dispose(){super.dispose(),this._invite.off("change",this._onInviteChange)}}class _u{constructor(e,t,s){this._member=e,this._mediaRepository=t,this._platform=s}get id(){return this._member.userId}get name(){return this._member.name}get avatarLetter(){return he(this.name)}get avatarColorNumber(){return de(this._member.userId)}avatarUrl(e){return Le(this._member.avatarUrl,e,this._platform,this._mediaRepository)}get avatarTitle(){return this.name}}class gu extends R{constructor(e){super(e);const{roomBeingCreated:t,mediaRepository:s}=e;this._roomBeingCreated=t,this._mediaRepository=s,this._onRoomChange=this._onRoomChange.bind(this),this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._roomBeingCreated.on("change",this._onRoomChange)}get kind(){return"roomBeingCreated"}get closeUrl(){return this._closeUrl}get name(){return this._roomBeingCreated.name}get id(){return this._roomBeingCreated.id}get isEncrypted(){return this._roomBeingCreated.isEncrypted}get error(){const{error:e}=this._roomBeingCreated;return e?e.name==="ConnectionError"?this.i18n`You seem to be offline`:e.message:""}get avatarLetter(){return he(this.name)}get avatarColorNumber(){return de(this._roomBeingCreated.avatarColorId)}get avatarTitle(){return this.name}avatarUrl(e){var t;return(t=this._roomBeingCreated.avatarBlobUrl)!=null?t:Le(this._roomBeingCreated.avatarUrl,e,this.platform,this._mediaRepository)}focus(){}_onRoomChange(){this.emitChange()}cancel(){this._roomBeingCreated.cancel(),this.navigation.applyPath(this.navigation.path.until("session"))}dispose(){super.dispose(),this._roomBeingCreated.off("change",this._onRoomChange)}}class fu extends R{constructor(e){super(e),this._eventId=e.eventId,this._unencryptedImageUrl=null,this._decryptedImage=null,this._closeUrl=this.urlCreator.urlUntilSegment("room"),this._eventEntry=null,this._date=null,this._subscribeToEvent(e.room,e.eventId)}_subscribeToEvent(e,t){const s=e.observeEvent(t);this.track(s.subscribe(i=>{this._loadEvent(e,i)})),this._loadEvent(e,s.get())}async _loadEvent(e,t){if(!t)return;const{mediaRepository:s}=e;this._eventEntry=t;const{content:i}=this._eventEntry;this._date=this._eventEntry.timestamp?new Date(this._eventEntry.timestamp):null,i.url?(this._unencryptedImageUrl=s.mxcUrl(i.url),this.emitChange("imageUrl")):i.file&&(this._decryptedImage=this.track(await s.downloadEncryptedFile(i.file)),this.emitChange("imageUrl"))}get imageWidth(){var e,t,s;return(s=(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.info)==null?void 0:s.w}get imageHeight(){var e,t,s;return(s=(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.info)==null?void 0:s.h}get name(){var e,t;return(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.body}get sender(){var e;return(e=this._eventEntry)==null?void 0:e.displayName}get imageUrl(){return this._decryptedImage?this._decryptedImage.url:this._unencryptedImageUrl?this._unencryptedImageUrl:""}get date(){return this._date&&this._date.toLocaleDateString({},{weekday:"long",year:"numeric",month:"long",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get closeUrl(){return this._closeUrl}close(){this.platform.history.pushUrl(this.closeUrl)}}const J=Ne("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");class yu extends R{constructor(e){super(e);const{sync:t,reconnector:s,session:i}=e;this._sync=t,this._reconnector=s,this._status=this._calculateState(s.connectionStatus.get(),t.status.get()),this._session=i,this._setupKeyBackupUrl=this.urlCreator.urlForSegment("settings"),this._dismissSecretStorage=!1}start(){const e=()=>this._updateStatus();this.track(this._sync.status.subscribe(e)),this.track(this._reconnector.connectionStatus.subscribe(e)),this.track(this._session.needsKeyBackup.subscribe(()=>{this.emitChange()}))}get setupKeyBackupUrl(){return this._setupKeyBackupUrl}get isShown(){return this._session.needsKeyBackup.get()&&!this._dismissSecretStorage||this._status!==J.Syncing}get statusLabel(){switch(this._status){case J.Disconnected:{const e=Math.round(this._reconnector.retryIn/1e3);return this.i18n`Disconnected, trying to reconnect in ${e}s…`}case J.Connecting:return this.i18n`Trying to reconnect now…`;case J.FirstSync:return this.i18n`Catching up with your conversations…`;case J.SyncError:return this.i18n`Sync failed because of ${this._sync.error}`}return this._session.needsKeyBackup.get()?this.i18n`Set up session backup to decrypt older messages.`:""}get isWaiting(){switch(this._status){case J.Connecting:case J.FirstSync:return!0;default:return!1}}_updateStatus(){const e=this._calculateState(this._reconnector.connectionStatus.get(),this._sync.status.get());e!==this._status&&(e===J.Disconnected?this._retryTimer=this.track(this.clock.createInterval(()=>{this.emitChange("statusLabel")},1e3)):this._retryTimer=this.disposeTracked(this._retryTimer),this._status=e,this.emitChange())}_calculateState(e,t){if(e!==Ft.Online)switch(e){case Ft.Reconnecting:return J.Connecting;case Ft.Waiting:return J.Disconnected}else if(t!==A.Syncing)switch(t){case A.InitialSync:case A.CatchupSync:return J.FirstSync;case A.Stopped:return J.SyncError}else return J.Syncing}get isConnectNowShown(){return this._status===J.Disconnected}get isSecretStorageShown(){return this._status===J.Syncing&&this._session.needsKeyBackup.get()&&!this._dismissSecretStorage}get canDismiss(){return this.isSecretStorageShown}dismiss(){this.isSecretStorageShown&&(this._dismissSecretStorage=!0,this.emitChange())}connectNow(){this.isConnectNowShown&&this._reconnector.tryNow()}}function Zr(r){return r.map((e,t)=>{if(!r.slice(0,t).includes(e))return e})}class wu extends R{constructor(e){super(e),this._width=e.width,this._height=e.height,this._createRoomViewModelObservable=e.createRoomViewModelObservable,this._selectedIndex=0,this._viewModelsObservables=[],this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("empty-grid-tile");this.track(e.subscribe(s=>{typeof s=="number"&&this._setFocusIndex(s)})),typeof e.get()=="number"&&(this._selectedIndex=e.get());const t=this.navigation.observe("room");this.track(t.subscribe(s=>{s&&this._setFocusRoom(s)}))}roomViewModelAt(e){var t;return(t=this._viewModelsObservables[e])==null?void 0:t.get()}get focusIndex(){return this._selectedIndex}get width(){return this._width}get height(){return this._height}_switchToRoom(e){let t=this.navigation.path.until("rooms");t=t.with(this.navigation.segment("room",e)),t=gi(this.navigation,t),this.navigation.applyPath(t)}focusTile(e){if(e===this._selectedIndex)return;const t=this._viewModelsObservables[e];t?this._switchToRoom(t.id):this.navigation.push("empty-grid-tile",e)}initializeRoomIdsAndTransferVM(e,t){e=Zr(e);let s=!1;if(t){const n=e.indexOf(t.id);n!==-1&&(this._viewModelsObservables[n]=this.track(t),t.subscribe(o=>this._refreshRoomViewModel(o)),s=!0)}this.setRoomIds(e);const i=this.navigation.path.get("room");if(i){const n=this._viewModelsObservables.findIndex(o=>o&&o.id===i.value);n!==-1&&(this._selectedIndex=n)}return s}setRoomIds(e){e=Zr(e);let t=!1;const s=this._height*this._width;for(let i=0;i<s;i+=1){const n=e[i],o=this._viewModelsObservables[i];if(!o&&n||o&&o.id!==n){if(o&&(this._viewModelsObservables[i]=this.disposeTracked(o)),n){const a=this._createRoomViewModelObservable(n);this._viewModelsObservables[i]=this.track(a),a.subscribe(c=>this._refreshRoomViewModel(c)),a.initialize()}t=!0}}return t&&this.emitChange(),t}_refreshRoomViewModel(e){this.emitChange(),e==null||e.focus()}releaseRoomViewModel(e){const t=this._viewModelsObservables.findIndex(s=>s&&s.id===e);if(t!==-1){const s=this._viewModelsObservables[t];return this.untrack(s),s.unsubscribeAll(),this._viewModelsObservables[t]=null,s}}_setFocusIndex(e){var s;if(e===this._selectedIndex||e>=this._width*this._height)return;this._selectedIndex=e;const t=this._viewModelsObservables[this._selectedIndex];(s=t==null?void 0:t.get())==null||s.focus(),this.emitChange("focusIndex")}_setFocusRoom(e){const t=this._viewModelsObservables.findIndex(s=>(s==null?void 0:s.id)===e);t>=0&&this._setFocusIndex(t)}}const ee=Ne("Enabled","SetupKey","SetupPhrase","Pending","NewVersionAvailable"),Dt=Ne("Writing","Stopped","Done","Pending");class vu extends R{constructor(e){super(e),this._session=e.session,this._error=null,this._isBusy=!1,this._dehydratedDeviceId=void 0,this._status=void 0,this._backupOperation=this._session.keyBackup.flatMap(t=>t.operationInProgress),this._progress=this._backupOperation.flatMap(t=>t.progress),this.track(this._backupOperation.subscribe(()=>{this._reevaluateStatus(),this.emitChange("isBackingUp")})),this.track(this._progress.subscribe(()=>this.emitChange("backupPercentage"))),this._reevaluateStatus(),this.track(this._session.keyBackup.subscribe(()=>{this._reevaluateStatus()&&this.emitChange("status")}))}_reevaluateStatus(){if(this._isBusy)return!1;let e;const t=this._session.keyBackup.get();t?e=t.needsNewKey?ee.NewVersionAvailable:ee.Enabled:t===null?e=this.showPhraseSetup()?ee.SetupPhrase:ee.SetupKey:e=ee.Pending;const s=e!==this._status;return this._status=e,s}get decryptAction(){return this.i18n`Set up`}get purpose(){return this.i18n`set up key backup`}offerDehydratedDeviceSetup(){return!0}get dehydratedDeviceId(){return this._dehydratedDeviceId}get isBusy(){return this._isBusy}get backupVersion(){var e;return(e=this._session.keyBackup.get())==null?void 0:e.version}get backupWriteStatus(){const e=this._session.keyBackup.get();if(e){if(e.hasStopped)return Dt.Stopped}else return Dt.Pending;return e.operationInProgress.get()?Dt.Writing:e.hasBackedUpAllKeys?Dt.Done:Dt.Pending}get backupError(){var e,t;return(t=(e=this._session.keyBackup.get())==null?void 0:e.error)==null?void 0:t.message}get status(){return this._status}get error(){var e;return(e=this._error)==null?void 0:e.message}showPhraseSetup(){this._status===ee.SetupKey&&(this._status=ee.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===ee.SetupPhrase&&(this._status=ee.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t,s){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const i=await this._session.enableSecretStorage(e,t);s&&(this._dehydratedDeviceId=await this._session.setupDehydratedDevice(i))}catch(i){console.error(i),this._error=i,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}enterSecurityPhrase(e,t){this._enterCredentials(Gt.Passphrase,e,t)}enterSecurityKey(e,t){this._enterCredentials(Gt.RecoveryKey,e,t)}async disable(){try{this._isBusy=!0,this.emitChange("isBusy"),await this._session.disableSecretStorage()}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}get isBackingUp(){return!!this._backupOperation.get()}get backupPercentage(){const e=this._progress.get();return e?Math.round(e.finished/e.total*100):0}get backupInProgressLabel(){const e=this._progress.get();return e?this.i18n`${e.finished} of ${e.total}`:this.i18n`…`}cancelBackup(){var e;(e=this._backupOperation.get())==null||e.abort()}startBackup(){var e;(e=this._session.keyBackup.get())==null||e.flush()}}async function bu(r,e,t,s){const i=new Map;r.text&&i.set("text",r.text),i.set("user_agent",r.userAgent),i.set("app",r.app),i.set("version",r.version),r.label&&i.set("label",r.label),i.set("file",{name:"logs.json",blob:e});const n=new Map;n.set("Accept","application/json");const o=s(t,{method:"POST",body:i,headers:n});let a;try{a=await o.response()}catch(h){throw new Error(`Could not submit logs to ${t}, got error ${h.message}`)}const{status:c,body:l}=a;if(c<200||c>=300)throw new Error(`Could not submit logs to ${t}, got status code ${c} with body ${l}`)}class Su{constructor(){this.supported=null,this.enabled=!1,this.updating=!1,this.enabledOnServer=null,this.serverError=null}}function Iu(r){const t=Math.ceil(r.length/4);let s="";for(let i=0;i<t;i+=1)s+=(s.length?" ":"")+r.slice(i*4,(i+1)*4);return s}class Eu extends R{constructor(e){super(e),this._updateService=e.updateService;const{client:t}=e;this._client=t,this._keyBackupViewModel=this.track(new vu(this.childOptions({session:this._session}))),this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._estimate=null,this.sentImageSizeLimit=null,this.minSentImageSizeLimit=400,this.maxSentImageSizeLimit=4e3,this.pushNotifications=new Su,this._activeTheme=void 0,this._logsFeedbackMessage=void 0}get _session(){return this._client.session}async logout(){this.navigation.push("logout",this._client.sessionId)}setSentImageSizeLimit(e){e>this.maxSentImageSizeLimit||e<this.minSentImageSizeLimit?(this.sentImageSizeLimit=null,this.platform.settingsStorage.remove("sentImageSizeLimit")):(this.sentImageSizeLimit=Math.round(e),this.platform.settingsStorage.setInt("sentImageSizeLimit",e)),this.emitChange("sentImageSizeLimit")}async load(){this._estimate=await this.platform.estimateStorageUsage(),this.sentImageSizeLimit=await this.platform.settingsStorage.getInt("sentImageSizeLimit"),this.pushNotifications.supported=await this.platform.notificationService.supportsPush(),this.pushNotifications.enabled=await this._session.arePushNotificationsEnabled(),this._activeTheme=await this.platform.themeLoader.getActiveTheme(),this.emitChange("")}get closeUrl(){return this._closeUrl}get fingerprintKey(){const e=this._session.fingerprintKey;return e?Iu(e):null}get deviceId(){return this._session.deviceId}get userId(){return this._session.userId}get version(){const{updateService:e}=this.platform;return e?`${e.version} (${e.buildHash})`:this.i18n`development version`}checkForUpdate(){var e;(e=this.platform.updateService)==null||e.checkForUpdate()}get showUpdateButton(){return!!this.platform.updateService}get keyBackupViewModel(){return this._keyBackupViewModel}get storageQuota(){var e;return this._formatBytes((e=this._estimate)==null?void 0:e.quota)}get storageUsage(){var e;return this._formatBytes((e=this._estimate)==null?void 0:e.usage)}get themeMapping(){return this.platform.themeLoader.themeMapping}get activeTheme(){return this._activeTheme}_formatBytes(e){return typeof e=="number"?Math.round(e/(1024*1024)).toFixed(1)+" MB":this.i18n`unknown`}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}get canSendLogsToServer(){return!!this.platform.config.bugReportEndpointUrl}get logsServer(){const{bugReportEndpointUrl:e}=this.platform.config;try{if(e)return new URL(e).hostname}catch{}return""}async sendLogsToServer(){const{bugReportEndpointUrl:e}=this.platform.config;if(e){this._logsFeedbackMessage=this.i18n`Sending logs…`,this.emitChange();try{const t=await this.logger.export();await bu({app:"hydrogen",userAgent:this.platform.description,version:"0.2.33",text:`Submit logs from settings for user ${this._session.userId} on device ${this._session.deviceId}`},t.asBlob(),e,this.platform.request),this._logsFeedbackMessage=this.i18n`Logs sent succesfully!`,this.emitChange()}catch(t){this._logsFeedbackMessage=t.message,this.emitChange()}}}get logsFeedbackMessage(){return this._logsFeedbackMessage}async togglePushNotifications(){this.pushNotifications.updating=!0,this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null,this.emitChange("pushNotifications.updating");try{await this._session.enablePushNotifications(!this.pushNotifications.enabled)&&(this.pushNotifications.enabled=!this.pushNotifications.enabled,this.pushNotifications.enabled&&this.platform.notificationService.showNotification(this.i18n`Push notifications are now enabled`))}finally{this.pushNotifications.updating=!1,this.emitChange("pushNotifications.updating")}}async checkPushEnabledOnServer(){this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null;try{this.pushNotifications.enabledOnServer=await this._session.checkPusherEnabledOnHomeserver(),this.emitChange("pushNotifications.enabledOnServer")}catch(e){this.pushNotifications.serverError=e,this.emitChange("pushNotifications.serverError")}}changeThemeOption(e,t){this.platform.themeLoader.setTheme(e,t),this.emitChange("themeOption")}}class ku extends R{constructor(e){super(e);const{session:t}=e;this._session=t,this._name=void 0,this._topic=void 0,this._roomAlias=void 0,this._isPublic=!1,this._isEncrypted=!0,this._isAdvancedShown=!1,this._isFederationDisabled=!1,this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0}get isPublic(){return this._isPublic}get isEncrypted(){return this._isEncrypted}get canCreate(){return!!this._name}avatarUrl(){return this._avatarScaledBlob.url}get avatarTitle(){return this._name}get avatarLetter(){return""}get avatarColorNumber(){return 0}get hasAvatar(){return!!this._avatarScaledBlob}get isFederationDisabled(){return this._isFederationDisabled}get isAdvancedShown(){return this._isAdvancedShown}setName(e){this._name=e,this.emitChange("canCreate")}setRoomAlias(e){this._roomAlias=e}setTopic(e){this._topic=e}setPublic(e){this._isPublic=e,this.emitChange("isPublic")}setEncrypted(e){this._isEncrypted=e,this.emitChange("isEncrypted")}setFederationDisabled(e){this._isFederationDisabled=e,this.emitChange("isFederationDisabled")}toggleAdvancedShown(){this._isAdvancedShown=!this._isAdvancedShown,this.emitChange("isAdvancedShown")}create(){var s,i;let e;this._avatarScaledBlob&&(e={info:this._avatarInfo,name:this._avatarFileName,blob:this._avatarScaledBlob});const t=this._session.createRoom({type:this.isPublic?re.Public:re.Private,name:(s=this._name)!=null?s:void 0,topic:(i=this._topic)!=null?i:void 0,isEncrypted:!this.isPublic&&this._isEncrypted,isFederationDisabled:this._isFederationDisabled,alias:this.isPublic?Ru(this._roomAlias):void 0,avatar:e});this.navigation.push("room",t.id)}async selectAvatar(){if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}this._avatarScaledBlob&&this._avatarScaledBlob.dispose(),this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0;const e=await this.platform.openFile("image/*");if(!e||!e.blob.mimeType.startsWith("image/")){this.emitChange("hasAvatar");return}let t=await this.platform.loadImage(e.blob);const s=800;if(t.maxDimension>s){const i=await t.scale(s);t.dispose(),t=i}this._avatarScaledBlob=t.blob,this._avatarInfo=qt(t),this._avatarFileName=e.name,this.emitChange("hasAvatar")}}function Ru(r){r.startsWith("#")&&(r=r.substr(1));const e=r.indexOf(":");return e!==-1&&(r=r.substr(0,e)),r}class en extends we{constructor(e,t){super(null),this._statusSubscription=null,this._sessionViewModel=e,this.id=t}async initialize(){const{session:e}=this._sessionViewModel._client,t=await e.observeRoomStatus(this.id);this.set(await this._statusToViewModel(t.get())),this._statusSubscription=t.subscribe(async s=>{var i;(i=this.get())==null||i.dispose(),this.set(await this._statusToViewModel(s))})}async _statusToViewModel(e){if(e&L.Replaced)if(e&L.BeingCreated){const{session:t}=this._sessionViewModel._client,s=t.roomsBeingCreated.get(this.id);this._sessionViewModel.notifyRoomReplaced(s.id,s.roomId)}else throw new Error("Don't know how to replace a room with this status: "+(e^L.Replaced));else return e&L.BeingCreated?this._sessionViewModel._createRoomBeingCreatedViewModel(this.id):e&L.Invited?this._sessionViewModel._createInviteViewModel(this.id):e&L.Joined?this._sessionViewModel._createRoomViewModelInstance(this.id):e&L.Archived?await this._sessionViewModel._createArchivedRoomViewModel(this.id):this._sessionViewModel._createUnknownRoomViewModel(this.id)}dispose(){var e;this._statusSubscription&&(this._statusSubscription=this._statusSubscription()),this.unsubscribeAll(),(e=this.get())==null||e.dispose()}}class Cu extends R{constructor(e){super(e),this._room=e.room,this._onRoomChange=this._onRoomChange.bind(this),this._room.on("change",this._onRoomChange)}get type(){return"room-details"}get shouldShowBackButton(){return!1}get previousSegmentName(){return!1}get roomId(){return this._room.id}get canonicalAlias(){return this._room.canonicalAlias}get name(){return this._room.name}get isEncrypted(){return!!this._room.isEncrypted}get memberCount(){return this._room.joinedMemberCount}get avatarLetter(){return he(this.name)}get avatarColorNumber(){return de(this._room.avatarColorId)}avatarUrl(e){return Le(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}_onRoomChange(){this.emitChange()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange)}openPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}class Tu extends R{constructor(e){super(e),this._member=this._options.member,this._mediaRepository=e.mediaRepository,this._previousName=null,this._nameChanged=!0}get name(){return`${this._member.name}${this._disambiguationPart}`}get _disambiguationPart(){return this._disambiguate?` (${this.userId})`:""}get userId(){return this._member.userId}get previousName(){return this._previousName}get nameChanged(){return this._nameChanged}get detailsUrl(){const e=this.navigation.path.get("room").value;return`${this.urlCreator.openRoomActionUrl(e)}/member/${this._member.userId}`}_updatePreviousName(e){const t=this._member.name;t!==e?(this._previousName=t,this._nameChanged=!0):this._nameChanged=!1}setDisambiguation(e){this._disambiguate=e,this.emitChange()}updateFrom(e){this._updatePreviousName(e.name),this._member=e}get avatarLetter(){return he(this.name)}get avatarColorNumber(){return de(this.userId)}avatarUrl(e){return Le(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}}function Mu(r){const e=new Intl.Collator,t=s=>s.charAt(0)==="@"?s.slice(1):s;return function(i,n){const o=r.getUserLevel(i.userId),a=r.getUserLevel(n.userId);if(o!==a)return a-o;const c=t(i.name),l=t(n.name);return e.compare(c,l)}}class Au{constructor(){this._map=new Map}_unDisambiguate(e,t){const s=t.indexOf(e);if(s!==-1){const[i]=t.splice(s,1);i.setDisambiguation(!1)}}_handlePreviousName(e){const t=e.previousName;if(typeof t!="string")return;const s=this._map.get(t);if(Array.isArray(s)){if(this._unDisambiguate(e,s),s.length===1){const i=s[0];i.setDisambiguation(!1),this._map.set(t,i)}}else this._map.delete(t)}_updateMap(e){const t=e.name,s=this._map.get(t);if(s){if(Array.isArray(s))return s.findIndex(i=>i.userId===e.userId)!==-1?void 0:(s.push(e),s);if(e.userId!==s.userId){const i=[s,e];return this._map.set(t,i),i}}else this._map.set(t,e)}disambiguate(e){if(!e.nameChanged)return;this._handlePreviousName(e);const t=this._updateMap(e);t==null||t.forEach(s=>s.setDisambiguation(!0))}}class xu extends R{constructor(e){super(e);const t=e.members,s=e.powerLevelsObservable;this.track(s.subscribe(()=>{}));const i=s.get();this.memberTileViewModels=this._mapTileViewModels(t.members.filterValues(n=>n.membership==="join")).sortValues(Mu(i)),this.nameDisambiguator=new Au,this.mediaRepository=e.mediaRepository}get type(){return"member-list"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"details"}_mapTileViewModels(e){const t=(i,n)=>{const o=this.mediaRepository,a=new Tu(this.childOptions({member:i,emitChange:n,mediaRepository:o}));return this.nameDisambiguator.disambiguate(a),a},s=(i,n,o)=>{i.updateFrom(o),this.nameDisambiguator.disambiguate(i)};return e.mapValues(t,s)}}class Nu extends R{constructor(e){super(e),this._observableMember=e.observableMember,this._mediaRepository=e.mediaRepository,this._member=this._observableMember.get(),this._isEncrypted=e.isEncrypted,this._powerLevelsObservable=e.powerLevelsObservable,this._session=e.session,this.track(this._powerLevelsObservable.subscribe(()=>this._onPowerLevelsChange())),this.track(this._observableMember.subscribe(()=>this._onMemberChange()))}get name(){return this._member.name}get userId(){return this._member.userId}get type(){return"member-details"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"members"}get role(){return this.powerLevel>=100?this.i18n`Admin`:this.powerLevel>=50?this.i18n`Moderator`:this.powerLevel===0?this.i18n`Default`:this.i18n`Custom (${this.powerLevel})`}_onMemberChange(){this._member=this._observableMember.get(),this.emitChange("member")}_onPowerLevelsChange(){this.emitChange("role")}get avatarLetter(){return he(this.name)}get avatarColorNumber(){return de(this.userId)}avatarUrl(e){return Le(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}get isEncrypted(){return this._isEncrypted}get powerLevel(){var e;return(e=this._powerLevelsObservable.get())==null?void 0:e.getUserLevel(this._member.userId)}get linkToUser(){return`https://matrix.to/#/${encodeURIComponent(this._member.userId)}`}async openDirectMessage(){const e=this._session.findDirectMessageForUserId(this.userId);let t=e==null?void 0:e.id;t||(t=(await this._session.createRoom({type:re.DirectMessage,invites:[this.userId]})).id),this.navigation.push("room",t)}}class Du extends R{constructor(e){super(e),this._room=e.room,this._session=e.session,this._members=null,this._setupNavigation()}get activeViewModel(){return this._activeViewModel}async _getMemberListArguments(){this._members||(this._members=await this._room.loadMemberList(),this.track(()=>this._members.release()));const e=this._room,t=await this._room.observePowerLevels();return{members:this._members,powerLevelsObservable:t,mediaRepository:e.mediaRepository}}async _getMemberDetailsArguments(){const t=this.navigation.path.get("member").value,s=await this._room.observeMember(t);if(!s)return!1;const i=this._room.isEncrypted,n=await this._room.observePowerLevels();return{observableMember:s,isEncrypted:i,powerLevelsObservable:n,mediaRepository:this._room.mediaRepository,session:this._session}}_setupNavigation(){this._hookUpdaterToSegment("details",Cu,()=>({room:this._room})),this._hookUpdaterToSegment("members",xu,()=>this._getMemberListArguments()),this._hookUpdaterToSegment("member",Nu,()=>this._getMemberDetailsArguments(),()=>{const e=`${this.urlCreator.urlUntilSegment("room")}/members`;this.urlCreator.pushUrl(e)})}_hookUpdaterToSegment(e,t,s,i){const n=this.navigation.observe(e),o=this._setupUpdater(e,t,s,i);this.track(n.subscribe(o))}_setupUpdater(e,t,s,i){const n=async(o=!1)=>{var c;if(o||(this._activeViewModel=this.disposeTracked(this._activeViewModel)),!!((c=this.navigation.path.get(e))!=null&&c.value)){const l=await s();if(!l&&i){i();return}this._activeViewModel=this.track(new t(this.childOptions(l)))}this.emitChange("activeViewModel")};return n(!0),n}closePanel(){const e=this.navigation.path.until("room");this.navigation.applyPath(e)}showPreviousPanel(){const e=this.activeViewModel.previousSegmentName;if(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}}class Lu extends R{constructor(e){super(e);const{client:t}=e;this._client=this.track(t),this._sessionStatusViewModel=this.track(new yu(this.childOptions({sync:t.sync,reconnector:t.reconnector,session:t.session}))),this._leftPanelViewModel=this.track(new kd(this.childOptions({session:this._client.session}))),this._settingsViewModel=null,this._roomViewModelObservable=null,this._gridViewModel=null,this._createRoomViewModel=null,this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("rooms");this.track(e.subscribe(a=>{this._updateGrid(a)})),e.get()&&this._updateGrid(e.get());const t=this.navigation.observe("room");this.track(t.subscribe(a=>{this._gridViewModel||this._updateRoom(a),this._updateRightPanel()})),this._gridViewModel||this._updateRoom(t.get());const s=this.navigation.observe("settings");this.track(s.subscribe(a=>{this._updateSettings(a)})),this._updateSettings(s.get());const i=this.navigation.observe("create-room");this.track(i.subscribe(a=>{this._updateCreateRoom(a)})),this._updateCreateRoom(i.get());const n=this.navigation.observe("lightbox");this.track(n.subscribe(a=>{this._updateLightbox(a)})),this._updateLightbox(n.get());const o=this.navigation.observe("right-panel");this.track(o.subscribe(()=>this._updateRightPanel())),this._updateRightPanel()}get id(){return this._client.sessionId}start(){this._sessionStatusViewModel.start()}get activeMiddleViewModel(){var e;return((e=this._roomViewModelObservable)==null?void 0:e.get())||this._gridViewModel||this._settingsViewModel||this._createRoomViewModel}get roomGridViewModel(){return this._gridViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get sessionStatusViewModel(){return this._sessionStatusViewModel}get settingsViewModel(){return this._settingsViewModel}get currentRoomViewModel(){var e;return(e=this._roomViewModelObservable)==null?void 0:e.get()}get rightPanelViewModel(){return this._rightPanelViewModel}get createRoomViewModel(){return this._createRoomViewModel}_updateGrid(e){var i;const t=!(this._gridViewModel&&e),s=this.navigation.path.get("room");if(e)this._gridViewModel?this._gridViewModel.setRoomIds(e):(this._gridViewModel=this.track(new wu(this.childOptions({width:3,height:2,createRoomViewModelObservable:n=>new en(this,n)}))),(i=this._roomViewModelObservable)==null||i.unsubscribeAll(),this._gridViewModel.initializeRoomIdsAndTransferVM(e,this._roomViewModelObservable)?this._roomViewModelObservable=this.untrack(this._roomViewModelObservable):this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)));else if(this._gridViewModel&&!e){if(s){const n=this._gridViewModel.releaseRoomViewModel(s.value);n&&(this._roomViewModelObservable=this.track(n),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}))}this._gridViewModel=this.disposeTracked(this._gridViewModel)}t&&this.emitChange("activeMiddleViewModel")}_createRoomViewModelInstance(e){const t=this._client.session.rooms.get(e);if(t){const s=new Xr(this.childOptions({room:t}));return s.load(),s}return null}_createUnknownRoomViewModel(e){return new mu(this.childOptions({roomIdOrAlias:e,session:this._client.session}))}async _createArchivedRoomViewModel(e){const t=await this._client.session.loadArchivedRoom(e);if(t){const s=new Xr(this.childOptions({room:t}));return s.load(),s}return null}_createInviteViewModel(e){const t=this._client.session.invites.get(e);return t?new pu(this.childOptions({invite:t,mediaRepository:this._client.session.mediaRepository})):null}_createRoomBeingCreatedViewModel(e){const t=this._client.session.roomsBeingCreated.get(e);return t?new gu(this.childOptions({roomBeingCreated:t,mediaRepository:this._client.session.mediaRepository})):null}_updateRoom(e){var s;if(((s=this._roomViewModelObservable)==null?void 0:s.id)===e)return;if(this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)),!e){this.emitChange("activeMiddleViewModel");return}const t=new en(this,e);this._roomViewModelObservable=this.track(t),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}),t.initialize()}_updateSettings(e){this._settingsViewModel&&(this._settingsViewModel=this.disposeTracked(this._settingsViewModel)),e&&(this._settingsViewModel=this.track(new Eu(this.childOptions({client:this._client}))),this._settingsViewModel.load()),this.emitChange("activeMiddleViewModel")}_updateCreateRoom(e){this._createRoomViewModel&&(this._createRoomViewModel=this.disposeTracked(this._createRoomViewModel)),e&&(this._createRoomViewModel=this.track(new ku(this.childOptions({session:this._client.session})))),this.emitChange("activeMiddleViewModel")}_updateLightbox(e){if(this._lightboxViewModel&&(this._lightboxViewModel=this.disposeTracked(this._lightboxViewModel)),e){const t=this._roomFromNavigation();this._lightboxViewModel=this.track(new fu(this.childOptions({eventId:e,room:t})))}this.emitChange("lightboxViewModel")}get lightboxViewModel(){return this._lightboxViewModel}_roomFromNavigation(){var s;const e=(s=this.navigation.path.get("room"))==null?void 0:s.value;return this._client.session.rooms.get(e)}_updateRightPanel(){var t;if(this._rightPanelViewModel=this.disposeTracked(this._rightPanelViewModel),!!((t=this.navigation.path.get("right-panel"))!=null&&t.value)){const s=this._roomFromNavigation();this._rightPanelViewModel=this.track(new Du(this.childOptions({room:s,session:this._client.session})))}this.emitChange("rightPanelViewModel")}notifyRoomReplaced(e,t){this.navigation.push("room",t)}}class Ou extends R{constructor(e){super(e),this._accountSetup=e.accountSetup,this._dehydratedDevice=void 0,this._decryptDehydratedDeviceViewModel=void 0,this._accountSetup.encryptedDehydratedDevice&&(this._decryptDehydratedDeviceViewModel=new Uu(this,t=>{this._dehydratedDevice=t,this._decryptDehydratedDeviceViewModel=void 0,this.emitChange("deviceDecrypted")}))}get decryptDehydratedDeviceViewModel(){return this._decryptDehydratedDeviceViewModel}get deviceDecrypted(){return!!this._dehydratedDevice}get dehydratedDeviceId(){return this._accountSetup.encryptedDehydratedDevice.deviceId}finish(){this._accountSetup.finish(this._dehydratedDevice)}}class Uu extends R{constructor(e,t){super(e.options),this._accountSetupViewModel=e,this._isBusy=!1,this._status=ee.SetupKey,this._error=void 0,this._decryptedCallback=t}get decryptAction(){return this.i18n`Restore`}get purpose(){return this.i18n`claim your dehydrated device`}get offerDehydratedDeviceSetup(){return!1}get dehydratedDeviceId(){var e;return(e=this._accountSetupViewModel._dehydratedDevice)==null?void 0:e.deviceId}get isBusy(){return this._isBusy}get backupVersion(){return 0}get status(){return this._status}get error(){var e;return(e=this._error)==null?void 0:e.message}showPhraseSetup(){this._status===ee.SetupKey&&(this._status=ee.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===ee.SetupPhrase&&(this._status=ee.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const{encryptedDehydratedDevice:s}=this._accountSetupViewModel._accountSetup,i=await s.decrypt(e,t);this._decryptedCallback(i)}catch(s){console.error(s),this._error=s,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange("")}}enterSecurityPhrase(e){this._enterCredentials(Gt.Passphrase,e)}enterSecurityKey(e){this._enterCredentials(Gt.RecoveryKey,e)}disable(){}}class po extends R{constructor(e){super(e);const{client:t,ready:s,homeserver:i,deleteSessionOnCancel:n}=e;this._client=t,this._ready=s,this._homeserver=i,this._deleteSessionOnCancel=n,this._loading=!1,this._error=null,this.backUrl=this.urlCreator.urlForSegment("session",!0),this._accountSetupViewModel=void 0}async start(){if(!this._loading)try{this._loading=!0,this.emitChange("loading"),this._waitHandle=this._client.loadStatus.waitFor(s=>(s===k.AccountSetup?this._accountSetupViewModel=new Ou(this.childOptions({accountSetup:this._client.accountSetup})):this._accountSetupViewModel=void 0,this.emitChange("loadLabel"),s===k.FirstSync&&this._client.sync.status.get()===A.CatchupSync||s===k.LoginFailed||s===k.Error||s===k.Ready));try{await this._waitHandle.promise}catch{return}const e=this._client.loadStatus.get(),t=this._client.loadError;if(e===k.FirstSync||e===k.Ready){const s=this._client;this._client=null,this._ready(s)}t&&console.error("session load error",t)}catch(e){this._error=e,console.error("error thrown during session load",e.stack)}finally{this._loading=!1,this.emitChange("loading")}}dispose(){this._client&&(this._client.dispose(),this._client=null),this._waitHandle&&(this._waitHandle.dispose(),this._waitHandle=null)}get loading(){const e=this._client;return e&&e.loadStatus.get()===k.AccountSetup?!1:this._loading}get loadLabel(){const e=this._client,t=this._getError();if(t||e&&e.loadStatus.get()===k.Error)return`Something went wrong: ${t&&t.message}.`;if(e)switch(e.loadStatus.get()){case k.QueryAccount:return"Querying account encryption setup\u2026";case k.AccountSetup:return"";case k.SessionSetup:return"Setting up your encryption keys\u2026";case k.Loading:return"Loading your conversations\u2026";case k.FirstSync:return"Getting your conversations from the server\u2026";default:return this._client.loadStatus.get()}return"Preparing\u2026"}_getError(){var e;return this._error||((e=this._client)==null?void 0:e.loadError)}get hasError(){return!!this._getError()}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async logout(){await this._client.logout(),this.navigation.push("session",!0)}get accountSetupViewModel(){return this._accountSetupViewModel}}class Pu extends R{constructor(e){super(e);const{loginOptions:t,attemptLogin:s}=e;this._loginOptions=t,this._attemptLogin=s,this._isBusy=!1,this._errorMessage=""}get isBusy(){return this._isBusy}get errorMessage(){return this._errorMessage}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async login(e,t){this._errorMessage="",this.emitChange("errorMessage");const s=await this._attemptLogin(this._loginOptions.password(e,t));let i="";switch(s){case Te.Credentials:i=this.i18n`Your username and/or password don't seem to be correct.`;break;case Te.Connection:i=this.i18n`Can't connect to ${this._loginOptions.homeserver}.`;break;case Te.Unknown:i=this.i18n`Something went wrong while checking your login and password.`;break}i&&this._showError(i)}}class Vu extends R{constructor(e){super(e),this._sso=e.loginOptions.sso,this._isBusy=!1}get isBusy(){return this._isBusy}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}async startSSOLogin(){await this.platform.settingsStorage.setString("sso_ongoing_login_homeserver",this._sso.homeserver);const e=this._sso.createSSORedirectURL(this.urlCreator.createSSOCallbackURL());this.platform.openUrl(e)}}class Bu extends R{constructor(e){super(e);const{loginToken:t,client:s,attemptLogin:i}=e;this._loginToken=t,this._client=s,this._attemptLogin=i,this._errorMessage="",this.performSSOLoginCompletion()}get errorMessage(){return this._errorMessage}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async performSSOLoginCompletion(){if(!this._loginToken)return;const e=await this.platform.settingsStorage.getString("sso_ongoing_login_homeserver");let t;try{t=await this._client.queryLogin(e).result}catch(n){this._showError(n.message);return}if(!t.token){this.navigation.push("session");return}const s=await this._attemptLogin(t.token(this._loginToken));let i="";switch(s){case Te.Credentials:i=this.i18n`Your login token is invalid.`;break;case Te.Connection:i=this.i18n`Can't connect to ${e}.`;break;case Te.Unknown:i=this.i18n`Something went wrong while checking your login token.`;break}i&&this._showError(i)}}class Fu extends R{constructor(e){super(e);const{ready:t,defaultHomeserver:s,loginToken:i}=e;this._ready=t,this._loginToken=i,this._client=new Bi(this.platform),this._loginOptions=null,this._passwordLoginViewModel=null,this._startSSOLoginViewModel=null,this._completeSSOLoginViewModel=null,this._loadViewModel=null,this._loadViewModelSubscription=null,this._homeserver=s,this._queriedHomeserver=null,this._errorMessage="",this._hideHomeserver=!1,this._isBusy=!1,this._abortHomeserverQueryTimeout=null,this._abortQueryOperation=null,this._initViewModels()}get passwordLoginViewModel(){return this._passwordLoginViewModel}get startSSOLoginViewModel(){return this._startSSOLoginViewModel}get completeSSOLoginViewModel(){return this._completeSSOLoginViewModel}get homeserver(){return this._homeserver}get resolvedHomeserver(){var e;return(e=this._loginOptions)==null?void 0:e.homeserver}get errorMessage(){return this._errorMessage}get showHomeserver(){return!this._hideHomeserver}get loadViewModel(){return this._loadViewModel}get isBusy(){return this._isBusy}get isFetchingLoginOptions(){return!!this._abortQueryOperation}goBack(){this.navigation.push("session")}async _initViewModels(){this._loginToken?(this._hideHomeserver=!0,this._completeSSOLoginViewModel=this.track(new Bu(this.childOptions({client:this._client,attemptLogin:e=>this.attemptLogin(e),loginToken:this._loginToken}))),this.emitChange("completeSSOLoginViewModel")):await this.queryHomeserver()}_showPasswordLogin(){this._passwordLoginViewModel=this.track(new Pu(this.childOptions({loginOptions:this._loginOptions,attemptLogin:e=>this.attemptLogin(e)}))),this.emitChange("passwordLoginViewModel")}_showSSOLogin(){this._startSSOLoginViewModel=this.track(new Vu(this.childOptions({loginOptions:this._loginOptions}))),this.emitChange("startSSOLoginViewModel")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}_setBusy(e){var t,s;this._isBusy=e,(t=this._passwordLoginViewModel)==null||t.setBusy(e),(s=this._startSSOLoginViewModel)==null||s.setBusy(e),this.emitChange("isBusy")}async attemptLogin(e){this._setBusy(!0),this._client.startWithLogin(e,{inspectAccountSetup:!0});const t=this._client.loadStatus;return await t.waitFor(n=>n!==k.Login).promise,this._setBusy(!1),t.get()===k.LoginFailed?this._client.loginFailure:(this._hideHomeserver=!0,this.emitChange("hideHomeserver"),this._disposeViewModels(),this._createLoadViewModel(),null)}_createLoadViewModel(){this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription),this._loadViewModel=this.disposeTracked(this._loadViewModel),this._loadViewModel=this.track(new po(this.childOptions({ready:e=>{this._client=null,this._ready(e)},client:this._client,homeserver:this._homeserver}))),this._loadViewModel.start(),this.emitChange("loadViewModel"),this._loadViewModelSubscription=this.track(this._loadViewModel.disposableOn("change",()=>{this._loadViewModel.loading||(this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription)),this._setBusy(!1)}))}_disposeViewModels(){this._startSSOLoginViewModel=this.disposeTracked(this._ssoLoginViewModel),this._passwordLoginViewModel=this.disposeTracked(this._passwordLoginViewModel),this._completeSSOLoginViewModel=this.disposeTracked(this._completeSSOLoginViewModel),this.emitChange("disposeViewModels")}async setHomeserver(e){this._homeserver=e,this._loginOptions=null,this._queriedHomeserver=null,this._showError(""),this._disposeViewModels(),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange(),this.disposeTracked(this._abortHomeserverQueryTimeout);const t=this.clock.createTimeout(1e3);this._abortHomeserverQueryTimeout=this.track(()=>t.abort());try{await t.elapsed()}catch(s){if(s.name==="AbortError")return;throw s}this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this.queryHomeserver()}async queryHomeserver(){if(!(this._homeserver===this._queriedHomeserver||this._homeserver==="")){this._queriedHomeserver=this._homeserver,this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation);try{const e=this._client.queryLogin(this._homeserver);this._abortQueryOperation=this.track(()=>e.abort()),this.emitChange("isFetchingLoginOptions"),this._loginOptions=await e.result,this.emitChange("resolvedHomeserver")}catch(e){if(e.name==="AbortError")return;this._loginOptions=null}finally{this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("isFetchingLoginOptions")}this._loginOptions?(this._loginOptions.sso&&this._showSSOLogin(),this._loginOptions.password&&this._showPasswordLogin(),!this._loginOptions.sso&&!this._loginOptions.password&&this._showError("This homeserver supports neither SSO nor password based login flows")):this._showError(`Could not query login methods supported by ${this.homeserver}`)}}dispose(){super.dispose(),this._client&&this._client.deleteSession()}}class Ku extends R{constructor(e){super(e),this._sessionId=e.sessionId,this._busy=!1,this._showConfirm=!0,this._error=void 0}get showConfirm(){return this._showConfirm}get busy(){return this._busy}get cancelUrl(){return this.urlCreator.urlForSegment("session",!0)}async logout(){this._busy=!0,this._showConfirm=!1,this.emitChange("busy");try{await new Bi(this.platform).startLogout(this._sessionId),this.navigation.push("session",!0)}catch(e){this._error=e,this._busy=!1,this.emitChange("busy")}}get status(){return this._error?this.i18n`Could not log out of device: ${this._error.message}`:this.i18n`Logging out… Please don't close the app.`}}class $u extends R{constructor(e,t){super(e),this._pickerVM=t,this._sessionInfo=e.sessionInfo,this._isDeleting=!1,this._isClearing=!1,this._error=null,this._exportDataUrl=null}get error(){return this._error&&this._error.message}get id(){return this._sessionInfo.id}get openUrl(){return this.urlCreator.urlForSegment("session",this.id)}get label(){const{userId:e,comment:t}=this._sessionInfo;return t?`${e} (${t})`:e}get sessionInfo(){return this._sessionInfo}get exportDataUrl(){return this._exportDataUrl}get avatarColorNumber(){return de(this._sessionInfo.userId)}get avatarInitials(){return he(this._sessionInfo.userId)}}class qu extends R{constructor(e){super(e),this._sessions=new Ci((t,s)=>t.id.localeCompare(s.id)),this._loadViewModel=null,this._error=null}async load(){const e=await this.platform.sessionInfoStorage.getAll();this._sessions.setManyUnsorted(e.map(t=>new $u(this.childOptions({sessionInfo:t}),this)))}get loadViewModel(){return this._loadViewModel}get sessions(){return this._sessions}get cancelUrl(){return this.urlCreator.urlForSegment("login")}}class ju extends R{constructor(e){super(e),this._error=null,this._sessionPickerViewModel=null,this._sessionLoadViewModel=null,this._loginViewModel=null,this._logoutViewModel=null,this._sessionViewModel=null,this._pendingClient=null}async load(){this.track(this.navigation.observe("login").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("session").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("sso").subscribe(()=>this._applyNavigation())),this._applyNavigation(!0)}async _applyNavigation(e){var o,a,c;const t=this.navigation.path.get("login"),s=(o=this.navigation.path.get("logout"))==null?void 0:o.value,i=(a=this.navigation.path.get("session"))==null?void 0:a.value,n=(c=this.navigation.path.get("sso"))==null?void 0:c.value;if(t)this.activeSection!=="login"&&this._showLogin();else if(s)this.activeSection!=="logout"&&this._showLogout(s);else if(i===!0)this.activeSection!=="picker"&&this._showPicker();else if(i){if(!this._sessionViewModel||this._sessionViewModel.id!==i)if(this._pendingClient&&this._pendingClient.sessionId===i){const l=this._pendingClient;this._pendingClient=null,this._showSession(l)}else this._pendingClient&&(this._pendingClient.dispose(),this._pendingClient=null),this._showSessionLoader(i)}else if(n)this.urlCreator.normalizeUrl(),this.activeSection!=="login"&&this._showLogin(n);else try{if(!(e&&this.urlCreator.tryRestoreLastUrl())){const l=await this.platform.sessionInfoStorage.getAll();l.length===0?this.navigation.push("login"):l.length===1?this.navigation.push("session",l[0].id):this.navigation.push("session")}}catch(l){this._setSection(()=>this._error=l)}}async _showPicker(){this._setSection(()=>{this._sessionPickerViewModel=new qu(this.childOptions())});try{await this._sessionPickerViewModel.load()}catch(e){this._setSection(()=>this._error=e)}}_showLogin(e){this._setSection(()=>{this._loginViewModel=new Fu(this.childOptions({defaultHomeserver:this.platform.config.defaultHomeServer,ready:t=>{this._pendingClient=t,this.navigation.push("session",t.sessionId)},loginToken:e}))})}_showLogout(e){this._setSection(()=>{this._logoutViewModel=new Ku(this.childOptions({sessionId:e}))})}_showSession(e){this._setSection(()=>{this._sessionViewModel=new Lu(this.childOptions({client:e})),this._sessionViewModel.start()})}_showSessionLoader(e){const t=new Bi(this.platform);t.startWithExistingSession(e),this._setSection(()=>{this._sessionLoadViewModel=new po(this.childOptions({client:t,ready:s=>this._showSession(s)})),this._sessionLoadViewModel.start()})}get activeSection(){return this._error?"error":this._sessionViewModel?"session":this._loginViewModel?"login":this._logoutViewModel?"logout":this._sessionPickerViewModel?"picker":this._sessionLoadViewModel?"loading":"redirecting"}_setSection(e){this._error=null,this._sessionPickerViewModel=this.disposeTracked(this._sessionPickerViewModel),this._sessionLoadViewModel=this.disposeTracked(this._sessionLoadViewModel),this._loginViewModel=this.disposeTracked(this._loginViewModel),this._logoutViewModel=this.disposeTracked(this._logoutViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),e(),this._sessionPickerViewModel&&this.track(this._sessionPickerViewModel),this._sessionLoadViewModel&&this.track(this._sessionLoadViewModel),this._loginViewModel&&this.track(this._loginViewModel),this._logoutViewModel&&this.track(this._logoutViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}get error(){return this._error}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}get logoutViewModel(){return this._logoutViewModel}get sessionPickerViewModel(){return this._sessionPickerViewModel}get sessionLoadViewModel(){return this._sessionLoadViewModel}}async function Wu(r){try{await r.init();const e=wd();r.setNavigation(e);const t=vd({navigation:e,history:r.history});t.attach();const s=new ju({platform:r,urlCreator:t,navigation:e});await s.load(),r.createAndMountRootView(s)}catch(e){console.error(`${e.message}:
${e.stack}`)}}function Hu(r,e,t,s){const i=r(e);let n=!1;return i.elapsed().then(()=>{n=!0,t.abort()},()=>{}),s.then(o=>(i.abort(),o),o=>{throw i.abort(),o.name==="AbortError"&&n?new je(`Request timed out after ${e}ms`,!0):o})}function _o(r,e=Math.random){return r.includes("?")?r=r+"&":r=r+"?",r+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}function go(r){var t;const e=new FormData;for(const[s,i]of r)((t=i.blob)==null?void 0:t.nativeBlob)&&i.name?e.set(s,i.blob.nativeBlob,i.name):e.set(s,i);return e}class zu{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function Gu(r,{method:e,headers:t,timeout:s,format:i,uploadProgress:n}){const o=new XMLHttpRequest;if(n&&o.upload.addEventListener("progress",a=>n(a.loaded)),o.open(e,r),i==="buffer"&&(o.responseType="arraybuffer"),t)for(const[a,c]of t.entries())try{o.setRequestHeader(a,c)}catch(l){console.info(`Could not set ${a} header: ${l.message}`)}return s&&(o.timeout=s),o}function Ju(r,e,t){return new Promise((s,i)=>{r.addEventListener("load",()=>s(r)),r.addEventListener("abort",()=>i(new ye)),r.addEventListener("error",()=>i(new je(`Error ${e} ${t}`))),r.addEventListener("timeout",()=>i(new je(`Timeout ${e} ${t}`,!0)))})}function fo(r,e){let{cache:t,format:s,body:i,method:n}=e;t||(r=_o(r));const o=Gu(r,e),a=Ju(o,n,r).then(c=>{const{status:l}=c;let h=null;return s==="buffer"?h=c.response:c.getResponseHeader("Content-Type")==="application/json"&&(h=JSON.parse(c.responseText)),{status:l,body:h}});return i!=null&&i.nativeBlob&&(i=i.nativeBlob),i instanceof Map&&(i=go(i)),o.send(i||null),new zu(a,o)}class tn{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const s=new Promise((i,n)=>{this._controller={abort(){const o=new Error("fetch request aborted");o.name="AbortError",n(o)}}});this.promise=Promise.race([e,s])}}abort(){this._controller.abort()}response(){return this.promise}}function Qu(r,e){return function(s,i){if(e!=null&&e.haltRequests)return new tn(new Promise(()=>{}),{});if(i!=null&&i.uploadProgress)return fo(s,i);let{method:n,headers:o,body:a,timeout:c,format:l,cache:h=!1}=i;const d=typeof AbortController=="function"?new AbortController:null;a!=null&&a.nativeBlob&&(a=a.nativeBlob),a instanceof Map&&(a=go(a));let m={method:n,body:a};if(d&&(m=Object.assign(m,{signal:d.signal})),h||(s=_o(s)),m=Object.assign(m,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const g=new Headers;for(const[b,S]of o.entries())g.append(b,S);m.headers=g}const p=fetch(s,m).then(async g=>{const{status:b}=g;let S;try{l==="json"?S=await g.json():l==="buffer"&&(S=await g.arrayBuffer())}catch(T){if(!(T.name==="SyntaxError"&&b>=400))throw T}return{status:b,body:S}},g=>{throw g.name==="AbortError"?new ye:g instanceof TypeError?new je(`${n} ${s}: ${g.message}`):g}),_=new tn(p,d);return c&&(_.promise=Hu(r,c,_,_.promise)),_}}class Yu{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){const s=await this.getAll();if(s){const i=s.find(n=>n.id===e);i&&(i.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(s)))}}async get(e){const t=await this.getAll();if(t)return t.find(s=>s.id===e)}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(s=>s.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}}class Xu{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?parseInt(s,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?s==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class Zu{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}var rt={};(function(){for(var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),t=0;t<r.length;t++)e[r.charCodeAt(t)]=t;rt.encode=function(s){var i=new Uint8Array(s),n,o=i.length,a="";for(n=0;n<o;n+=3)a+=r[i[n]>>2],a+=r[(i[n]&3)<<4|i[n+1]>>4],a+=r[(i[n+1]&15)<<2|i[n+2]>>6],a+=r[i[n+2]&63];return o%3===2?a=a.substring(0,a.length-1)+"=":o%3===1&&(a=a.substring(0,a.length-2)+"=="),a},rt.decode=function(s){var i=s.length*.75,n=s.length,o,a=0,c,l,h,d;s[s.length-1]==="="&&(i--,s[s.length-2]==="="&&i--);var m=new ArrayBuffer(i),p=new Uint8Array(m);for(o=0;o<n;o+=4)c=e[s.charCodeAt(o)],l=e[s.charCodeAt(o+1)],h=e[s.charCodeAt(o+2)],d=e[s.charCodeAt(o+3)],p[a++]=c<<2|l>>4,p[a++]=(l&15)<<4|h>>2,p[a++]=(h&3)<<6|d&63;return m}})();class em{encodeUnpadded(e){const t=rt.encode(e),s=t.indexOf("=");return s!==-1?t.substr(0,s):t}encode(e){return rt.encode(e)}decode(e){return rt.decode(e)}}var yo={isBuffer:function(r){return r instanceof Uint8Array},from:function(r){return r},allocUnsafe:function(r){return yo.alloc(r)},alloc:function(r){return new Uint8Array(r)}},tm=Object.freeze(Object.defineProperty({__proto__:null,Buffer:yo},Symbol.toStringTag,{value:"Module"})),sm=Ia(tm),fs=sm.Buffer;function im(r){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),n=i.charCodeAt(0);if(e[n]!==255)throw new TypeError(i+" is ambiguous");e[n]=s}var o=r.length,a=r.charAt(0),c=Math.log(o)/Math.log(256),l=Math.log(256)/Math.log(o);function h(p){if((Array.isArray(p)||p instanceof Uint8Array)&&(p=fs.from(p)),!fs.isBuffer(p))throw new TypeError("Expected Buffer");if(p.length===0)return"";for(var _=0,g=0,b=0,S=p.length;b!==S&&p[b]===0;)b++,_++;for(var T=(S-b)*l+1>>>0,P=new Uint8Array(T);b!==S;){for(var D=p[b],V=0,Z=T-1;(D!==0||V<g)&&Z!==-1;Z--,V++)D+=256*P[Z]>>>0,P[Z]=D%o>>>0,D=D/o>>>0;if(D!==0)throw new Error("Non-zero carry");g=V,b++}for(var G=T-g;G!==T&&P[G]===0;)G++;for(var Ue=a.repeat(_);G<T;++G)Ue+=r.charAt(P[G]);return Ue}function d(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return fs.alloc(0);var _=0;if(p[_]!==" "){for(var g=0,b=0;p[_]===a;)g++,_++;for(var S=(p.length-_)*c+1>>>0,T=new Uint8Array(S);p[_];){var P=e[p.charCodeAt(_)];if(P===255)return;for(var D=0,V=S-1;(P!==0||D<b)&&V!==-1;V--,D++)P+=o*T[V]>>>0,T[V]=P%256>>>0,P=P/256>>>0;if(P!==0)throw new Error("Non-zero carry");b=D,_++}if(p[_]!==" "){for(var Z=S-b;Z!==S&&T[Z]===0;)Z++;var G=fs.allocUnsafe(g+(S-Z));G.fill(0,0,g);for(var Ue=g;Z!==S;)G[Ue++]=T[Z++];return G}}}function m(p){var _=d(p);if(_)return _;throw new Error("Non-base"+o+" character")}return{encode:h,decodeUnsafe:d,decode:m}}var rm=im,nm=rm,om="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",sn=nm(om);class am{encode(e){return sn.encode(e)}decode(e){return sn.decode(e)}}class cm{constructor(){this.utf8=new Zu,this.base64=new em,this.base58=new am}}class lm{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const s=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:s})}async createAccountAndOTKs(e,t){let s;window.msCrypto&&(s=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);const i=await this._workerPool.send({type:"olm_create_account_otks",randomValues:s,otkAmount:t}).response();e.unpickle("",i)}async createOutboundOlmSession(e,t,s,i){const n=e.pickle("");let o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:n,theirIdentityKey:s,theirOneTimeKey:i,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}}class jt{constructor(e,t,s,i){this._logger=s,this.start=s._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=i}runDetached(e,t,s,i){return this._logger.runDetached(e,t,s,i)}wrapDetached(e,t,s,i){this.refDetached(this.runDetached(e,t,s,i))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,s,i){return this.child(e,s,i).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,s)=>{const i=s.durationOfType(e);return t+(i!=null?i:0)},0):0}log(e,t){const s=this.child(e,t);return s.end=s.start,s}set(e,t){if(typeof e=="object"){const s=e;Object.assign(this._values,s)}else this._values[e]=t;return this}serialize(e,t,s){if(this._filterCreator)try{e=this._filterCreator(new li(e),this)}catch(o){console.error("Error creating log filter",o)}let i=null;if(this._children&&(i=this._children.reduce((o,a)=>{const c=a.serialize(e,this.start,!1);return c&&(o===null&&(o=[]),o.push(c)),o},null)),e&&!e.filter(this,i))return;const n={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(n.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),s&&(n.f=!0),i&&(n.c=i),n}run(e){this.end!==void 0&&console.trace("log item is finished, additional logs will likely not be recorded");try{const t=e(this);return t instanceof Promise?t.then(s=>(this.finish(),s),s=>{throw this.catch(s)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}get level(){return _e}catch(e){return this.error=e,this.logLevel=_e.Error,this.finish(),e}child(e,t,s){this.end&&console.trace("log item is finished, additional logs will likely not be recorded"),t||(t=this.logLevel||_e.Info);const i=new jt(e,t,this._logger,s);return this._children||(this._children=[]),this._children.push(i),i}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class wo{constructor({platform:e,serializedTransformer:t=s=>s}){this._openItems=new Set,this._platform=e,this._serializedTransformer=t}log(e,t=_e.Info){const s=new jt(e,t,this);s.end=s.start,this._persistItem(s,void 0,!1)}wrapOrRun(e,t,s,i,n){return e?e.wrap(t,s,i,n):this.run(t,s,i,n)}runDetached(e,t,s,i){s||(s=_e.Info);const n=new jt(e,s,this);return this._run(n,t,s,!1,i),n}run(e,t,s,i){s===void 0&&(s=_e.Info);const n=new jt(e,s,this);return this._run(n,t,s,!0,i)}_run(e,t,s,i,n){this._openItems.add(e);const o=()=>{let a=new li;if(n)try{a=n(a,e)}catch(c){console.error("Error while creating log filter",c)}else a=a.minLevel(s);try{this._persistItem(e,a,!1)}catch(c){console.error("Could not persist log item",c)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(c=>(o(),c),c=>{if(o(),i)throw c}),i)return a}else if(o(),i)return a}catch(a){if(o(),i)throw a}}_finishOpenItems(){for(const e of this._openItems){e.finish();try{this._persistItem(e,new li,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}get level(){return _e}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class hm extends wo{constructor(e){super(e);const{name:t,flushInterval:s=60*1e3,limit:i=3e3}=e;this._name=t,this._limit=i,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this._platform.clock.createInterval(()=>this._tryFlush(),s)}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){const e=await this._openDB();try{const t=e.transaction(["logs"],"readwrite"),s=t.objectStore("logs"),i=this._queuedItems.length;for(const o of this._queuedItems)s.add(o);const n=await z(s.count());if(n>this._limit){let o=n-this._limit+Math.round(.1*this._limit);await U(s.openCursor(),(a,c,l)=>(l.delete(),o-=1,{done:o===0}))}await zt(t),this._queuedItems.splice(0,i)}catch(t){console.error("Could not flush logs",t)}finally{try{e.close()}catch{}}}_finishAllAndFlush(){this._finishOpenItems(),this.log({l:"pagehide, closing logs",t:"navigation"}),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this._name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return ki(this._name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}_persistItem(e,t,s){const i=e.serialize(t,void 0,s);if(i){const n=this._serializedTransformer(i);this._queuedItems.push({json:JSON.stringify(n)})}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this._name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async export(){const e=await this._openDB();try{const s=e.transaction(["logs"],"readonly").objectStore("logs"),n=(await tc(s.openCursor(),()=>!1)).concat(this._queuedItems);return new dm(n,this,this._platform)}finally{try{e.close()}catch{}}}async _removeItems(e){const t=await this._openDB();try{const s=t.transaction(["logs"],"readwrite"),i=s.objectStore("logs");for(const n of e)if(typeof n.id=="number")i.delete(n.id);else{const o=this._queuedItems.indexOf(n);o===-1&&this._queuedItems.splice(o,1)}await zt(s)}finally{try{t.close()}catch{}}}}class dm{constructor(e,t,s){this._items=e,this._logger=t,this._platform=s}get count(){return this._items.length}removeFromStore(){return this._logger._removeItems(this._items)}asBlob(){var n;const e={formatVersion:1,appVersion:(n=this._platform.updateService)==null?void 0:n.version,items:this._items.map(o=>JSON.parse(o.json))},t=JSON.stringify(e),s=this._platform.encoding.utf8.encode(t);return this._platform.createBlob(s,"application/json")}}class um extends wo{_persistItem(e){vo(e)}async export(){}}const mm=["l","id"];function pm(r){return Object.entries(r).filter(([e])=>!mm.includes(e)).reduce((e,[t,s])=>(e=e||{},e[t]=s,e),null)}function vo(r){const e=`${_m(r)} (${r.duration}ms)`,t=pm(r.values),s=r.children||t;if(s?(r.error?console.group(e):console.groupCollapsed(e),r.error&&console.error(r.error)):r.error?console.error(r.error):console.log(e),t&&console.table(t),r.children)for(const i of r.children)vo(i);s&&console.groupEnd()}function _m(r){return r.values.t==="network"?`${r.values.method} ${r.values.url}`:r.values.l&&typeof r.values.id!="undefined"?`${r.values.l} ${r.values.id}`:r.values.l&&typeof r.values.status!="undefined"?`${r.values.l} (${r.values.status})`:r.values.l&&r.error?`${r.values.l} failed`:typeof r.values.ref!="undefined"?`ref ${r.values.ref}`:r.values.l||r.values.type}function bo(r){return typeof r!="object"||"nodeType"in r||Array.isArray(r)}function bt(r,e){return Object.entries(r).reduce((t,[s,i])=>(typeof i=="function"&&(i=i(e)),i?t+(t.length?" ":"")+s:t),"")}function yt(r,e,t){e==="className"&&(e="class"),t===!1?r.removeAttribute(e):(t===!0&&(t=e),r.setAttribute(e,t))}function gm(r,e,t){return So($i,r,e,t)}function So(r,e,t,s){t&&bo(t)&&(s=t,t=void 0);const i=document.createElementNS(r,e);if(t)for(let[n,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&n==="className"?bt(o,void 0):!1),yt(i,n,o);if(s){Array.isArray(s)||(s=[s]);for(let n of s)typeof n=="string"&&(n=Me(n)),i.appendChild(n)}return i}function Me(r){return document.createTextNode(r)}const $i="http://www.w3.org/1999/xhtml",fm="http://www.w3.org/2000/svg",Io={[$i]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","main","article","aside","del","blockquote","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","select","option","label","form","progress","output","video"],[fm]:["svg","g","path","circle","ellipse","rect","use"]},E={};for(const[r,e]of Object.entries(Io))for(const t of e)E[t]=function(s,i){return So(r,t,s,i)};function Qt(r,e){let t;try{t=r.mount(e)}catch(s){t=ym(s)}return t}function ym(r){const e=new Error().stack;let t=null;return e&&(t=e.split(`
`)[1]),E.div([E.h2("Something went wrong\u2026"),E.h3(r.message),E.p(`This occurred while running ${t}.`),E.pre(r.stack)])}function rn(r,e,t){if(e===r.childElementCount)r.appendChild(t);else{const i=r.children[e];r.insertBefore(t,i)}}function wm(r){r.innerHTML=""}function vm(r){return async e=>{var t,s;(t=e.target)==null||t.setAttribute("disabled","disabled"),await r(e),(s=e.target)==null||s.removeAttribute("disabled")}}class ts{constructor({list:e,onItemClick:t,className:s,tagName:i="ul",parentProvidesUpdates:n=!0},o){this._onItemClick=t,this._list=e,this._className=s,this._tagName=i,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:n}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=gm(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const s=Array.prototype.indexOf.call(this._root.childNodes,t),i=this._childInstances[s];i&&this._onItemClick(i,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const s=this._childCreator(t);this._childInstances.push(s),e.appendChild(Qt(s,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,s){this.moveChild(e,t)}onUpdate(e,t,s){this.updateChild(e,t,s)}addChild(e,t){const s=this._childCreator(t);this._childInstances.splice(e,0,s),rn(this._root,e,Qt(s,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[s]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,s),s.root().remove(),rn(this._root,t,s.root())}updateChild(e,t,s){if(this._childInstances){const i=this._childInstances[e];i&&i.update(t,s)}}recreateItem(e,t){if(this._childInstances){const s=this._childCreator(t);if(!s)this.onRemove(e,t);else{const[i]=this._childInstances.splice(e,1,s);this._root.replaceChild(s.mount(this._mountArgs),i.root()),i.unmount()}}}getChildInstanceByIndex(e){var t;return(t=this._childInstances)==null?void 0:t[e]}}class Eo{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){var e;typeof((e=this._value)==null?void 0:e.on)=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function bm(r){for(const e of Object.values(r))if(typeof e=="function")return!0;return!1}class v extends Eo{constructor(){super(...arguments),this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.addEventListener(t,s,i)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.removeEventListener(t,s,i)}mount(e){const t=new ko(this);try{this._root=this.render(t,this._value)}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const s of this._bindings)s()}_addEventListener(e,t,s,i=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:s,useCapture:i})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const s of this._subViews)s.update(e,t)}}class ko{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,s,i=!1){this._templateView._addEventListener(e,t,s,i)}_addAttributeBinding(e,t,s){let i;const n=()=>{const o=s(this._value);i!==o&&(i=o,yt(e,t,o))};this._addBinding(n),n()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",s=>bt(t,s))}_addTextBinding(e){const t=e(this._value)+"",s=Me(t);let i=t;const n=()=>{const o=e(this._value)+"";i!==o&&(i=o,s.textContent=o)};return this._addBinding(n),s}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[s,i]of Object.entries(t))if(typeof i=="object"){if(s!=="className"||i===null)continue;bm(i)?this._addClassNamesBinding(e,i):yt(e,s,bt(i,this._value))}else if(this._isEventHandler(s,i)){const n=s.substr(2,1).toLowerCase()+s.substr(3),o=i;this._templateView._addEventListener(e,n,o)}else typeof i=="function"?this._addAttributeBinding(e,s,i):yt(e,s,i)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let s of t)typeof s=="function"?s=this._addTextBinding(s):typeof s=="string"&&(s=Me(s)),e.appendChild(s)}_addReplaceNodeBinding(e,t){let s=e(this._value),i=t(null);const n=()=>{const o=e(this._value);if(s!==o){s=o;const a=t(i);i.parentNode&&i.parentNode.replaceChild(a,i),i=a}};return this._addBinding(n),i}el(e,t,s){return this.elNS($i,e,t,s)}elNS(e,t,s,i){let n;s&&(bo(s)?i=s:n=s);const o=document.createElementNS(e,t);return n&&this._setNodeAttributes(o,n),i&&this._setNodeChildren(o,i),o}view(e,t){return this._templateView.addSubView(e),Qt(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,s=>{if(s&&s.nodeType!==Node.COMMENT_NODE){const n=this._templateView._subViews;if(n){const o=n.findIndex(a=>a.root()===s);if(o!==-1){const[a]=n.splice(o,1);a.unmount()}}}const i=t(e(this._value));return i?this.view(i):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,s=>new Ms(this._value,(i,n)=>{const o=t(s,i,n);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(s=>!!e(s),s=>s?t(this._value):null)}if(e,t){return this.ifView(e,s=>new Ms(s,t))}mapSideEffect(e,t){let s=e(this._value);const i=()=>{const n=e(this._value);s!==n&&(t(n,s),s=n)};this._addBinding(i),t(s,void 0)}}for(const[r,e]of Object.entries(Io))for(const t of e)ko.prototype[t]=function(s,i){return this.elNS(r,t,s,i)};class Ms extends v{constructor(e,t){super(e),this._render=t}render(e,t){return this._render(e,t)}}function st(r,e,t=void 0){const s=!!r.avatarUrl(e);let i=bt({avatar:!0,[`size-${e}`]:!0,[`usercolor${r.avatarColorNumber}`]:!s});t&&(i+=` ${t}`);const n=s?Ro(r,e):Me(r.avatarLetter),o=E.div({className:i},[n]);return s&&(yt(o,"data-avatar-letter",r.avatarLetter),yt(o,"data-avatar-color",r.avatarColorNumber)),o}function Ro(r,e){const t=e.toString();return E.img({src:r.avatarUrl(e),width:t,height:t,title:r.avatarTitle})}function Sm(r){const e=r.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function nn(r){if(!Sm(r))return;const e=r.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);const s=e.getAttribute("data-avatar-letter");e.textContent=s}class lt extends Eo{constructor(e,t){super(e),this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=st(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const s=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(Ro(e,this._size),this._root.firstChild),this._root.classList.remove(s)):(this._root.textContent=e.avatarLetter,this._root.classList.add(s))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const s=this._root.firstChild;s.tagName==="IMG"&&s.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}let Lt;function Oe(r,e=void 0){Lt===void 0&&(Lt=document.querySelector(".hydrogen"));const t=Object.assign({spinner:!0},e);return Lt!=null&&Lt.classList.contains("legacy")?r.div({className:t},[r.div(),r.div(),r.div(),r.div()]):r.svg({className:t,viewBox:"0 0 100 100"},r.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class Im extends v{render(e,t){const s={active:i=>i.isOpen,hidden:i=>i.hidden};return e.li({className:s},[e.a({href:t.url},[e.view(new lt(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:i=>i.isUnread}},i=>i.name),e.map(i=>i.busy,i=>i?Oe(e):e.div({className:{badge:!0,highlighted:n=>n.isHighlighted,hidden:n=>!n.badgeCount}},n=>n.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}class Em extends v{render(e,t){const s=()=>{i.value="",i.blur(),n.blur(),t.clear()},i=e.input({type:"text",placeholder:t==null?void 0:t.label,"aria-label":t==null?void 0:t.label,autocomplete:t==null?void 0:t.autocomplete,enterkeyhint:"search",name:t==null?void 0:t.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&s()},onFocus:()=>i.select()}),n=e.button({onClick:s,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[i,n])}}class km extends v{render(e,t){const s=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,i=e.view(new ts({className:"RoomList",list:t.tileViewModels},o=>new Im(o))),n=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new Em({i18n:t.i18n,label:t.i18n`Filter rooms…`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(i.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:s,"aria-label":s}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`}),e.a({className:"button-utility create",href:t.createRoomUrl,"aria-label":t.i18n`Create room`,title:t.i18n`Create room`})]);return e.div({className:"LeftPanel"},[n,i])}}class qi{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=E.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=Rm(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,s=this._popup.clientHeight,i=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>i.bottom||e.left>i.right||e.bottom<i.top||e.right<i.left)return!1;if(i.bottom>=e.bottom+s)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(i.top<=e.top-s)this._popup.style.top=`${e.top-s-this._verticalPadding}px`;else return!1;if(i.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(i.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}function Rm(r){let e=r;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){const s=window.getComputedStyle(e).getPropertyValue("overflow-y");if(s==="auto"||s==="scroll")return e}while(e!==document.body)}class Y extends v{static option(e,t){return new Cm(e,t)}constructor(e){super(),this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}}class Cm{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}function on(r){return r.offsetTop+r.clientHeight}function an(r,e,t=r.children.length-1){for(var s=t;s>=0;s--)if(r.children[s].offsetTop<e)return s;return 0}class Tm extends v{constructor(e,t){super(e),this.viewClassForTile=t,this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new Mm(t.tiles,()=>this.restoreScrollPosition(),this.viewClassForTile);const s=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:i=>!i.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(s)),s}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,s=e.clientHeight-t.clientHeight;if(s>0){t.style.setProperty("margin-top",`${s}px`);const i=this.value.tiles.length;this.updateVisibleRange(0,i-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const i=on(this.anchoredNode);if(i!==this.anchoredBottom){const n=i-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,n):e.scrollTop=e.scrollTop+n,this.anchoredBottom=i}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:s,scrollTop:i,clientHeight:n}=e;let o;if(this.stickToBottom=Math.abs(s-(i+n))<1,this.stickToBottom)o=this.value.tiles.length-1;else{const c=i+n,l=an(t,c);this.anchoredNode=t.childNodes[l],this.anchoredBottom=on(this.anchoredNode),o=l}let a=an(t,i,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){const s=this.tilesView.getChildInstanceByIndex(e),i=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(s==null?void 0:s.value,i==null?void 0:i.value)}}class Mm extends ts{constructor(e,t,s){super({list:e,onItemClick:(i,n)=>i.onClick(n)},i=>{const n=s(i);return new n(i,s)}),this.viewClassForTile=s,this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,s){if(s==="shape"){const i=this.viewClassForTile(t),n=this.getChildInstanceByIndex(e);if(!i||!(n instanceof i)){super.recreateItem(e,t);return}}super.onUpdate(e,t,s),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,s){super.onMove(e,t,s),this.onChanged()}}class Am extends v{render(e,t){return e.div({className:"TimelineLoadingView"},[Oe(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages…`:t.i18n`Loading messages…`)])}}class xm extends v{constructor(e,t){super(e),this._viewClassForTile=t,this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({onKeydown:n=>this._onKeyDown(n),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:n=>n.isEncrypted?"Send an encrypted message\u2026":"Send a message\u2026",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const s=e.map(n=>n.replyViewModel,(n,o)=>{const a=n&&this._viewClassForTile(n);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(n,this._viewClassForTile,{interactive:!1},"div"))]):null}),i=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:n=>this._toggleAttachmentMenu(n)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:n=>n.canSend}},[s,i])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(s){t(),console.error(s)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new qi(new Y([Y.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),Y.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),Y.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}}class Nm extends v{render(e){return e.div({className:"RoomArchivedView"},e.h3(t=>t.description))}}class Co extends v{constructor(e,t){super(e),this._viewClassForTile=t,this._optionsPopup=null}render(e,t){let s;return t.composerViewModel.kind==="composer"?s=new xm(t.composerViewModel,this._viewClassForTile):t.composerViewModel.kind==="archived"&&(s=new Nm(t.composerViewModel)),e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new lt(t,32)),e.div({className:"room-description"},[e.h2(i=>i.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:i=>this._toggleOptionsMenu(i)})]),e.div({className:"RoomView_body"},[e.div({className:"RoomView_error"},i=>i.error),e.mapView(i=>i.timelineViewModel,i=>i?new Tm(i,this._viewClassForTile):new Am(t)),e.view(s)])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,s=[];if(s.push(Y.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.canLeave&&s.push(Y.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&s.push(Y.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&s.push(Y.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!s.length)return;this._optionsPopup=new qi(new Y(s)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class Dm extends v{render(e,t){return e.main({className:"UnknownRoomView middle"},e.div([e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:s=>s.busy},t.i18n`Join room`),e.if(s=>s.error,s=>s.p({className:"error"},t.error))]))}}class St{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(E,e):this.render(E,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class To extends St{constructor(e="Loading"){super(e,(t,s)=>t.div({className:"LoadingView"},[Oe(t),s]))}}class Mo extends v{render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new lt(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)])]),e.div({className:"RoomView_body"},[e.mapView(s=>s.error,s=>s?new Lm(t):new To(t.i18n`Setting up the room…`))])])}}class Lm extends v{render(e,t){return e.div({className:"RoomBeingCreated_error centered-column"},[e.h3(t.i18n`Could not create the room, something went wrong:`),e.div({className:"RoomView_error form-group"},t.error),e.div({className:"button-row"},e.button({className:"button-action primary destructive",onClick:()=>t.cancel()},t.i18n`Cancel`))])}}class Ao extends v{render(e,t){var n;let s=[];t.isDirectMessage&&s.push(st(t,128,"InviteView_dmAvatar"));let i;return t.isDirectMessage?i=[e.strong(t.name),` (${(n=t.inviter)==null?void 0:n.id}) wants to chat with you.`]:t.inviter?i=[st(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:i="You were invited to join.",s.push(e.p({className:"InviteView_inviter"},i)),t.isDirectMessage||s.push(e.div({className:"InviteView_roomProfile"},[st(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),st(t,32),e.div({className:"room-description"},[e.h2(o=>o.name)])]),e.if(o=>o.error,o=>o.div({className:"RoomView_error"},a=>a.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...s,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:o=>o.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:o=>o.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class Om extends v{render(e,t){const s=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),i=e.div({role:"img","aria-label":c=>c.name,title:c=>c.name,className:{picture:!0,hidden:c=>!c.imageUrl},style:c=>`background-image: url('${c.imageUrl}'); max-width: ${c.imageWidth}px; max-height: ${c.imageHeight}px;`}),n=e.div({className:{loading:!0,hidden:c=>!!c.imageUrl}},[Oe(e),e.div(t.i18n`Loading image…`)]),o=e.div({className:"details"},[e.strong(c=>c.name),e.br(),"uploaded by ",e.strong(c=>c.sender),c=>` at ${c.time} on ${c.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:c=>this.clickToClose(c),onKeydown:c=>this.closeOnEscKey(c)},[i,n,o,s]);return Um(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}}function Um(r,e){const t=Pm(e),s=t[0],i=t[t.length-1];r.addEventListener(e,"keydown",n=>{n.key==="Tab"&&(n.shiftKey?document.activeElement===s&&(i.focus(),n.preventDefault()):document.activeElement===i&&(s.focus(),n.preventDefault()))},!0),Promise.resolve().then(()=>{s.focus()})}function Pm(r){return r.querySelectorAll("a[href], button, textarea, input, select")}class Vm extends v{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:s=>!s.isShown}},[Oe(e,{hidden:s=>!s.isWaiting}),e.p(s=>s.statusLabel),e.if(s=>s.isConnectNowShown,s=>s.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(s=>s.isSecretStorageShown,s=>s.a({href:t.setupKeyBackupUrl},"Go to settings")),e.if(s=>s.canDismiss,s=>s.div({className:"end"},s.button({className:"dismiss",onClick:()=>t.dismiss()})))])}}class Bm extends v{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const s=[];for(let i=0;i<t.height*t.width;i+=1)s.push(e.div({onClick:()=>t.focusTile(i),onFocusin:()=>t.focusTile(i),className:{container:!0,[`tile${i}`]:!0,focused:n=>n.focusIndex===i}},e.mapView(n=>n.roomViewModelAt(i),n=>n?n.kind==="roomBeingCreated"?new Mo(n):n.kind==="invite"?new Ao(n):new Co(n,this._viewClassForTile):new St(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return s.push(e.div({className:i=>`focus-ring tile${i.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},s)}}class xo extends v{render(e){return e.div([e.map(t=>t.status,(t,s,i)=>{switch(t){case"Enabled":return Fm(s,i);case"NewVersionAvailable":return Km(s,i);case"SetupKey":return $m(s,i);case"SetupPhrase":return qm(s,i);case"Pending":return s.p(i.i18n`Waiting to go online…`)}}),e.map(t=>t.backupWriteStatus,(t,s,i)=>{switch(t){case"Writing":{const n=s.progress({min:0,max:100,value:o=>o.backupPercentage});return s.div(["Backup in progress ",n," ",o=>o.backupInProgressLabel])}case"Stopped":{let n;return i.backupError?n=`Backup has stopped because of an error: ${i.backupError}`:n="Backup has stopped",s.p(n," ",s.button({onClick:()=>i.startBackup()},"Backup now"))}case"Done":return s.p("All keys are backed up.");default:return null}})])}}function Fm(r,e){const t=[r.p([e.i18n`Key backup is enabled, using backup version ${e.backupVersion}. `,r.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(r.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),r.div(t)}function Km(r,e){const t=[r.p([e.i18n`A new backup version has been created from another device. Disable key backup and enable it again with the new key.`,r.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return r.div(t)}function $m(r,e){const t=r.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return r.div([r.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),Do(r),No(r,e,e.i18n`Security key`,(s,i)=>e.enterSecurityKey(s,i)),r.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function qm(r,e){const t=r.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return r.div([r.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),Do(r),No(r,e,e.i18n`Security phrase`,(s,i)=>e.enterSecurityPhrase(s,i)),r.p([e.i18n`You can also `,t,e.i18n`.`])])}function No(r,e,t,s){let i;const n=()=>s(o.value,(i==null?void 0:i.checked)||!1),o=r.input({type:"password",disabled:c=>c.isBusy,placeholder:t}),a=[r.p([o,r.button({disabled:c=>c.isBusy,onClick:n},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){i=r.input({type:"checkbox",id:"enable-dehydrated-device"});const c=r.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(r.p([i,r.label({for:i.id},[e.i18n`Back up my device as well (`,c,")"])]))}return r.div({className:"row"},[r.div({className:"label"},t),r.div({className:"content"},a)])}function Do(r){return r.if(e=>e.error,(e,t)=>e.div([e.p({className:"error"},s=>s.i18n`Could not enable key backup: ${s.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}class jm extends v{render(e,t){let s=t.version;t.showUpdateButton&&(s=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const i=(a,c,l,h="")=>a.div({className:`row ${h}`},[a.div({className:"label"},c),a.div({className:"content"},l)]),n=[];n.push(e.h3("Session"),i(e,t.i18n`User ID`,t.userId),i(e,t.i18n`Session ID`,t.deviceId,"code"),i(e,t.i18n`Session key`,t.fingerprintKey,"code"),i(e,"",e.button({onClick:()=>t.logout(),disabled:a=>a.isLoggingOut},t.i18n`Log out`))),n.push(e.h3("Key backup"),e.view(new xo(t.keyBackupViewModel))),n.push(e.h3("Notifications"),e.map(a=>a.pushNotifications.supported,(a,c)=>{if(a===null)return c.p(t.i18n`Loading…`);if(a){const l=d=>d.pushNotifications.enabled?d.i18n`Push notifications are enabled`:d.i18n`Push notifications are disabled`,h=d=>d.pushNotifications.enabled?d.i18n`Disable`:d.i18n`Enable`;return i(c,l,c.button({onClick:()=>t.togglePushNotifications(),disabled:d=>d.pushNotifications.updating},h))}else return c.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(a=>a.pushNotifications.supported&&a.pushNotifications.enabled,a=>a.div([a.p(["If you think push notifications are not being delivered, ",a.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),a.map(c=>c.pushNotifications.enabledOnServer,(c,l)=>{if(c===!0)return l.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(c===!1)return l.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),a.map(c=>c.pushNotifications.serverError,(c,l)=>{if(c)return l.p("Couldn't not check on server: "+c.message)})]))),n.push(e.h3("Preferences"),i(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t)),e.if(a=>a.activeTheme,(a,c)=>i(a,c.i18n`Use the following theme`,this._themeOptions(a,c))));const o=[];return t.canSendLogsToServer&&o.push(e.button({onClick:vm(()=>t.sendLogsToServer())},`Submit logs to ${t.logsServer}`)),o.push(e.button({onClick:()=>t.exportLogs()},"Download logs")),n.push(e.h3("Application"),i(e,t.i18n`Version`,s),i(e,t.i18n`Storage usage`,a=>`${a.storageUsage} / ${a.storageQuota}`),i(e,t.i18n`Debug logs`,o),e.p({className:{hidden:a=>!a.logsFeedbackMessage}},a=>a.logsFeedbackMessage),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},n)])}_imageCompressionRange(e,t){const i=Math.ceil(t.minSentImageSizeLimit/32)*32,n=(Math.floor(t.maxSentImageSizeLimit/32)+1)*32,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:32,min:i,max:n,value:a=>a.sentImageSizeLimit||n,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}_themeOptions(e,t){const{themeName:s,themeVariant:i}=t.activeTheme,n=[];for(const _ of Object.keys(t.themeMapping))n.push(e.option({value:_,selected:_===s},_));const o=e.select({onChange:_=>{const g=_.target.value;if(!("id"in t.themeMapping[g])){const b=h.checked?"dark":m.checked?"light":"default";a(b);return}t.changeThemeOption(g)}},n),a=_=>{const g=o.options[o.selectedIndex].value;t.changeThemeOption(g,_)},c=i==="dark",l=i==="light",h=e.input({type:"radio",name:"radio-chooser",value:"dark",id:"dark",checked:c}),d=e.input({type:"radio",name:"radio-chooser",value:"default",id:"default",checked:!(c||l)}),m=e.input({type:"radio",name:"radio-chooser",value:"light",id:"light",checked:l}),p=e.form({className:{hidden:()=>{const _=o.options[o.selectedIndex].value;return"id"in t.themeMapping[_]}},onChange:_=>a(_.target.value)},[d,e.label({for:"default"},"Match system theme"),h,e.label({for:"dark"},"dark"),m,e.label({for:"light"},"light")]);return e.div({className:"theme-chooser"},[o,p])}}class Wm extends v{render(e,t){return e.main({className:"middle"},e.div({className:"CreateRoomView centered-column"},[e.h2("Create room"),e.form({className:"CreateRoomView_detailsForm form",onChange:s=>this.onFormChange(s),onSubmit:s=>this.onSubmit(s)},[e.div({className:"vertical-layout"},[e.button({type:"button",className:"CreateRoomView_selectAvatar",onClick:()=>t.selectAvatar()},e.mapView(s=>s.hasAvatar,s=>s?new lt(t,64):new St(void 0,i=>i.div({className:"CreateRoomView_selectAvatarPlaceholder"})))),e.div({className:"stretch form-row text"},[e.label({for:"name"},t.i18n`Room name`),e.input({onInput:s=>t.setName(s.target.value),type:"text",name:"name",id:"name",placeholder:t.i18n`Enter a room name`})])]),e.div({className:"form-row text"},[e.label({for:"topic"},t.i18n`Topic (optional)`),e.textarea({onInput:s=>t.setTopic(s.target.value),name:"topic",id:"topic",placeholder:t.i18n`Topic`})]),e.div({className:"form-group"},[e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPrivate",value:"false",checked:!t.isPublic}),e.label({for:"isPrivate"},t.i18n`Private room, only upon invitation.`)]),e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPublic",value:"true",checked:t.isPublic}),e.label({for:"isPublic"},t.i18n`Public room, anyone can join`)])]),e.div({className:{"form-row check":!0,hidden:s=>s.isPublic}},[e.input({type:"checkbox",name:"isEncrypted",id:"isEncrypted",checked:t.isEncrypted}),e.label({for:"isEncrypted"},t.i18n`Enable end-to-end encryption`)]),e.div({className:{"form-row text":!0,hidden:s=>!s.isPublic}},[e.label({for:"roomAlias"},t.i18n`Room alias`),e.input({onInput:s=>t.setRoomAlias(s.target.value),type:"text",name:"roomAlias",id:"roomAlias",placeholder:t.i18n`Room alias (<alias>, or #<alias> or #<alias>:hs.tld`})]),e.div({className:"form-group"},[e.div(e.button({className:"link",type:"button",onClick:()=>t.toggleAdvancedShown()},s=>s.isAdvancedShown?s.i18n`Hide advanced settings`:s.i18n`Show advanced settings`)),e.div({className:{"form-row check":!0,hidden:s=>!s.isAdvancedShown}},[e.input({type:"checkbox",name:"isFederationDisabled",id:"isFederationDisabled",checked:t.isFederationDisabled}),e.label({for:"isFederationDisabled"},[t.i18n`Disable federation`,e.p({className:"form-row-description"},t.i18n`Can't be changed later. This will prevent people on other homeservers from joining the room. This is typically used when only people from your own organisation (if applicable) should be allowed in the room, and is otherwise not needed.`)])])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s=>!s.canCreate},t.i18n`Create room`)])])]))}onFormChange(e){switch(e.target.name){case"isEncrypted":this.value.setEncrypted(e.target.checked);break;case"isPublic":this.value.setPublic(e.currentTarget.isPublic.value==="true");break;case"isFederationDisabled":this.value.setFederationDisabled(e.target.checked);break}}onSubmit(e){e.preventDefault(),this.value.create()}}class Hm extends v{render(e,t){const s=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new lt(t,52)),e.mapView(i=>i.isEncrypted,i=>new zm(i))]),e.div({className:"RoomDetailsView_name"},[e.h2(i=>i.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},i=>i.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},s)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?E.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,s,i){const n=bt(as({RoomDetailsView_label:!0},s));return e.div({className:"RoomDetailsView_row"},[e.div({className:n},[t]),e.div({className:"RoomDetailsView_value"},i)])}_createRightPanelButtonRow(e,t,s,i,n){const o=bt(as({RoomDetailsView_label:!0},s));return e.button({className:"RoomDetailsView_row",onClick:n},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},i)])}}class zm extends v{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class Gm{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let s=0;for(s=0;s<this.start;s+=1)e.next();for(s=0;s<this.length;s+=1){const i=e.next();if(i.done)break;t(i.value,this.start+s)}}[Symbol.iterator](){return new Jm(this)}reverseIterable(){return new Qm(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?nt.Before:e<this.end?nt.Inside:nt.After}}var nt=(r=>(r[r.Before=1]="Before",r[r.Inside=2]="Inside",r[r.After=3]="After",r))(nt||{});class Jm{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class Qm{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}function Ym(r,e){let t=0;for(;t<e;)if(t+=1,r.next().done)return!1;return!0}function ys(r,e){if(Ym(r,e)){const t=r.next();if(!t.done)return t.value}}var ft=(r=>(r[r.Move=0]="Move",r[r.Add=1]="Add",r[r.Remove=2]="Remove",r[r.RemoveAndAdd=3]="RemoveAndAdd",r[r.UpdateRange=4]="UpdateRange",r))(ft||{});class Wt extends Gm{constructor(e,t,s,i=t-e){super(e,t),this._totalLength=s,this._viewportItemCount=i}expand(e){if(this.length===0)return this;const t=Math.max(0,this.start-e),s=Math.min(this.totalLength,this.end+e);return new Wt(t,s,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,s,i){const n=Math.min(Math.max(0,Math.floor(i/t)),e),o=e-n,a=s!==0?Math.ceil(s/t):0,c=Math.min(a,o);return new Wt(n,n+c,e,a)}queryAdd(e,t,s){const i=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=i){const n=this.clampIndex(e,i),o=n===e?t:ys(s[Symbol.iterator](),n);return this.createAddResult(n,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const s=this.clampIndex(e);return this.createRemoveResult(s,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,s,i){const n=this.getIndexZone(e),o=this.getIndexZone(t);if(n===o){if(n===nt.Before||n===nt.After)return;if(n===nt.Inside)return{type:0,fromIdx:e,toIdx:t}}else{const a=this.clampIndex(t),c=this.clampIndex(e),l=a===t?s:ys(i[Symbol.iterator](),a);return{type:3,removeIdx:c,addIdx:a,value:l}}}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{const s=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:3,removeIdx:s,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){const s=this.clampIndex(Number.MAX_SAFE_INTEGER),i=ys(t[Symbol.iterator](),s);return{type:3,removeIdx:e,value:i,addIdx:s,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){const s=this.deriveRange(-1,0,1),i=s.start,n=ys(t[Symbol.iterator](),i);return{type:3,removeIdx:e,value:n,addIdx:i,newRange:s}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,s=0){const i=this.start-s,n=this.totalLength+e,o=Math.min(Math.max(i,this.end-s+t),n);return new Wt(i,o,n,this.viewportItemCount)}}class Xm extends ts{constructor(n,i){var o=n,{itemHeight:e,overflowItems:t=20}=o,s=_r(o,["itemHeight","overflowItems"]);super(s,i),this.itemHeight=e,this.overflowItems=t}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return Wt.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){wm(this._listElement);const t=document.createDocumentFragment(),s=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(s,i=>{const n=this._childCreator(i);this._childInstances.push(n),t.appendChild(Qt(n,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const s of e.reverseIterable())if(!t.containsIndex(s)){const i=s-e.start;this.removeChild(i)}t.forEachInIterator(this._list[Symbol.iterator](),(s,i)=>{if(!e.containsIndex(i)){const n=i-t.start;this.addChild(n,s)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,s=(e.totalLength-e.end)*this.itemHeight,i=this._listElement.style;i.paddingTop=`${t}px`,i.paddingBottom=`${s}px`}mount(){const e=super.mount();return this.scrollContainer=E.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const s=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(s)}onRemove(e,t){const s=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(s)}onMove(e,t,s){const i=this.renderRange.queryMove(e,t,s,this._list);i&&(i.type===ft.Move?this.moveChild(this.renderRange.toLocalIndex(i.fromIdx),this.renderRange.toLocalIndex(i.toIdx)):this.applyRemoveAddResult(i))}onUpdate(e,t,s){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,s)}applyRemoveAddResult(e){(e.type===ft.Remove||e.type===ft.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===ft.Add||e.type===ft.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class Zm extends v{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new lt(t,32)),e.div({className:"MemberTileView_name"},s=>s.name)]))}}class ep extends Xm{constructor(e){super({list:e.memberTileViewModels,className:"MemberListView",itemHeight:40},t=>new Zm(t))}}class tp extends v{render(e,t){return e.div({className:"MemberDetailsView"},[e.view(new lt(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(s=>s.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,s=>s.role),this._createSection(e,t.i18n`Security`,t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`),this._createOptions(e,t)])}_createSection(e,t,s){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},s)])}_createOptions(e,t){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`),e.button({className:"text",onClick:()=>t.openDirectMessage()},t.i18n`Open direct message`)])])}}class sp extends v{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new ip(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e==null?void 0:e.type){case"room-details":return new Hm(e);case"member-list":return new ep(e);case"member-details":return new tp(e);default:return new To}}}class ip extends v{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:!t.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class rp extends ts{constructor(e){const t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:s=>s.onClick()};super(t,s=>new np(s))}}class np extends v{render(e,t){return e.button({className:{active:s=>s.isActive,pending:s=>s.isPending}},[t.key," ",s=>`${s.count}`])}onClick(){this.value.toggle()}}class Rt extends v{constructor(e,t,s,i="li"){super(e),this._menuPopup=null,this._tagName=i,this._viewClassForTile=t,this._renderFlags=s}get _interactive(){var e,t;return(t=(e=this._renderFlags)==null?void 0:e.interactive)!=null?t:!0}get _isReplyPreview(){var e;return(e=this._renderFlags)==null?void 0:e.reply}render(e,t){const s=[this.renderMessageBody(e,t)];this._interactive&&s.push(e.button({className:"Timeline_messageOptions"},"\u22EF"));const i=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:t.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation},"data-event-id":t.eventId},s);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)i.removeChild(i.querySelector(".Timeline_messageAvatar")),i.removeChild(i.querySelector(".Timeline_messageSender"));else if(!o&&!this._isReplyPreview){const c=E.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[st(t,30)]),l=E.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`},t.displayName);i.insertBefore(c,i.firstChild),i.insertBefore(l,i.firstChild)}});let n=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!n?(n=new rp(o),this.addSubView(n),i.appendChild(Qt(n))):!o&&n&&(i.removeChild(n.root()),n.unmount(),this.removeSubView(n),n=null)}),i}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const s=()=>this.root().classList.remove("menuOpen");this._menuPopup=new qi(new Y(t),s),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&e.shape!=="redacted"&&!e.isPending&&(t.push(new op(e)),t.push(Y.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(Y.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(Y.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t}renderMessageBody(){}}class op{constructor(e){this._vm=e}toDOM(e){const t=["\u{1F44D}","\u{1F44E}","\u{1F604}","\u{1F389}","\u{1F615}","\u2764\uFE0F","\u{1F680}","\u{1F440}"].map(i=>e.button({onClick:()=>this._vm.react(i)},i)),s=e.button({onClick:()=>{const i=prompt("Enter your reaction (emoji)");i&&this._vm.react(i)}},"\u2026");return e.li({className:"quick-reactions"},[...t,s])}}class ap extends v{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const s=this._viewClassForTile(t);if(!s)throw new Error(`Shape ${t.shape} is unrecognized.`);const i=new s(t,this._viewClassForTile,{reply:!0,interactive:!1});return e.div({className:"ReplyPreviewView"},e.blockquote([e.a({className:"link",href:t.permaLink},"In reply to"),e.a({className:"pill",href:t.senderProfileLink},[st(t,12,void 0),t.displayName]),e.br(),e.view(i)]))}}class cp extends v{render(e){return e.blockquote({className:"ReplyPreviewView"},[e.div({className:"Timeline_messageBody statusMessage"},"This reply could not be found.")])}}class lp extends Rt{renderMessageBody(e,t){const s=e.time({className:{hidden:!t.date}},t.date+" "+t.time),i=e.div({className:{Timeline_messageBody:!0,statusMessage:o=>o.shape==="message-status"}},e.mapView(o=>o.replyTile,o=>this._isReplyPreview?null:t.isReply&&!o?new cp:o?new ap(o,this._viewClassForTile):null)),n=o=>(o==null?void 0:o.nodeType)!==Node.COMMENT_NODE&&o.className!=="ReplyPreviewView";return e.mapSideEffect(o=>o.body,o=>{for(;n(i.lastChild);)i.removeChild(i.lastChild);for(const a of o.parts)i.appendChild(Lo(a));i.appendChild(s)}),i}}function hp(r){const e=r.items.map(s=>E.li(ot(s))),t=r.startOffset;return t?E.ol({start:t},e):E.ul(e)}function dp(r){const e={src:r.src};return r.width&&(e.width=r.width),r.height&&(e.height=r.height),r.alt&&(e.alt=r.alt),r.title&&(e.title=r.title),E.img(e)}function up(r){const e=`avatar size-12 usercolor${r.avatarColorNumber}`,t=E.div({class:e},Me(r.avatarInitials)),s=ot(r.children);return s.unshift(t),E.a({class:"pill",href:r.href,rel:"noopener",target:"_blank"},s)}function mp(r){const e=[];if(r.head){const s=r.head.map(i=>E.th(ot(i)));e.push(E.thead(E.tr(s)))}const t=[];for(const s of r.body){const i=s.map(n=>E.td(ot(n)));t.push(E.tr(i))}return e.push(E.tbody(t)),E.table(e)}const pp={header:r=>E["h"+Math.min(6,r.level)](ot(r.inlines)),codeblock:r=>E.pre(E.code(Me(r.text))),table:r=>mp(r),code:r=>E.code(Me(r.text)),text:r=>Me(r.text),link:r=>E.a({href:r.url,className:"link",target:"_blank",rel:"noopener"},ot(r.inlines)),pill:up,format:r=>E[r.format](ot(r.children)),rule:()=>E.hr(),list:hp,image:dp,newline:()=>E.br()};function Lo(r){const e=pp[r.type];return e?e(r):Me(`[unknown part type ${r.type}]`)}function ot(r){return Array.from(r,Lo)}class Oo extends Rt{renderMessageBody(e,t){let i=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(i=`height: ${t.height}px`);const n=[e.div({className:"spacer",style:i}),this.renderMedia(e,t),e.time(t.date+" "+t.time)],o=e.div({className:{status:!0,hidden:a=>!a.status}},a=>a.status);if(n.push(o),t.isPending){const a=e.progress({min:0,max:100,value:c=>c.uploadPercentage,className:{hidden:c=>!c.isUploading}});n.push(a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`},n),e.if(a=>a.error,a=>a.p({className:"error"},t.error))])}createMenuOptions(e){const t=super.createMenuOptions(e);if(!e.isPending){let s;switch(e.shape){case"image":s=e.i18n`Download image`;break;case"video":s=e.i18n`Download video`;break;default:s=e.i18n`Download media`;break}t.push(Y.option(s,()=>e.downloadMedia()))}return t}}class _p extends Oo{renderMedia(e,t){const s=e.img({src:i=>i.thumbnailUrl,alt:i=>i.label,title:i=>i.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending?s:e.a({href:t.lightboxUrl},s)}}function As(r,e){return new Promise((t,s)=>{let i;const n=a=>{i(),s(a.target.error)},o=()=>{i(),t()};i=()=>{r.removeEventListener(e,o),r.removeEventListener("error",n)},r.addEventListener(e,o),r.addEventListener("error",n)})}class gp extends Oo{renderMedia(e){const t=e.video({src:s=>s.videoUrl||`data:${s.mimeType},`,title:s=>s.label,controls:!0,preload:"none",poster:s=>s.thumbnailUrl,onPlay:this._onPlay.bind(this),style:s=>`max-width: ${s.width}px; max-height: ${s.height}px;${s.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const s=e.target;await t.loadVideo();const i=As(s,"loadeddata");s.load(),await i,s.play()}catch{}}_onError(e){const t=this.value,s=e.target,i=s.error;if(i instanceof window.MediaError&&i.code===4)if(!s.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(i)}}class fp extends Rt{renderMessageBody(e,t){const s=[];return t.isPending?s.push(i=>i.label):s.push(e.button({className:"link",onClick:()=>t.download()},i=>i.label),e.time(t.date+" "+t.time)),e.p({className:"Timeline_messageBody statusMessage"},s)}}class yp extends Rt{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},[e.span(t.label),e.a({className:"Timeline_locationLink",href:t.mapsLink,target:"_blank",rel:"noopener"},t.i18n`Open in maps`),e.time(t.date+" "+t.time)])}}class wp extends Rt{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class vp extends v{constructor(e){super(e)}render(e){return e.li({className:"AnnouncementView"},e.div(t=>t.announcement))}onClick(){}}class bp extends Rt{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(Y.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}}class Sp extends v{constructor(e){super(e)}render(e){const t={GapView:!0,isLoading:s=>s.isLoading,isAtTop:s=>s.isAtTop};return e.li({className:t},[Oe(e),e.div(s=>s.isLoading?s.i18n`Loading more messages …`:s.i18n`Not loading!`),e.if(s=>s.error,s=>s.strong(i=>i.error))])}onClick(){}}function cn(r){switch(r.shape){case"gap":return Sp;case"announcement":return vp;case"message":case"message-status":return lp;case"image":return _p;case"video":return gp;case"file":return fp;case"location":return yp;case"missing-attachment":return wp;case"redacted":return bp;default:throw new Error(`Tiles of shape "${r.shape}" are not supported, check the tileClassForEntry function in the view model`)}}class Ip extends v{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":s=>!!s.activeMiddleViewModel,"right-shown":s=>!!s.rightPanelViewModel}},[e.view(new Vm(t.sessionStatusViewModel)),e.view(new km(t.leftPanelViewModel)),e.mapView(s=>s.activeMiddleViewModel,()=>t.roomGridViewModel?new Bm(t.roomGridViewModel,cn):t.settingsViewModel?new jm(t.settingsViewModel):t.createRoomViewModel?new Wm(t.createRoomViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new Ao(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new Co(t.currentRoomViewModel,cn):t.currentRoomViewModel.kind==="roomBeingCreated"?new Mo(t.currentRoomViewModel):new Dm(t.currentRoomViewModel):new St(s=>s.div({className:"room-placeholder"},s.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(s=>s.lightboxViewModel,s=>s?new Om(s):null),e.mapView(s=>s.rightPanelViewModel,s=>s?new sp(s):null)])}}function Uo(r){return "3190035768"?r.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web/releases/tag/v0.2.33"},`Hydrogen v0.2.33 (${"3190035768"}) on Github`):r.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class Ep extends v{render(e,t){const s=o=>!!o.isBusy,i=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:s}),n=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:s});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(i.value,n.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row text"},[e.label({for:"username"},t.i18n`Username`),i]),e.div({className:"form-row text"},[e.label({for:"password"},t.i18n`Password`),n]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s},t.i18n`Log In`)])])])}}class kp extends v{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(s=>s.decryptDehydratedDeviceViewModel,s=>new xo(s.decryptDehydratedDeviceViewModel)),e.map(s=>s.deviceDecrypted,(s,i)=>s?i.p(t.i18n`That worked out, you're good to go!`):i.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},s=>s.deviceDecrypted?s.i18n`Continue`:s.i18n`Continue without restoring`)])])}}class Ls extends v{render(e){const t=e.if(i=>i.hasError,(i,n)=>i.button({onClick:()=>n.exportLogs()},n.i18n`Export logs`)),s=e.if(i=>i.hasError,(i,n)=>i.button({onClick:()=>n.logout()},n.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[Oe(e,{hidden:i=>!i.loading}),e.p(i=>i.loadLabel),t,s]),e.ifView(i=>i.accountSetupViewModel,i=>new kp(i.accountSetupViewModel))])}}class Rp extends v{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,s)=>t.p({className:"error"},s.i18n(s.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new Ls(t):null)])}}class Cp extends v{render(e,t){const s=i=>i.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:s}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(i=>i.completeSSOLoginViewModel,i=>i?new Rp(i):null),e.if(i=>i.showHomeserver,(i,n)=>i.div({className:"LoginView_sso form-row text"},[i.label({for:"homeserver"},n.i18n`Homeserver`),i.input({id:"homeserver",type:"text",placeholder:n.i18n`Your matrix homeserver`,value:n.homeserver,disabled:s,onInput:o=>n.setHomeserver(o.target.value),onChange:()=>n.queryHomeserver()}),i.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),i.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(i=>i.isFetchingLoginOptions,i=>i.div({className:"LoginView_query-spinner"},[Oe(i),i.p("Fetching available login options...")])),e.mapView(i=>i.passwordLoginViewModel,i=>i?new Ep(i):null),e.if(i=>i.passwordLoginViewModel&&i.startSSOLoginViewModel,i=>i.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(i=>i.startSSOLoginViewModel,i=>i?new Tp(i):null),e.mapView(i=>i.loadViewModel,i=>i?new Ls(i):null),e.p(Uo(e))])}}class Tp extends v{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:s=>s.isBusy},t.i18n`Log in with SSO`))}}class Mp extends v{render(e,t){const s=new Ms(t,n=>n.div([n.p("Are you sure you want to log out?"),n.div({className:"button-row"},[n.a({className:"button-action",type:"submit",href:t.cancelUrl},["Cancel"]),n.button({className:"button-action primary destructive",type:"submit",onClick:()=>t.logout()},t.i18n`Log out`)])])),i=new Ms(t,n=>n.p({className:"status",hidden:o=>!o.showStatus},[Oe(n,{hidden:o=>!o.busy}),n.span(o=>o.status)]));return e.div({className:"LogoutScreen"},[e.div({className:"content"},[e.mapView(n=>n.showConfirm,n=>n?s:i)])])}}class Ap extends v{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new Ls(t))]),e.div({className:{"button-row":!0,hidden:s=>s.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class xp extends v{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},s=>s.avatarInitials),e.div({className:"user-id"},s=>s.label)])])}}class Np extends v{render(e,t){const s=new ts({list:t.sessions,parentProvidesUpdates:!1},i=>new xp(i));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as \u2026"]),e.view(s),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(i=>i.loadViewModel,()=>new Ls(t.loadViewModel)),e.p(Uo(e))])])}}class Dp extends v{render(e,t){return e.mapView(s=>s.activeSection,s=>{switch(s){case"error":return new St(i=>i.div({className:"StatusView"},[i.h1("Something went wrong"),i.p(t.errorText)]));case"session":return new Ip(t.sessionViewModel);case"login":return new Cp(t.loginViewModel);case"logout":return new Mp(t.logoutViewModel);case"picker":return new Np(t.sessionPickerViewModel);case"redirecting":return new St(i=>i.p("Redirecting..."));case"loading":return new Ap(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}}class Lp{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,s)=>{this._reject=s,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new ye),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class Op{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class Up{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class Pp{createMeasure(){return new Up}createTimeout(e){return new Lp(e)}createInterval(e,t){return new Op(t,e)}now(){return Date.now()}}class Vp{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,s=t.replyTo;if(s){const i=this._waitingForReply.get(s);i&&(this._waitingForReply.delete(s),i(t.payload))}if(t.type==="hasSessionOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:i})}else if(t.type==="hasRoomOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId,n=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:i&&n})}else if(t.type==="closeSession"){const{sessionId:i}=t.payload;this._closeSessionIfNeeded(i).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){var s;const t=(s=this._navigation)==null?void 0:s.path.get("session");return e&&(t==null?void 0:t.value)===e?new Promise(i=>{const n=this._navigation.pathObservable.subscribe(o=>{const a=o.get("session");(!a||a.value!==e)&&(n(),i())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),s.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),this._messageIdCounter+=1;const i=this._messageIdCounter,n=new Promise(o=>{this._waitingForReply.set(i,o)});return s.postMessage({type:e,id:i,payload:t}),await n}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.2.33"}get buildHash(){return "3190035768"}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class Bp{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){var i;const s=await((i=this._serviceWorkerHandler)==null?void 0:i.getRegistration());if(s!=null&&s.pushManager){const o=(await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),a=o.keys.p256dh,c={endpoint:o.endpoint,auth:o.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,a,c)}}async disablePush(){var t;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());if(e!=null&&e.pushManager){const s=await e.pushManager.getSubscription();s&&await s.unsubscribe()}}async isPushEnabled(){var t;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());return e!=null&&e.pushManager?!!await e.pushManager.getSubscription():!1}async supportsPush(){var t;if(!this._pushConfig)return!1;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());return e&&"pushManager"in e}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){var i;if("Notification"in window){new Notification(e,{body:t});return}const s=await((i=this._serviceWorkerHandler)==null?void 0:i.getRegistration());s==null||s.showNotification(e,{body:t})}}class Fp extends It{handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){var t;(t=window.localStorage)==null||t.setItem("hydrogen_last_url_hash",e)}getLastUrl(){var e;return(e=window.localStorage)==null?void 0:e.getItem("hydrogen_last_url_hash")}}class Kp extends It{constructor(){super(),this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function Q(r,e){return r instanceof Promise?r:new Promise((t,s)=>{r.oncomplete=i=>t(i.target.result),r.onerror=()=>s(new Error("Crypto error on "+e))})}class $p{constructor(e){this._subtleCrypto=e}async verify(e,t,s,i){const n={name:"HMAC",hash:{name:at(i)}},o=await Q(this._subtleCrypto.importKey("raw",e,n,!1,["verify"]),"importKey");return await Q(this._subtleCrypto.verify(n,o,t,s),"verify")}async compute(e,t,s){const i={name:"HMAC",hash:{name:at(s)}},n=await Q(this._subtleCrypto.importKey("raw",e,i,!1,["sign"]),"importKey"),o=await Q(this._subtleCrypto.sign(i,n,t),"sign");return new Uint8Array(o)}}class qp{constructor(e,t,s){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=s}async pbkdf2(e,t,s,i,n){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const o=await Q(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await Q(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:s,iterations:t,hash:at(i)},o,n),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,s,i,n){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,s,i,n);const o=await Q(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await Q(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:s,hash:at(i)},o,n),"deriveBits");return new Uint8Array(a)}}class jp{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:n=64}){const o={name:"AES-CTR",counter:s,length:n};let a;try{const c=e||t,l=t?"jwk":"raw";a=await Q(this._subtleCrypto.importKey(l,c,o,!1,["decrypt"]),"importKey")}catch(c){throw new Error(`Could not import key for AES-CTR decryption: ${c.message}`)}try{const c=await Q(this._subtleCrypto.decrypt(o,a,i),"decrypt");return new Uint8Array(c)}catch(c){throw new Error(`Could not decrypt with AES-CTR: ${c.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){const n={name:"AES-CTR",counter:s,length:64};let o;const a=e||t,c=t?"jwk":"raw";try{o=await Q(this._subtleCrypto.importKey(c,a,n,!1,["encrypt"]),"importKey")}catch(l){throw new Error(`Could not import key for AES-CTR encryption: ${l.message}`)}try{const l=await Q(this._subtleCrypto.encrypt(n,o,i),"encrypt");return new Uint8Array(l)}catch(l){throw new Error(`Could not encrypt with AES-CTR: ${l.message}`)}}async generateKey(e,t=256){const s=await Q(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return Q(this._subtleCrypto.exportKey(e,s))}async generateIV(){return Po(this._crypto)}}function Po(r){const e=r.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let s=0;s<e.length;s+=1)t[s]=e[s];return t}function ln(r){if(r.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${r.alg}`);if(!r.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(r.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${r.kty}`);const t=r.k.replace(/-/g,"+").replace(/_/g,"/");return rt.decode(t)}function Wp(r){const e=rt.encode(r),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function Hp(r){return Wp(r).replace(/\+/g,"-").replace(/\//g,"_")}function zp(r){return{alg:"A256CTR",ext:!0,k:Hp(r),key_ops:["encrypt","decrypt"],kty:"oct"}}class Gp{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:n=64}){if(n!==64)throw new Error(`Unsupported counter length: ${n}`);t&&(e=ln(t));const o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(s)));return a.decrypt(new Uint8Array(i))}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){t&&(e=ln(t));const n=this._aesjs;var o=new n.ModeOfOperation.ctr(new Uint8Array(e),new n.Counter(new Uint8Array(s)));return o.encrypt(new Uint8Array(i))}async generateKey(e,t=256){let s=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(s=zp(s)),s}async generateIV(){return Po(this._crypto)}}function at(r){if(r!=="SHA-256"&&r!=="SHA-512")throw new Error(`Invalid hash name: ${r}`);return r}class Jp{constructor(e){const t=window.crypto||window.msCrypto,s=t.subtle||t.webkitSubtle;this._subtleCrypto=s,!s.deriveBits&&(e==null?void 0:e.aesjs)?this.aes=new Gp(e.aesjs,t):this.aes=new jp(s,t),this.hmac=new $p(s),this.derive=new qp(s,this,e)}async digest(e,t){return await Q(this._subtleCrypto.digest(at(e),t))}digestSize(e){switch(at(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${at(e)}`)}}}async function Qp(){var r;if((r=navigator==null?void 0:navigator.storage)!=null&&r.estimate){const{quota:e,usage:t}=await navigator.storage.estimate();return{quota:e,usage:t}}else return{quota:null,usage:null}}class Yp{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class Xp{constructor(e,t){this._promise=new Promise((s,i)=>{this._resolve=s,this._reject=i}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class Zp{constructor(e,t){this._workers=[];for(let s=0;s<t;++s){const i=new Yp(new Worker(e));i.attach(this),this._workers[s]=i}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise((t,s)=>{this._init={resolve:t,reject:s}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){const t=e.data,s=this._requests.get(t.replyToId);if(s){if(s._worker.busy=!1,s._isNotDisposed){if(t.type==="success")s._resolve(t.payload);else if(t.type==="error"){const i=new Error(t.message);i.stack=t.stack,s._reject(i)}s._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;const t=this._getPendingRequest();if(t){const s=this._getFreeWorker();s&&(this._sendWith(t,s),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new Xp(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),s=this._getFreeWorker();return s&&this._sendWith(t,s),t}sendAll(e){const t=this._workers.map(s=>{const i=this._enqueueRequest(Object.assign({},e));return this._sendWith(i,s),i.response()});return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new ye),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}class Yt{static async fromBlob(e){const t=await hn(e),{width:s,height:i}=t;return new Yt(e,s,i,t)}constructor(e,t,s,i){this.blob=e,this.width=t,this.height=s,this._domElement=i}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await hn(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,s=Math.min(1,e/(t>=1?this.width:this.height)),i=Math.round(this.width*s),n=Math.round(this.height*s),o=document.createElement("canvas");o.width=i,o.height=n;const a=o.getContext("2d"),c=await this._getDomElement();a.drawImage(c,0,0,i,n);let l=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",h;if(o.toBlob)h=await new Promise(m=>o.toBlob(m,l));else if(o.msToBlob)l="image/png",h=o.msToBlob();else throw new Error("canvas can't be turned into blob");const d=ct.fromBlob(h);return new Yt(d,i,n,null)}dispose(){this.blob.dispose()}}class ji extends Yt{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){const t=await t_(e),{videoWidth:s,videoHeight:i}=t;return new ji(e,s,i,t)}}function e_(){const r=document.createElement("canvas");r.width=1,r.height=1;const e=r.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);const s=e.getImageData(0,0,1,1).data;return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]}async function hn(r){const e=document.createElement("img"),t=As(e,"load");return e.src=r.url,await t,e}async function t_(r){const e=document.createElement("video");e.muted=!0;const t=As(e,"loadedmetadata");e.src=r.url,e.load(),await t;const s=As(e,"seeked");return await new Promise(i=>setTimeout(i,200)),e.currentTime=.1,await s,e}async function s_(r,e,t,s,i){let n=r.querySelector("iframe.downloadSandbox");if(!n){n=document.createElement("iframe"),n.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),n.setAttribute("src",e),n.className="hidden downloadSandbox",r.appendChild(n);let o;await new Promise((a,c)=>{o=()=>{n.removeEventListener("load",a),n.removeEventListener("error",c)},n.addEventListener("load",a),n.addEventListener("error",c)}),o()}if(i){const o=await t.readAsBuffer();n.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:s},"*")}else n.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:s},"*")}/*! @license DOMPurify 2.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.3.0/LICENSE */function i_(r){if(Array.isArray(r)){for(var e=0,t=Array(r.length);e<r.length;e++)t[e]=r[e];return t}else return Array.from(r)}var r_=Object.hasOwnProperty,dn=Object.setPrototypeOf,n_=Object.isFrozen,o_=Object.getPrototypeOf,a_=Object.getOwnPropertyDescriptor,X=Object.freeze,xe=Object.seal,c_=Object.create,Vo=typeof Reflect!="undefined"&&Reflect,xs=Vo.apply,yi=Vo.construct;xs||(xs=function(e,t,s){return e.apply(t,s)});X||(X=function(e){return e});xe||(xe=function(e){return e});yi||(yi=function(e,t){return new(Function.prototype.bind.apply(e,[null].concat(i_(t))))});var l_=le(Array.prototype.forEach),un=le(Array.prototype.pop),Ot=le(Array.prototype.push),Ze=le(String.prototype.toLowerCase),mn=le(String.prototype.match),Ke=le(String.prototype.replace),h_=le(String.prototype.indexOf),d_=le(String.prototype.trim),$e=le(RegExp.prototype.test),pn=u_(TypeError);function le(r){return function(e){for(var t=arguments.length,s=Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];return xs(r,e,s)}}function u_(r){return function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return yi(r,t)}}function I(r,e){dn&&dn(r,null);for(var t=e.length;t--;){var s=e[t];if(typeof s=="string"){var i=Ze(s);i!==s&&(n_(e)||(e[t]=i),s=i)}r[s]=!0}return r}function gt(r){var e=c_(null),t=void 0;for(t in r)xs(r_,r,[t])&&(e[t]=r[t]);return e}function ws(r,e){for(;r!==null;){var t=a_(r,e);if(t){if(t.get)return le(t.get);if(typeof t.value=="function")return le(t.value)}r=o_(r)}function s(i){return console.warn("fallback value for",i),null}return s}var _n=X(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),ei=X(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),ti=X(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),m_=X(["animate","color-profile","cursor","discard","fedropshadow","feimage","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),si=X(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),p_=X(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),gn=X(["#text"]),fn=X(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),ii=X(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),yn=X(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),vs=X(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),__=xe(/\{\{[\s\S]*|[\s\S]*\}\}/gm),g_=xe(/<%[\s\S]*|[\s\S]*%>/gm),f_=xe(/^data-[\-\w.\u00B7-\uFFFF]/),y_=xe(/^aria-[\-\w]+$/),w_=xe(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),v_=xe(/^(?:\w+script|data):/i),b_=xe(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Bt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};function pe(r){if(Array.isArray(r)){for(var e=0,t=Array(r.length);e<r.length;e++)t[e]=r[e];return t}else return Array.from(r)}var S_=function(){return typeof window=="undefined"?null:window},I_=function(e,t){if((typeof e=="undefined"?"undefined":Bt(e))!=="object"||typeof e.createPolicy!="function")return null;var s=null,i="data-tt-policy-suffix";t.currentScript&&t.currentScript.hasAttribute(i)&&(s=t.currentScript.getAttribute(i));var n="dompurify"+(s?"#"+s:"");try{return e.createPolicy(n,{createHTML:function(a){return a}})}catch{return console.warn("TrustedTypes policy "+n+" could not be created."),null}};function Bo(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:S_(),e=function(u){return Bo(u)};if(e.version="2.3.0",e.removed=[],!r||!r.document||r.document.nodeType!==9)return e.isSupported=!1,e;var t=r.document,s=r.document,i=r.DocumentFragment,n=r.HTMLTemplateElement,o=r.Node,a=r.Element,c=r.NodeFilter,l=r.NamedNodeMap,h=l===void 0?r.NamedNodeMap||r.MozNamedAttrMap:l,d=r.Text,m=r.Comment,p=r.DOMParser,_=r.trustedTypes,g=a.prototype,b=ws(g,"cloneNode"),S=ws(g,"nextSibling"),T=ws(g,"childNodes"),P=ws(g,"parentNode");if(typeof n=="function"){var D=s.createElement("template");D.content&&D.content.ownerDocument&&(s=D.content.ownerDocument)}var V=I_(_,t),Z=V&&is?V.createHTML(""):"",G=s,Ue=G.implementation,Ko=G.createNodeIterator,$o=G.createDocumentFragment,qo=G.getElementsByTagName,jo=t.importNode,Wi={};try{Wi=gt(s).documentMode?s.documentMode:{}}catch{}var ue={};e.isSupported=typeof P=="function"&&Ue&&typeof Ue.createHTMLDocument!="undefined"&&Wi!==9;var Os=__,Us=g_,Wo=f_,Ho=y_,zo=v_,Hi=b_,Ps=w_,K=null,zi=I({},[].concat(pe(_n),pe(ei),pe(ti),pe(si),pe(gn))),$=null,Gi=I({},[].concat(pe(fn),pe(ii),pe(yn),pe(vs))),Vs=null,Bs=null,Ji=!0,Fs=!0,Qi=!1,ht=!1,dt=!1,Ks=!1,$s=!1,ut=!1,ss=!1,Yi=!0,is=!1,Xi=!0,qs=!0,Ct=!1,mt={},Go=I({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),Zi=null,er=I({},["audio","video","img","source","image","track"]),js=null,tr=I({},["alt","class","for","id","label","name","pattern","placeholder","summary","title","value","style","xmlns"]),Ws="http://www.w3.org/1998/Math/MathML",Hs="http://www.w3.org/2000/svg",Pe="http://www.w3.org/1999/xhtml",rs=Pe,zs=!1,pt=null,Jo=s.createElement("form"),Gs=function(u){pt&&pt===u||((!u||(typeof u=="undefined"?"undefined":Bt(u))!=="object")&&(u={}),u=gt(u),K="ALLOWED_TAGS"in u?I({},u.ALLOWED_TAGS):zi,$="ALLOWED_ATTR"in u?I({},u.ALLOWED_ATTR):Gi,js="ADD_URI_SAFE_ATTR"in u?I(gt(tr),u.ADD_URI_SAFE_ATTR):tr,Zi="ADD_DATA_URI_TAGS"in u?I(gt(er),u.ADD_DATA_URI_TAGS):er,Vs="FORBID_TAGS"in u?I({},u.FORBID_TAGS):{},Bs="FORBID_ATTR"in u?I({},u.FORBID_ATTR):{},mt="USE_PROFILES"in u?u.USE_PROFILES:!1,Ji=u.ALLOW_ARIA_ATTR!==!1,Fs=u.ALLOW_DATA_ATTR!==!1,Qi=u.ALLOW_UNKNOWN_PROTOCOLS||!1,ht=u.SAFE_FOR_TEMPLATES||!1,dt=u.WHOLE_DOCUMENT||!1,ut=u.RETURN_DOM||!1,ss=u.RETURN_DOM_FRAGMENT||!1,Yi=u.RETURN_DOM_IMPORT!==!1,is=u.RETURN_TRUSTED_TYPE||!1,$s=u.FORCE_BODY||!1,Xi=u.SANITIZE_DOM!==!1,qs=u.KEEP_CONTENT!==!1,Ct=u.IN_PLACE||!1,Ps=u.ALLOWED_URI_REGEXP||Ps,rs=u.NAMESPACE||Pe,ht&&(Fs=!1),ss&&(ut=!0),mt&&(K=I({},[].concat(pe(gn))),$=[],mt.html===!0&&(I(K,_n),I($,fn)),mt.svg===!0&&(I(K,ei),I($,ii),I($,vs)),mt.svgFilters===!0&&(I(K,ti),I($,ii),I($,vs)),mt.mathMl===!0&&(I(K,si),I($,yn),I($,vs))),u.ADD_TAGS&&(K===zi&&(K=gt(K)),I(K,u.ADD_TAGS)),u.ADD_ATTR&&($===Gi&&($=gt($)),I($,u.ADD_ATTR)),u.ADD_URI_SAFE_ATTR&&I(js,u.ADD_URI_SAFE_ATTR),qs&&(K["#text"]=!0),dt&&I(K,["html","head","body"]),K.table&&(I(K,["tbody"]),delete Vs.tbody),X&&X(u),pt=u)},sr=I({},["mi","mo","mn","ms","mtext"]),ir=I({},["foreignobject","desc","title","annotation-xml"]),ns=I({},ei);I(ns,ti),I(ns,m_);var Js=I({},si);I(Js,p_);var Qo=function(u){var f=P(u);(!f||!f.tagName)&&(f={namespaceURI:Pe,tagName:"template"});var y=Ze(u.tagName),C=Ze(f.tagName);if(u.namespaceURI===Hs)return f.namespaceURI===Pe?y==="svg":f.namespaceURI===Ws?y==="svg"&&(C==="annotation-xml"||sr[C]):Boolean(ns[y]);if(u.namespaceURI===Ws)return f.namespaceURI===Pe?y==="math":f.namespaceURI===Hs?y==="math"&&ir[C]:Boolean(Js[y]);if(u.namespaceURI===Pe){if(f.namespaceURI===Hs&&!ir[C]||f.namespaceURI===Ws&&!sr[C])return!1;var q=I({},["title","style","font","a","script"]);return!Js[y]&&(q[y]||!ns[y])}return!1},Ve=function(u){Ot(e.removed,{element:u});try{u.parentNode.removeChild(u)}catch{try{u.outerHTML=Z}catch{u.remove()}}},rr=function(u,f){try{Ot(e.removed,{attribute:f.getAttributeNode(u),from:f})}catch{Ot(e.removed,{attribute:null,from:f})}if(f.removeAttribute(u),u==="is"&&!$[u])if(ut||ss)try{Ve(f)}catch{}else try{f.setAttribute(u,"")}catch{}},nr=function(u){var f=void 0,y=void 0;if($s)u="<remove></remove>"+u;else{var C=mn(u,/^[\r\n\t ]+/);y=C&&C[0]}var q=V?V.createHTML(u):u;if(rs===Pe)try{f=new p().parseFromString(q,"text/html")}catch{}if(!f||!f.documentElement){f=Ue.createDocument(rs,"template",null);try{f.documentElement.innerHTML=zs?"":q}catch{}}var j=f.body||f.documentElement;return u&&y&&j.insertBefore(s.createTextNode(y),j.childNodes[0]||null),rs===Pe?qo.call(f,dt?"html":"body")[0]:dt?f.documentElement:j},or=function(u){return Ko.call(u.ownerDocument||u,u,c.SHOW_ELEMENT|c.SHOW_COMMENT|c.SHOW_TEXT,null,!1)},Yo=function(u){return u instanceof d||u instanceof m?!1:typeof u.nodeName!="string"||typeof u.textContent!="string"||typeof u.removeChild!="function"||!(u.attributes instanceof h)||typeof u.removeAttribute!="function"||typeof u.setAttribute!="function"||typeof u.namespaceURI!="string"||typeof u.insertBefore!="function"},Tt=function(u){return(typeof o=="undefined"?"undefined":Bt(o))==="object"?u instanceof o:u&&(typeof u=="undefined"?"undefined":Bt(u))==="object"&&typeof u.nodeType=="number"&&typeof u.nodeName=="string"},Se=function(u,f,y){!ue[u]||l_(ue[u],function(C){C.call(e,f,y,pt)})},ar=function(u){var f=void 0;if(Se("beforeSanitizeElements",u,null),Yo(u)||mn(u.nodeName,/[\u0080-\uFFFF]/))return Ve(u),!0;var y=Ze(u.nodeName);if(Se("uponSanitizeElement",u,{tagName:y,allowedTags:K}),!Tt(u.firstElementChild)&&(!Tt(u.content)||!Tt(u.content.firstElementChild))&&$e(/<[/\w]/g,u.innerHTML)&&$e(/<[/\w]/g,u.textContent))return Ve(u),!0;if(!K[y]||Vs[y]){if(qs&&!Go[y]){var C=P(u)||u.parentNode,q=T(u)||u.childNodes;if(q&&C)for(var j=q.length,W=j-1;W>=0;--W)C.insertBefore(b(q[W],!0),S(u))}return Ve(u),!0}return u instanceof a&&!Qo(u)||(y==="noscript"||y==="noembed")&&$e(/<\/no(script|embed)/i,u.innerHTML)?(Ve(u),!0):(ht&&u.nodeType===3&&(f=u.textContent,f=Ke(f,Os," "),f=Ke(f,Us," "),u.textContent!==f&&(Ot(e.removed,{element:u.cloneNode()}),u.textContent=f)),Se("afterSanitizeElements",u,null),!1)},cr=function(u,f,y){if(Xi&&(f==="id"||f==="name")&&(y in s||y in Jo))return!1;if(!(Fs&&!Bs[f]&&$e(Wo,f))){if(!(Ji&&$e(Ho,f))){if(!$[f]||Bs[f])return!1;if(!js[f]){if(!$e(Ps,Ke(y,Hi,""))){if(!((f==="src"||f==="xlink:href"||f==="href")&&u!=="script"&&h_(y,"data:")===0&&Zi[u])){if(!(Qi&&!$e(zo,Ke(y,Hi,"")))){if(y)return!1}}}}}}return!0},lr=function(u){var f=void 0,y=void 0,C=void 0,q=void 0;Se("beforeSanitizeAttributes",u,null);var j=u.attributes;if(!!j){var W={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:$};for(q=j.length;q--;){f=j[q];var Ie=f,Mt=Ie.name,hr=Ie.namespaceURI;if(y=d_(f.value),C=Ze(Mt),W.attrName=C,W.attrValue=y,W.keepAttr=!0,W.forceKeepAttr=void 0,Se("uponSanitizeAttribute",u,W),y=W.attrValue,!W.forceKeepAttr&&(rr(Mt,u),!!W.keepAttr)){if($e(/\/>/i,y)){rr(Mt,u);continue}ht&&(y=Ke(y,Os," "),y=Ke(y,Us," "));var Zo=u.nodeName.toLowerCase();if(!!cr(Zo,C,y))try{hr?u.setAttributeNS(hr,Mt,y):u.setAttribute(Mt,y),un(e.removed)}catch{}}}Se("afterSanitizeAttributes",u,null)}},Xo=function w(u){var f=void 0,y=or(u);for(Se("beforeSanitizeShadowDOM",u,null);f=y.nextNode();)Se("uponSanitizeShadowNode",f,null),!ar(f)&&(f.content instanceof i&&w(f.content),lr(f));Se("afterSanitizeShadowDOM",u,null)};return e.sanitize=function(w,u){var f=void 0,y=void 0,C=void 0,q=void 0,j=void 0;if(zs=!w,zs&&(w="<!-->"),typeof w!="string"&&!Tt(w)){if(typeof w.toString!="function")throw pn("toString is not a function");if(w=w.toString(),typeof w!="string")throw pn("dirty is not a string, aborting")}if(!e.isSupported){if(Bt(r.toStaticHTML)==="object"||typeof r.toStaticHTML=="function"){if(typeof w=="string")return r.toStaticHTML(w);if(Tt(w))return r.toStaticHTML(w.outerHTML)}return w}if(Ks||Gs(u),e.removed=[],typeof w=="string"&&(Ct=!1),!Ct)if(w instanceof o)f=nr("<!---->"),y=f.ownerDocument.importNode(w,!0),y.nodeType===1&&y.nodeName==="BODY"||y.nodeName==="HTML"?f=y:f.appendChild(y);else{if(!ut&&!ht&&!dt&&w.indexOf("<")===-1)return V&&is?V.createHTML(w):w;if(f=nr(w),!f)return ut?null:Z}f&&$s&&Ve(f.firstChild);for(var W=or(Ct?w:f);C=W.nextNode();)C.nodeType===3&&C===q||ar(C)||(C.content instanceof i&&Xo(C.content),lr(C),q=C);if(q=null,Ct)return w;if(ut){if(ss)for(j=$o.call(f.ownerDocument);f.firstChild;)j.appendChild(f.firstChild);else j=f;return Yi&&(j=jo.call(t,j,!0)),j}var Ie=dt?f.outerHTML:f.innerHTML;return ht&&(Ie=Ke(Ie,Os," "),Ie=Ke(Ie,Us," ")),V&&is?V.createHTML(Ie):Ie},e.setConfig=function(w){Gs(w),Ks=!0},e.clearConfig=function(){pt=null,Ks=!1},e.isValidAttribute=function(w,u,f){pt||Gs({});var y=Ze(w),C=Ze(u);return cr(y,C,f)},e.addHook=function(w,u){typeof u=="function"&&(ue[w]=ue[w]||[],Ot(ue[w],u))},e.removeHook=function(w){ue[w]&&un(ue[w])},e.removeHooks=function(w){ue[w]&&(ue[w]=[])},e.removeAllHooks=function(){ue={}},e}var E_=Bo();class k_{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const R_={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,FORBID_TAGS:["mx-reply"],KEEP_CONTENT:!1};function C_(r){const e=E_.sanitize(r,R_),t=new DOMParser().parseFromString(`<!DOCTYPE html><html><body>${e}</body></html>`,"text/html").body;return new k_(t)}class T_{constructor(e){this._platform=e}async init(e,t){await this._platform.logger.wrapOrRun(t,"ThemeLoader.init",async s=>{this._themeMapping={},(await Promise.all(e.map(n=>this._platform.request(n,{method:"GET",format:"json",cache:!0}).response()))).forEach(({body:n})=>this._populateThemeMap(n,s))})}_populateThemeMap(e,t){t.wrap("populateThemeMap",s=>{var l,h;const i=(l=e.source)==null?void 0:l["built-assets"],n=e.name;let o={},a={};for(const[d,m]of Object.entries(i)){const p=(h=d.match(/.+-(.+)/))==null?void 0:h[1],{name:_,default:g,dark:b}=e.values.variants[p],S=`${n} ${_}`;if(g){const T=b?o:a;T.variantName=_,T.id=d,T.cssLocation=m;continue}this._themeMapping[S]={cssLocation:m,id:d}}if(o.id&&a.id){const d=this.preferredColorScheme===0?o:a;this._themeMapping[n]={dark:o,light:a,default:d}}else{const d=o.id?o:a;this._themeMapping[`${n} ${d.variantName}`]={id:d.id,cssLocation:d.cssLocation}}const c=this.getDefaultTheme();if(c){const d=this._findThemeDetailsFromId(c);d&&(this._themeMapping.Default={id:"default",cssLocation:d.cssLocation})}s.log({l:"Default Theme",theme:c}),s.log({l:"Preferred colorscheme",scheme:this.preferredColorScheme===0?"dark":"light"}),s.log({l:"Result",themeMapping:this._themeMapping})})}setTheme(e,t,s){this._platform.logger.wrapOrRun(s,{l:"change theme",name:e,variant:t},()=>{let i,n=this._themeMapping[e];if("id"in n)i=n.cssLocation;else{if(!t)throw new Error("themeVariant is undefined!");i=n[t].cssLocation}this._platform.replaceStylesheet(i),this._platform.settingsStorage.setString("theme-name",e),t?this._platform.settingsStorage.setString("theme-variant",t):this._platform.settingsStorage.remove("theme-variant")})}get themeMapping(){return this._themeMapping}async getActiveTheme(){let e=await this._platform.settingsStorage.getString("theme-name"),t=await this._platform.settingsStorage.getString("theme-variant");return(!e||!this._themeMapping[e])&&(e="Default"in this._themeMapping?"Default":Object.keys(this._themeMapping)[0],this._themeMapping[e][t]||(t="default"in this._themeMapping[e]?"default":void 0)),{themeName:e,themeVariant:t}}getDefaultTheme(){var e,t;switch(this.preferredColorScheme){case 0:return(e=this._platform.config.defaultTheme)==null?void 0:e.dark;case 1:return(t=this._platform.config.defaultTheme)==null?void 0:t.light}}_findThemeDetailsFromId(e){var t,s;for(const[i,n]of Object.entries(this._themeMapping)){if("id"in n&&n.id===e)return{themeName:i,cssLocation:n.cssLocation};if("light"in n&&((t=n.light)==null?void 0:t.id)===e)return{themeName:i,cssLocation:n.light.cssLocation,variant:"light"};if("dark"in n&&((s=n.dark)==null?void 0:s.id)===e)return{themeName:i,cssLocation:n.dark.cssLocation,variant:"dark"}}}get preferredColorScheme(){if(window.matchMedia("(prefers-color-scheme: dark)").matches)return 0;if(window.matchMedia("(prefers-color-scheme: light)").matches)return 1}}function wn(r){return new Promise(function(e,t){var s=document.createElement("script");s.setAttribute("src",r),s.onload=e,s.onerror=t,document.body.appendChild(s)})}async function M_(r){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),r?(window.WebAssembly?(await wn(r.wasmBundle),await window.Olm.init({locateFile:()=>r.wasm})):(await wn(r.legacyBundle),await window.Olm.init()),window.Olm):null}function A_(r){return r.startsWith("/")?r:new URL(r,document.location.href).pathname}async function x_(r){const e=new Zp(r.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:A_(r.olm.legacyBundle)}),new lm(e)}function N_(r){if(!window.visualViewport)return;const e=()=>{const t=r.querySelector(".SessionView");if(!t)return;const s=r.querySelector(".bottom-aligned-scroll");let i,n,o;s&&(i=s.scrollTop,n=s.offsetHeight);const a=t.offsetTop+t.offsetHeight-window.visualViewport.height;r.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),r.style.setProperty("--ios-viewport-top",a.toString()+"px"),s&&(o=s.offsetHeight,s.scrollTop=i+n-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}class D_{constructor({container:e,assetPaths:t,config:s,configURL:i,options:n=null,cryptoExtras:o=null}){this._container=e,this._assetPaths=t,this._config=s,this._configURL=i,this.settingsStorage=new Xu("hydrogen_setting_v1_"),this.clock=new Pp,this.encoding=new cm,this.random=Math.random,this._createLogger(n==null?void 0:n.development),this.history=new Fp,this.onlineStatus=new Kp,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new Vp,this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=void 0,this._assetPaths.olm&&(this.crypto=new Jp(o)),this.storageFactory=new Yc(this._serviceWorkerHandler),this.sessionInfoStorage=new Yu("hydrogen_sessions_v1"),this.estimateStorageUsage=Qp,typeof fetch=="function"?this.request=Qu(this.clock.createTimeout,this._serviceWorkerHandler):this.request=fo;const a=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=a;const c=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=c,this._disposables=new Ti,this._olmPromise=void 0,this._workerPromise=void 0,this._themeLoader=new T_(this)}async init(){try{await this.logger.run("Platform init",async e=>{var t;if(!this._config){if(!this._configURL)throw new Error("Neither config nor configURL was provided!");const{status:s,body:i}=await this.request(this._configURL,{method:"GET",format:"json",cache:!0}).response();if(s===404)throw new Error(`Could not find ${this._configURL}. Did you copy over config.sample.json?`);if(s>=400)throw new Error(`Got status ${s} while trying to fetch ${this._configURL}`);this._config=i}if(this.notificationService=new Bp(this._serviceWorkerHandler,this._config.push),this._themeLoader){const s=this.config.themeManifests;await((t=this._themeLoader)==null?void 0:t.init(s,e));const{themeName:i,themeVariant:n}=await this._themeLoader.getActiveTheme();e.log({l:"Active theme",name:i,variant:n}),this._themeLoader.setTheme(i,n,e)}})}catch(e){throw this._container.innerText=e.message,e}}_createLogger(e){const t=s=>{var i;return(i=s.e)!=null&&i.stack&&(s.e.stack=s.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),s};e?this.logger=new um({platform:this}):this.logger=new hm({name:"hydrogen_logs",platform:this,serializedTransformer:t})}get updateService(){return this._serviceWorkerHandler}loadOlm(){return this._olmPromise||(this._olmPromise=M_(this._assetPaths.olm)),this._olmPromise}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return this._workerPromise||(this._workerPromise=x_(this._assetPaths)),this._workerPromise}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const s=N_(this._container);s&&this._disposables.track(s)}this._container.addEventListener("error",nn,!0),this._disposables.track(()=>this._container.removeEventListener("error",nn,!0)),window.__hydrogenViewModel=e;const t=new Dp(e);this._container.appendChild(t.mount())}setNavigation(e){var t;(t=this._serviceWorkerHandler)==null||t.setNavigation(e)}createBlob(e,t){return ct.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):s_(this._container,this._assetPaths.downloadSandbox,e,t,this.isIOS)}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const s=new Promise(i=>{const n=()=>{t.removeEventListener("change",n,!0);const o=t.files[0];this._container.removeChild(t),o?i({name:o.name,blob:ct.fromBlob(o)}):i()};t.addEventListener("change",n,!0)});return this._container.appendChild(t),t.click(),s}openUrl(e){location.href=e}parseHTML(e){return C_(e)}async loadImage(e){return Yt.fromBlob(e)}async loadVideo(e){return ji.fromBlob(e)}hasReadPixelPermission(){return e_()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.2.33"}get themeLoader(){return this._themeLoader}replaceStylesheet(e){const t=document.querySelector("head");document.querySelectorAll(".theme").forEach(i=>i.remove());const s=document.createElement("link");s.href=`./${e}`,s.rel="stylesheet",s.type="text/css",s.className="theme",t.appendChild(s)}get description(){var e;return(e=navigator.userAgent)!=null?e:"<unknown>"}dispose(){this._disposables.dispose()}}var L_="./config.json",O_="./assets/download-sandbox.48a866e9.html",U_="./assets/main.bdb9a925.js",P_="./assets/olm.531f328e.wasm",V_="./assets/olm.364714ee.js",B_="./assets/olm_legacy.658f14ac.js",Fo={downloadSandbox:O_,worker:U_,olm:{wasm:P_,legacyBundle:B_,wasmBundle:V_}};Fo.serviceWorker="sw.js";const F_=new D_({container:document.body,assetPaths:Fo,configURL:L_,options:{development:!1}});Wu(F_);
//# sourceMappingURL=index.1f05e6c4.js.map
